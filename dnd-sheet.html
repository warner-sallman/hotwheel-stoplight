<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8-Bit D&D Character Sheet</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 18px; /* Base size - increase this to make everything bigger */
        }

        body {
            min-height: 100vh;
            background: #2d1b0e;
            font-family: 'Press Start 2P', cursive;
            color: #f4e4bc;
            overflow-x: hidden;
        }

        /* ===== HEADER ===== */
        .header {
            background: #1a0f07;
            border-bottom: 4px solid #8b2500;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 0 #1a0f07;
        }

        .header h1 {
            color: #8b2500;
            font-size: 1rem;
            text-shadow: 3px 3px 0 #1a0f07;
        }

        .header h1 span {
            color: #daa520;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: #3d2817;
            border: 3px solid #8b4513;
            color: #f4e4bc;
            padding: 8px 12px;
            font-family: inherit;
            font-size: 0.5rem;
            cursor: pointer;
            box-shadow: 3px 3px 0 #1a0f07;
        }

        .header-btn:hover {
            background: #5c3317;
        }

        /* ===== MAIN LAYOUT ===== */
        .main-container {
            display: grid;
            grid-template-columns: 280px 1fr 300px;
            gap: 15px;
            padding: 15px;
            min-height: calc(100vh - 60px);
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        /* ===== PANELS ===== */
        .panel {
            background: #3d2817;
            border: 4px solid #8b4513;
            padding: 15px;
            box-shadow: 4px 4px 0 #1a0f07;
        }

        .panel-title {
            color: #daa520;
            font-size: 0.6rem;
            margin-bottom: 12px;
            text-shadow: 2px 2px 0 #1a0f07;
            border-bottom: 2px solid #5c3317;
            padding-bottom: 8px;
        }

        /* ===== CHARACTER INFO PANEL ===== */
        .char-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .char-name {
            color: #daa520;
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 5px;
        }

        .char-detail {
            display: flex;
            justify-content: space-between;
            font-size: 0.5rem;
            padding: 5px 0;
            border-bottom: 1px solid #5c3317;
        }

        .char-detail-label {
            color: #c4a574;
        }

        .char-detail-value {
            color: #f4e4bc;
        }

        /* ===== HP TRACKER ===== */
        .hp-tracker {
            background: #2d1b0e;
            border: 3px solid #8b4513;
            padding: 12px;
            margin-bottom: 15px;
        }

        .hp-bar-container {
            background: #1a0f07;
            border: 2px solid #5c3317;
            height: 30px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }

        .hp-bar {
            height: 100%;
            background: linear-gradient(to bottom, #2e7d32, #1b5e20);
            transition: width 0.3s ease;
            position: relative;
        }

        .hp-bar.damaged {
            background: linear-gradient(to bottom, #f9a825, #f57f17);
        }

        .hp-bar.critical {
            background: linear-gradient(to bottom, #c62828, #b71c1c);
            animation: pulse-critical 1s infinite;
        }

        @keyframes pulse-critical {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .hp-bar-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.6rem;
            color: #f4e4bc;
            text-shadow: 1px 1px 0 #000;
            z-index: 1;
        }

        .hp-controls {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .hp-btn {
            background: #f4e4bc;
            border: 3px solid #8b4513;
            color: #2d1b0e;
            padding: 8px 12px;
            font-family: inherit;
            font-size: 0.5rem;
            cursor: pointer;
            box-shadow: 2px 2px 0 #1a0f07;
        }

        .hp-btn:hover {
            background: #e8d4a8;
        }

        .hp-btn.damage {
            border-color: #8b2500;
            color: #8b2500;
        }

        .hp-btn.heal {
            border-color: #2e7d32;
            color: #2e7d32;
        }

        .hp-input {
            width: 60px;
            background: #f4e4bc;
            border: 3px solid #8b4513;
            color: #2d1b0e;
            padding: 8px;
            font-family: inherit;
            font-size: 0.5rem;
            text-align: center;
        }

        .temp-hp {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 0.5rem;
        }

        .temp-hp-input {
            width: 50px;
            background: #f4e4bc;
            border: 2px solid #1565c0;
            color: #2d1b0e;
            padding: 5px;
            font-family: inherit;
            font-size: 0.5rem;
            text-align: center;
        }

        /* ===== DEATH SAVES ===== */
        .death-saves {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #8b2500;
        }

        .death-saves.active {
            display: block;
        }

        .death-saves-title {
            color: #8b2500;
            font-size: 0.5rem;
            text-align: center;
            margin-bottom: 10px;
        }

        .death-saves-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 8px;
        }

        .death-save-label {
            font-size: 0.45rem;
            width: 70px;
        }

        .death-save-label.success {
            color: #81c784;
        }

        .death-save-label.failure {
            color: #e57373;
        }

        .death-save-boxes {
            display: flex;
            gap: 5px;
        }

        .death-save-box {
            width: 20px;
            height: 20px;
            background: #2d1b0e;
            border: 2px solid #5c3317;
            cursor: pointer;
        }

        .death-save-box.success.filled {
            background: #2e7d32;
            border-color: #81c784;
        }

        .death-save-box.failure.filled {
            background: #c62828;
            border-color: #e57373;
        }

        /* ===== ABILITY SCORES ===== */
        .abilities-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .ability-box {
            background: #f4e4bc;
            border: 3px solid #8b4513;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ability-box:hover {
            border-color: #8b2500;
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 #1a0f07;
        }

        .ability-name {
            color: #8b2500;
            font-size: 0.5rem;
            margin-bottom: 4px;
        }

        .ability-score {
            color: #2d1b0e;
            font-size: 1rem;
        }

        .ability-mod {
            color: #2e7d32;
            font-size: 0.6rem;
        }

        /* ===== SAVING THROWS ===== */
        .saves-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-top: 10px;
        }

        .save-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.45rem;
            padding: 6px;
            background: #2d1b0e;
            border: 2px solid #5c3317;
            cursor: pointer;
        }

        .save-item:hover {
            border-color: #8b2500;
        }

        .save-item.proficient {
            border-color: #2e7d32;
        }

        .save-prof {
            width: 10px;
            height: 10px;
            border: 2px solid #5c3317;
            border-radius: 50%;
        }

        .save-item.proficient .save-prof {
            background: #2e7d32;
            border-color: #81c784;
        }

        .save-mod {
            color: #81c784;
            margin-left: auto;
        }

        /* ===== SKILLS ===== */
        .skills-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 400px;
            overflow-y: auto;
        }

        .skill-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.45rem;
            padding: 6px 8px;
            background: #2d1b0e;
            border: 2px solid #5c3317;
            cursor: pointer;
            transition: all 0.2s;
        }

        .skill-item:hover {
            border-color: #8b2500;
            background: #3d2817;
        }

        .skill-item.proficient {
            border-color: #2e7d32;
        }

        .skill-item.expertise {
            border-color: #daa520;
        }

        .skill-prof {
            width: 10px;
            height: 10px;
            border: 2px solid #5c3317;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .skill-item.proficient .skill-prof {
            background: #2e7d32;
            border-color: #81c784;
        }

        .skill-item.expertise .skill-prof {
            background: #daa520;
            border-color: #ffd54f;
        }

        .skill-name {
            flex: 1;
        }

        .skill-ability {
            color: #8b7355;
            font-size: 0.4rem;
        }

        .skill-mod {
            color: #81c784;
            min-width: 25px;
            text-align: right;
        }

        /* ===== COMBAT STATS ===== */
        .combat-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .combat-stat {
            background: #2d1b0e;
            border: 3px solid #8b4513;
            padding: 10px;
            text-align: center;
        }

        .combat-stat-label {
            color: #c4a574;
            font-size: 0.4rem;
            margin-bottom: 5px;
        }

        .combat-stat-value {
            color: #daa520;
            font-size: 1rem;
        }

        /* ===== CONDITIONS ===== */
        .conditions-panel {
            margin-top: 15px;
        }

        .conditions-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .condition-tag {
            background: #2d1b0e;
            border: 2px solid #5c3317;
            padding: 5px 8px;
            font-size: 0.4rem;
            cursor: pointer;
            opacity: 0.5;
        }

        .condition-tag.active {
            opacity: 1;
            border-color: #8b2500;
            background: #5c2817;
        }

        .condition-tag:hover {
            opacity: 0.8;
        }

        /* ===== SPELL SLOTS ===== */
        .spell-slots-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .spell-slot-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .spell-slot-level {
            color: #c4a574;
            font-size: 0.45rem;
            min-width: 50px;
        }

        .spell-slot-pips {
            display: flex;
            gap: 5px;
        }

        .spell-slot-pip {
            width: 18px;
            height: 18px;
            background: #9370db;
            border: 2px solid #b19cd9;
            cursor: pointer;
            transition: all 0.2s;
        }

        .spell-slot-pip.used {
            background: #2d1b0e;
            border-color: #5c3317;
        }

        .spell-slot-pip:hover {
            transform: scale(1.1);
        }

        /* ===== SPELLS LIST ===== */
        .spells-section {
            margin-top: 15px;
        }

        .spell-level-group {
            margin-bottom: 10px;
        }

        .spell-level-title {
            color: #9370db;
            font-size: 0.45rem;
            margin-bottom: 5px;
            padding-bottom: 3px;
            border-bottom: 1px solid #5c3317;
        }

        .spell-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.4rem;
            padding: 5px;
            background: #2d1b0e;
            border: 2px solid #5c3317;
            margin-bottom: 3px;
            cursor: pointer;
            flex-wrap: wrap;
        }

        .spell-item:hover {
            border-color: #9370db;
            cursor: pointer;
        }

        .spell-item .spell-name {
            cursor: pointer;
        }

        .spell-item .spell-name:hover {
            color: #9370db;
            text-decoration: underline;
        }

        .spell-item.prepared {
            border-color: #2e7d32;
        }

        .spell-item.spell-granted {
            border-color: #b8860b;
            background: #3d2b1e;
        }

        .spell-item.spell-granted.prepared {
            border-color: #daa520;
        }

        .spell-name {
            flex: 1;
            min-width: 100px;
        }

        .spell-tags {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .spell-tag {
            padding: 2px 5px;
            font-size: 0.35rem;
            border-radius: 2px;
        }

        .spell-tag.ritual {
            background: #1565c0;
            color: #f4e4bc;
        }

        .spell-tag.concentration {
            background: #ff8f00;
            color: #1a0f07;
        }

        .spell-tag.duration {
            background: #5c3317;
            color: #c4a574;
        }

        .spell-tag.granted {
            background: #b8860b;
            color: #1a0f07;
        }

        /* Limited-use spells (feats, subclass abilities) */
        .spell-item.spell-limited {
            cursor: pointer;
            border-color: #9370db;
            background: #2d1b1e;
        }

        .spell-item.spell-limited:hover {
            border-color: #b19cd9;
        }

        .spell-item.spell-limited.used {
            opacity: 0.5;
            border-color: #5c3317;
        }

        .spell-use-pips {
            display: flex;
            gap: 3px;
            margin-right: 5px;
        }

        .spell-use-pip {
            width: 10px;
            height: 10px;
            border: 2px solid #9370db;
            border-radius: 50%;
            background: transparent;
        }

        .spell-use-pip.used {
            background: #9370db;
        }

        /* ===== FEATURES/ACTIONS ===== */
        .features-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .feature-item {
            background: #2d1b0e;
            border: 2px solid #5c3317;
            padding: 8px;
        }

        .feature-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .feature-name {
            color: #daa520;
            font-size: 0.45rem;
        }

        .feature-uses {
            display: flex;
            gap: 4px;
        }

        .feature-use-pip {
            width: 12px;
            height: 12px;
            background: #8b2500;
            border: 2px solid #cd5c5c;
            cursor: pointer;
        }

        .feature-use-pip.used {
            background: #2d1b0e;
            border-color: #5c3317;
        }

        .feature-desc {
            color: #c4a574;
            font-size: 0.4rem;
            line-height: 1.5;
        }

        .feature-recharge {
            background: #1565c0;
            color: #f4e4bc;
            padding: 2px 6px;
            font-size: 0.3rem;
            border-radius: 3px;
            margin-left: 8px;
        }

        .feature-pool {
            background: #2e7d32;
            color: #f4e4bc;
            padding: 2px 8px;
            font-size: 0.35rem;
            border-radius: 3px;
        }

        /* ===== REST BUTTONS ===== */
        .rest-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .rest-btn {
            flex: 1;
            background: #3d2817;
            border: 4px solid #8b4513;
            color: #f4e4bc;
            padding: 12px;
            font-family: inherit;
            font-size: 0.5rem;
            cursor: pointer;
            box-shadow: 3px 3px 0 #1a0f07;
            transition: all 0.2s;
        }

        .rest-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 5px 5px 0 #1a0f07;
        }

        .rest-btn.short {
            border-color: #1565c0;
        }

        .rest-btn.long {
            border-color: #6b5b95;
        }

        /* ===== XP TRACKER ===== */
        .xp-tracker {
            margin-top: 15px;
            padding: 10px;
            background: #2d1b0e;
            border: 2px solid #5c3317;
        }

        .xp-bar-container {
            background: #1a0f07;
            height: 15px;
            border: 2px solid #5c3317;
            margin: 8px 0;
        }

        .xp-bar {
            height: 100%;
            background: linear-gradient(to right, #daa520, #ffd54f);
            transition: width 0.3s ease;
        }

        .xp-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.4rem;
            color: #c4a574;
        }

        /* ===== DICE ROLLER MODAL ===== */
        .dice-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .dice-modal.active {
            display: flex;
        }

        .dice-modal-content {
            background: #3d2817;
            border: 6px solid #8b4513;
            padding: 30px;
            text-align: center;
            box-shadow: 8px 8px 0 #1a0f07;
            min-width: 300px;
        }

        .dice-modal-title {
            color: #daa520;
            font-size: 0.7rem;
            margin-bottom: 20px;
        }

        .dice-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            min-height: 80px;
        }

        .die {
            width: 60px;
            height: 60px;
            background: #f4e4bc;
            border: 4px solid #8b4513;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #2d1b0e;
            box-shadow: 4px 4px 0 #1a0f07;
        }

        .die.rolling {
            animation: diceRoll 0.1s infinite;
        }

        .die.advantage {
            border-color: #2e7d32;
        }

        .die.disadvantage {
            border-color: #c62828;
        }

        .die.dropped {
            opacity: 0.4;
        }

        @keyframes diceRoll {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.1); }
            50% { transform: rotate(180deg) scale(1); }
            75% { transform: rotate(270deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }

        .dice-result {
            margin-bottom: 15px;
        }

        .dice-result-total {
            font-size: 2rem;
            color: #daa520;
            margin-bottom: 5px;
        }

        .dice-result-breakdown {
            font-size: 0.5rem;
            color: #c4a574;
        }

        .dice-result-type {
            font-size: 0.6rem;
            color: #81c784;
            margin-top: 5px;
        }

        .dice-result-type.crit {
            color: #ffd54f;
            animation: pulse 0.5s infinite;
        }

        .dice-result-type.fumble {
            color: #e57373;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .dice-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .dice-btn {
            background: #f4e4bc;
            border: 3px solid #8b4513;
            color: #2d1b0e;
            padding: 10px 20px;
            font-family: inherit;
            font-size: 0.5rem;
            cursor: pointer;
        }

        .dice-btn:hover {
            background: #e8d4a8;
        }

        .dice-btn.adv {
            border-color: #2e7d32;
            color: #2e7d32;
        }

        .dice-btn.dis {
            border-color: #c62828;
            color: #c62828;
        }

        /* ===== ADVANTAGE/DISADVANTAGE TOGGLE ===== */
        .roll-mode-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .roll-mode-btn {
            background: #2d1b0e;
            border: 2px solid #5c3317;
            color: #c4a574;
            padding: 8px 15px;
            font-family: inherit;
            font-size: 0.45rem;
            cursor: pointer;
        }

        .roll-mode-btn.active {
            border-color: #daa520;
            color: #daa520;
        }

        .roll-mode-btn.advantage.active {
            border-color: #2e7d32;
            color: #81c784;
        }

        .roll-mode-btn.disadvantage.active {
            border-color: #c62828;
            color: #e57373;
        }

        /* ===== SPELL PREPARATION MODAL ===== */
        .prep-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .prep-modal.active {
            display: flex;
        }

        .prep-modal-content {
            background: #3d2817;
            border: 6px solid #9370db;
            padding: 25px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 8px 8px 0 #1a0f07;
        }

        .prep-modal-title {
            color: #9370db;
            font-size: 0.7rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .prep-modal-subtitle {
            color: #c4a574;
            font-size: 0.45rem;
            text-align: center;
            margin-bottom: 20px;
        }

        .prep-spell-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 8px;
            margin-bottom: 20px;
        }

        .prep-spell-item {
            background: #2d1b0e;
            border: 2px solid #5c3317;
            padding: 8px;
            font-size: 0.4rem;
            cursor: pointer;
        }

        .prep-spell-item:hover {
            border-color: #9370db;
        }

        .prep-spell-item.selected {
            border-color: #2e7d32;
            background: #1e4620;
        }

        .prep-spell-item.always {
            border-color: #daa520;
            opacity: 0.7;
            cursor: default;
        }

        .prep-spell-item.granted {
            border-color: #b8860b;
            background: #3d2b1e;
            cursor: default;
            opacity: 0.8;
        }

        .prep-spell-item.scroll-spell:hover {
            border-color: #9c27b0;
            background: #4a1a5e;
        }

        .prep-level-group {
            margin-bottom: 15px;
        }

        .prep-level-title {
            font-size: 0.4rem;
            color: #b8860b;
            margin-bottom: 8px;
            font-weight: bold;
            border-bottom: 1px solid #5c3317;
            padding-bottom: 4px;
        }

        .prep-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .prep-btn {
            background: #9370db;
            border: 3px solid #b19cd9;
            color: #f4e4bc;
            padding: 10px 25px;
            font-family: inherit;
            font-size: 0.5rem;
            cursor: pointer;
        }

        .prep-btn:hover {
            background: #b19cd9;
        }

        .prep-btn.skip {
            background: #5c3317;
            border-color: #8b4513;
        }

        /* ===== SPELL INFO MODAL ===== */
        .spell-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1002;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .spell-modal.active {
            display: flex;
        }

        .spell-modal-content {
            background: #3d2817;
            border: 6px solid #9370db;
            padding: 25px;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 8px 8px 0 #1a0f07;
            width: 100%;
        }

        .spell-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #5c3317;
            padding-bottom: 10px;
        }

        .spell-modal-title {
            color: #9370db;
            font-size: 0.8rem;
        }

        .spell-modal-close {
            background: #8b2500;
            border: 2px solid #cd5c5c;
            color: #f4e4bc;
            font-size: 0.7rem;
            width: 35px;
            height: 35px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spell-modal-close:hover {
            background: #cd5c5c;
        }

        .spell-modal-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .spell-meta-item {
            background: #2d1b0e;
            border: 1px solid #5c3317;
            padding: 6px 10px;
            font-size: 0.5rem;
            color: #c4a574;
        }

        .spell-meta-label {
            color: #8b7355;
        }

        .spell-modal-desc {
            color: #f4e4bc;
            font-size: 0.55rem;
            line-height: 1.8;
            margin-bottom: 15px;
        }

        .spell-modal-footer {
            color: #b8860b;
            font-size: 0.5rem;
            font-style: italic;
            border-top: 1px solid #5c3317;
            padding-top: 10px;
        }

        /* ===== INVENTORY ===== */
        .inventory-section {
            margin-top: 15px;
        }

        .currency-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .currency-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.45rem;
        }

        .currency-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.4rem;
        }

        .currency-icon.gp { background: #daa520; color: #1a0f07; }
        .currency-icon.sp { background: #c0c0c0; color: #1a0f07; }
        .currency-icon.cp { background: #b87333; color: #1a0f07; }
        .currency-icon.ep { background: #e5e4e2; color: #1a0f07; }
        .currency-icon.pp { background: #e5e4e2; color: #1a0f07; }

        .currency-input {
            width: 50px;
            background: #f4e4bc;
            border: 2px solid #8b4513;
            color: #2d1b0e;
            padding: 4px;
            font-family: inherit;
            font-size: 0.45rem;
            text-align: center;
        }

        .equipment-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .equipment-item {
            font-size: 0.4rem;
            padding: 5px;
            background: #2d1b0e;
            border: 1px solid #5c3317;
        }

        .inventory-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #2d1b0e;
            border: 2px solid #5c3317;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .inventory-item:hover {
            border-color: #8b4513;
            background: #3d2817;
        }

        .inventory-item.equipped {
            border-color: #daa520;
            background: #3d2817;
        }

        .inventory-item.magic {
            border-color: #9370db;
        }

        .inventory-item-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.5rem;
            background: #1a0f07;
            border: 1px solid #5c3317;
        }

        .inventory-item-icon.weapon { color: #cd5c5c; }
        .inventory-item-icon.armor { color: #4682b4; }
        .inventory-item-icon.potion { color: #32cd32; }
        .inventory-item-icon.scroll { color: #daa520; }
        .inventory-item-icon.wondrous { color: #9370db; }
        .inventory-item-icon.gear { color: #8b7355; }
        .inventory-item-icon.ammo { color: #cd853f; }
        .inventory-item-icon.shield { color: #4682b4; }
        .inventory-item-icon.custom { color: #ff69b4; }

        .inventory-item-info {
            flex: 1;
        }

        .inventory-item-name {
            font-size: 0.4rem;
            color: #f4e4bc;
        }

        .inventory-item-type {
            font-size: 0.3rem;
            color: #8b7355;
        }

        .inventory-item-qty {
            font-size: 0.35rem;
            color: #daa520;
            min-width: 25px;
            text-align: center;
        }

        .inventory-item-actions {
            display: flex;
            gap: 4px;
        }

        .inv-btn {
            background: #3d2817;
            border: 1px solid #5c3317;
            color: #f4e4bc;
            width: 20px;
            height: 20px;
            font-size: 0.4rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .inv-btn:hover {
            background: #5c3317;
        }

        .inv-btn.equip {
            background: #2e7d32;
            border-color: #4caf50;
        }

        .inv-btn.equip.equipped {
            background: #daa520;
            border-color: #ffd700;
        }

        .inv-btn.delete {
            background: #8b2500;
            border-color: #cd5c5c;
        }

        .add-item-btn {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background: #2e7d32;
            border: 2px solid #4caf50;
            color: #fff;
            font-family: inherit;
            font-size: 0.4rem;
            cursor: pointer;
        }

        .add-item-btn:hover {
            background: #4caf50;
        }

        /* Add Item Modal */
        .item-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1003;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .item-modal.active {
            display: flex;
        }

        .item-modal-content {
            background: #3d2817;
            border: 6px solid #daa520;
            padding: 25px;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 8px 8px 0 #1a0f07;
            width: 100%;
        }

        .item-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .item-tab {
            flex: 1;
            padding: 10px;
            background: #2d1b0e;
            border: 2px solid #5c3317;
            color: #8b7355;
            font-family: inherit;
            font-size: 0.4rem;
            cursor: pointer;
        }

        .item-tab.active {
            background: #5c3317;
            color: #f4e4bc;
            border-color: #8b4513;
        }

        .item-list-scroll {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .item-option {
            padding: 10px;
            background: #2d1b0e;
            border: 1px solid #5c3317;
            margin-bottom: 5px;
            cursor: pointer;
            font-size: 0.4rem;
        }

        .item-option:hover {
            background: #3d2817;
            border-color: #8b4513;
        }

        .item-option.selected {
            background: #3d2817;
            border-color: #daa520;
        }

        .custom-item-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .custom-item-form label {
            color: #c4a574;
            font-size: 0.4rem;
        }

        .custom-item-form input,
        .custom-item-form select,
        .custom-item-form textarea {
            padding: 8px;
            background: #2d1b0e;
            border: 2px solid #5c3317;
            color: #f4e4bc;
            font-family: inherit;
            font-size: 0.4rem;
        }

        .custom-item-form textarea {
            min-height: 60px;
            resize: vertical;
        }

        .effect-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .effect-row select,
        .effect-row input {
            flex: 1;
        }

        .rarity-uncommon { color: #2ecc71; }
        .rarity-rare { color: #3498db; }
        .rarity-very-rare { color: #9b59b6; }
        .rarity-legendary { color: #f39c12; }

        /* ===== NO CHARACTER MESSAGE ===== */
        .no-character {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
            grid-column: 1 / -1;
        }

        .no-character-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .no-character-text {
            color: #c4a574;
            font-size: 0.6rem;
            margin-bottom: 20px;
            line-height: 2;
        }

        .load-btn {
            background: #8b2500;
            border: 4px solid #cd5c5c;
            color: #f4e4bc;
            padding: 15px 30px;
            font-family: inherit;
            font-size: 0.6rem;
            cursor: pointer;
            box-shadow: 4px 4px 0 #1a0f07;
        }

        .load-btn:hover {
            background: #a52a00;
        }

        /* ===== TABS ===== */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .tab-btn {
            flex: 1;
            background: #2d1b0e;
            border: 2px solid #5c3317;
            color: #c4a574;
            padding: 8px;
            font-family: inherit;
            font-size: 0.45rem;
            cursor: pointer;
        }

        .tab-btn.active {
            background: #3d2817;
            border-color: #daa520;
            color: #daa520;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== HIT DICE ===== */
        .hit-dice-section {
            margin-top: 10px;
            padding: 10px;
            background: #2d1b0e;
            border: 2px solid #5c3317;
        }

        .hit-dice-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.45rem;
        }

        .hit-dice-pips {
            display: flex;
            gap: 4px;
        }

        .hit-die-pip {
            width: 16px;
            height: 16px;
            background: #8b2500;
            border: 2px solid #cd5c5c;
            cursor: pointer;
            font-size: 0.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #f4e4bc;
        }

        .hit-die-pip.used {
            background: #2d1b0e;
            border-color: #5c3317;
            color: #5c3317;
        }

        /* ===== SCANLINES ===== */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.05),
                rgba(0, 0, 0, 0.05) 2px,
                transparent 2px,
                transparent 4px
            );
            pointer-events: none;
            z-index: 1000;
        }

        /* Hidden file input */
        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>D&D <span>CHARACTER</span> SHEET</h1>
        <div class="header-buttons">
            <button class="header-btn" onclick="loadFromFile()">LOAD JSON</button>
            <button class="header-btn" onclick="saveCharacter()">SAVE</button>
            <button class="header-btn" onclick="window.location.href='dnd-creator.html'">CREATE NEW</button>
        </div>
    </header>
    <input type="file" id="fileInput" accept=".json" onchange="handleFileLoad(event)">

    <div class="main-container" id="mainContent">
        <!-- No character loaded state -->
        <div class="no-character" id="noCharacter">
            <div class="no-character-icon">?</div>
            <div class="no-character-text">
                No character loaded.<br>
                Load a character from the creator or import a JSON file.
            </div>
            <button class="load-btn" onclick="loadFromFile()">LOAD CHARACTER</button>
        </div>
    </div>

    <!-- Dice Roll Modal -->
    <div class="dice-modal" id="diceModal">
        <div class="dice-modal-content">
            <div class="dice-modal-title" id="diceModalTitle">Rolling...</div>
            <div class="roll-mode-toggle">
                <button class="roll-mode-btn active" data-mode="normal" onclick="setRollMode('normal')">NORMAL</button>
                <button class="roll-mode-btn advantage" data-mode="advantage" onclick="setRollMode('advantage')">ADVANTAGE</button>
                <button class="roll-mode-btn disadvantage" data-mode="disadvantage" onclick="setRollMode('disadvantage')">DISADVANTAGE</button>
            </div>
            <div class="dice-container" id="diceContainer">
                <div class="die" id="die1">?</div>
                <div class="die" id="die2" style="display: none;">?</div>
            </div>
            <div class="dice-result" id="diceResult" style="display: none;">
                <div class="dice-result-total" id="diceTotal">20</div>
                <div class="dice-result-breakdown" id="diceBreakdown">15 + 5</div>
                <div class="dice-result-type" id="diceResultType"></div>
            </div>
            <div class="dice-modal-buttons">
                <button class="dice-btn" onclick="executeRoll()">ROLL!</button>
                <button class="dice-btn" onclick="closeDiceModal()">CLOSE</button>
            </div>
        </div>
    </div>

    <!-- Spell Preparation Modal -->
    <div class="prep-modal" id="prepModal">
        <div class="prep-modal-content">
            <div class="prep-modal-title">PREPARE SPELLS</div>
            <div class="prep-modal-subtitle" id="prepSubtitle">Select spells to prepare (0/0)</div>
            <div class="prep-spell-grid" id="prepSpellGrid">
                <!-- Spells populated by JS -->
            </div>
            <div class="prep-modal-buttons">
                <button class="prep-btn skip" onclick="skipPreparation()">KEEP CURRENT</button>
                <button class="prep-btn" onclick="confirmPreparation()">CONFIRM</button>
            </div>
        </div>
    </div>

    <!-- Spell Info Modal -->
    <div class="spell-modal" id="spellModal">
        <div class="spell-modal-content">
            <div class="spell-modal-header">
                <div class="spell-modal-title" id="spellModalTitle">Spell Name</div>
                <button class="spell-modal-close" onclick="closeSpellModal()">&times;</button>
            </div>
            <div class="spell-modal-meta" id="spellModalMeta">
                <!-- Level, School, Casting Time, etc. -->
            </div>
            <div class="spell-modal-desc" id="spellModalDesc">
                <!-- Full description -->
            </div>
            <div class="spell-modal-footer" id="spellModalFooter">
                <!-- At Higher Levels, etc. -->
            </div>
        </div>
    </div>

    <div class="scanlines"></div>

    <script>
        // ===== STATE =====
        let character = null;
        let gameState = {
            currentHP: 0,
            tempHP: 0,
            deathSaves: { successes: 0, failures: 0 },
            usedSpellSlots: {},
            usedHitDice: 0,
            usedFeatures: {},
            usedLimitedSpells: {},  // Track feat/subclass spells with daily limits
            conditions: [],
            xp: 0,
            preparedSpells: [],
            currency: { cp: 0, sp: 0, ep: 0, gp: 0, pp: 0 },
            inventory: [],  // Flexible inventory: [{id, name, type, quantity, equipped, effects, description, custom}]
            spellbook: []   // Wizard spellbook: array of spell names the wizard has learned
        };

        // Standard item database
        const ITEM_DATABASE = {
            // Potions
            'Potion of Healing': { type: 'potion', description: 'Regain 2d4+2 HP', consumable: true },
            'Potion of Greater Healing': { type: 'potion', description: 'Regain 4d4+4 HP', consumable: true },
            'Potion of Superior Healing': { type: 'potion', description: 'Regain 8d4+8 HP', consumable: true },
            'Antitoxin': { type: 'potion', description: 'Advantage on saves vs poison for 1 hour', consumable: true },

            // Weapons - Simple Melee
            'Club': { type: 'weapon', subtype: 'simple melee', damage: '1d4 bludgeoning', properties: 'Light' },
            'Dagger': { type: 'weapon', subtype: 'simple melee', damage: '1d4 piercing', properties: 'Finesse, Light, Thrown (20/60)' },
            'Greatclub': { type: 'weapon', subtype: 'simple melee', damage: '1d8 bludgeoning', properties: 'Two-handed' },
            'Handaxe': { type: 'weapon', subtype: 'simple melee', damage: '1d6 slashing', properties: 'Light, Thrown (20/60)' },
            'Javelin': { type: 'weapon', subtype: 'simple melee', damage: '1d6 piercing', properties: 'Thrown (30/120)' },
            'Light Hammer': { type: 'weapon', subtype: 'simple melee', damage: '1d4 bludgeoning', properties: 'Light, Thrown (20/60)' },
            'Mace': { type: 'weapon', subtype: 'simple melee', damage: '1d6 bludgeoning', properties: '' },
            'Quarterstaff': { type: 'weapon', subtype: 'simple melee', damage: '1d6 bludgeoning', properties: 'Versatile (1d8)' },
            'Sickle': { type: 'weapon', subtype: 'simple melee', damage: '1d4 slashing', properties: 'Light' },
            'Spear': { type: 'weapon', subtype: 'simple melee', damage: '1d6 piercing', properties: 'Thrown (20/60), Versatile (1d8)' },

            // Weapons - Simple Ranged
            'Light Crossbow': { type: 'weapon', subtype: 'simple ranged', damage: '1d8 piercing', properties: 'Ammunition (80/320), Loading, Two-handed' },
            'Shortbow': { type: 'weapon', subtype: 'simple ranged', damage: '1d6 piercing', properties: 'Ammunition (80/320), Two-handed' },

            // Weapons - Martial Melee
            'Battleaxe': { type: 'weapon', subtype: 'martial melee', damage: '1d8 slashing', properties: 'Versatile (1d10)' },
            'Flail': { type: 'weapon', subtype: 'martial melee', damage: '1d8 bludgeoning', properties: '' },
            'Glaive': { type: 'weapon', subtype: 'martial melee', damage: '1d10 slashing', properties: 'Heavy, Reach, Two-handed' },
            'Greataxe': { type: 'weapon', subtype: 'martial melee', damage: '1d12 slashing', properties: 'Heavy, Two-handed' },
            'Greatsword': { type: 'weapon', subtype: 'martial melee', damage: '2d6 slashing', properties: 'Heavy, Two-handed' },
            'Halberd': { type: 'weapon', subtype: 'martial melee', damage: '1d10 slashing', properties: 'Heavy, Reach, Two-handed' },
            'Lance': { type: 'weapon', subtype: 'martial melee', damage: '1d12 piercing', properties: 'Reach, Special' },
            'Longsword': { type: 'weapon', subtype: 'martial melee', damage: '1d8 slashing', properties: 'Versatile (1d10)' },
            'Maul': { type: 'weapon', subtype: 'martial melee', damage: '2d6 bludgeoning', properties: 'Heavy, Two-handed' },
            'Morningstar': { type: 'weapon', subtype: 'martial melee', damage: '1d8 piercing', properties: '' },
            'Pike': { type: 'weapon', subtype: 'martial melee', damage: '1d10 piercing', properties: 'Heavy, Reach, Two-handed' },
            'Rapier': { type: 'weapon', subtype: 'martial melee', damage: '1d8 piercing', properties: 'Finesse' },
            'Scimitar': { type: 'weapon', subtype: 'martial melee', damage: '1d6 slashing', properties: 'Finesse, Light' },
            'Shortsword': { type: 'weapon', subtype: 'martial melee', damage: '1d6 piercing', properties: 'Finesse, Light' },
            'Trident': { type: 'weapon', subtype: 'martial melee', damage: '1d6 piercing', properties: 'Thrown (20/60), Versatile (1d8)' },
            'War Pick': { type: 'weapon', subtype: 'martial melee', damage: '1d8 piercing', properties: '' },
            'Warhammer': { type: 'weapon', subtype: 'martial melee', damage: '1d8 bludgeoning', properties: 'Versatile (1d10)' },
            'Whip': { type: 'weapon', subtype: 'martial melee', damage: '1d4 slashing', properties: 'Finesse, Reach' },

            // Weapons - Martial Ranged
            'Hand Crossbow': { type: 'weapon', subtype: 'martial ranged', damage: '1d6 piercing', properties: 'Ammunition (30/120), Light, Loading' },
            'Heavy Crossbow': { type: 'weapon', subtype: 'martial ranged', damage: '1d10 piercing', properties: 'Ammunition (100/400), Heavy, Loading, Two-handed' },
            'Longbow': { type: 'weapon', subtype: 'martial ranged', damage: '1d8 piercing', properties: 'Ammunition (150/600), Heavy, Two-handed' },

            // Armor - Light
            'Padded Armor': { type: 'armor', subtype: 'light', ac: '11 + DEX', effects: { ac: 11 } },
            'Leather Armor': { type: 'armor', subtype: 'light', ac: '11 + DEX', effects: { ac: 11 } },
            'Studded Leather': { type: 'armor', subtype: 'light', ac: '12 + DEX', effects: { ac: 12 } },

            // Armor - Medium
            'Hide Armor': { type: 'armor', subtype: 'medium', ac: '12 + DEX (max 2)', effects: { ac: 12 } },
            'Chain Shirt': { type: 'armor', subtype: 'medium', ac: '13 + DEX (max 2)', effects: { ac: 13 } },
            'Scale Mail': { type: 'armor', subtype: 'medium', ac: '14 + DEX (max 2)', effects: { ac: 14 }, stealth: 'disadvantage' },
            'Breastplate': { type: 'armor', subtype: 'medium', ac: '14 + DEX (max 2)', effects: { ac: 14 } },
            'Half Plate': { type: 'armor', subtype: 'medium', ac: '15 + DEX (max 2)', effects: { ac: 15 }, stealth: 'disadvantage' },

            // Armor - Heavy
            'Ring Mail': { type: 'armor', subtype: 'heavy', ac: '14', effects: { ac: 14 }, stealth: 'disadvantage' },
            'Chain Mail': { type: 'armor', subtype: 'heavy', ac: '16', effects: { ac: 16 }, stealth: 'disadvantage', strReq: 13 },
            'Splint Armor': { type: 'armor', subtype: 'heavy', ac: '17', effects: { ac: 17 }, stealth: 'disadvantage', strReq: 15 },
            'Plate Armor': { type: 'armor', subtype: 'heavy', ac: '18', effects: { ac: 18 }, stealth: 'disadvantage', strReq: 15 },

            // Shields
            'Shield': { type: 'shield', ac: '+2', effects: { acBonus: 2 } },

            // Adventuring Gear
            'Torch': { type: 'gear', description: 'Bright light 20ft, dim light 20ft more. Burns 1 hour.', consumable: true },
            'Rope (50 ft)': { type: 'gear', description: 'Hempen rope, 50 feet' },
            'Rations (1 day)': { type: 'gear', description: 'Food for one day', consumable: true },
            'Waterskin': { type: 'gear', description: 'Holds water for one day' },
            'Tinderbox': { type: 'gear', description: 'Start fires' },
            'Bedroll': { type: 'gear', description: 'Sleep comfortably' },
            'Backpack': { type: 'gear', description: 'Holds 30 lbs of gear' },
            'Mess Kit': { type: 'gear', description: 'Tin box with cup, cutlery, and cookware' },
            'Lantern (Hooded)': { type: 'gear', description: 'Bright light 30ft, dim light 30ft more. Burns 6 hours on 1 pint of oil.' },
            'Oil (flask)': { type: 'gear', description: 'Fuel for lanterns. Burns 6 hours.', consumable: true },
            'Crowbar': { type: 'gear', description: 'Advantage on Strength checks where leverage applies' },
            'Hammer': { type: 'gear', description: 'Standard hammer' },
            'Pitons (10)': { type: 'gear', description: 'Iron spikes for climbing' },
            'Grappling Hook': { type: 'gear', description: 'Hook for climbing with rope' },
            'Mirror (Steel)': { type: 'gear', description: 'A small steel mirror' },
            'Caltrops (bag of 20)': { type: 'gear', description: 'Covers 5ft area. DC 15 DEX or stop, take 1 piercing damage.' },
            'Ball Bearings (bag of 1000)': { type: 'gear', description: 'Covers 10ft area. DC 10 DEX or fall prone.' },
            'Ink (1 ounce bottle)': { type: 'gear', description: 'Writing ink' },
            'Ink Pen': { type: 'gear', description: 'Writing pen' },
            'Paper (sheet)': { type: 'gear', description: 'Sheet of paper' },
            'Parchment (sheet)': { type: 'gear', description: 'Sheet of parchment' },
            'Sealing Wax': { type: 'gear', description: 'For sealing letters' },
            'Signet Ring': { type: 'gear', description: 'Personal seal ring' },
            'Soap': { type: 'gear', description: 'Bar of soap' },
            'Tent (2-person)': { type: 'gear', description: 'Shelter for two' },
            'Healer\'s Kit': { type: 'gear', description: '10 uses. Stabilize a creature at 0 HP without a check.' },
            'Climbing Kit': { type: 'gear', description: 'Pitons, boot tips, gloves, harness. Advantage on climbing checks.' },
            'Thieves\' Tools': { type: 'gear', description: 'Required for picking locks and disabling traps' },
            'Holy Symbol': { type: 'gear', description: 'Spellcasting focus for divine casters' },
            'Druidic Focus': { type: 'gear', description: 'Spellcasting focus for druids' },
            'Arcane Focus': { type: 'gear', description: 'Spellcasting focus for arcane casters' },
            'Component Pouch': { type: 'gear', description: 'Contains material components for spells' },
            'Spellbook': { type: 'gear', description: 'Essential for wizards. Contains your known spells.' },
            'Book of Lore': { type: 'gear', description: 'A book of knowledge on a particular subject.' },
            'Bottle of Ink': { type: 'gear', description: '1 ounce of ink for writing.' },
            'Little Bag of Sand': { type: 'gear', description: 'Component for Sleep spell.' },
            'Small Knife': { type: 'gear', description: 'A small utility knife.' },

            // Ammunition
            'Arrows (20)': { type: 'ammo', description: 'Ammunition for bows' },
            'Bolts (20)': { type: 'ammo', description: 'Ammunition for crossbows' },
            'Sling Bullets (20)': { type: 'ammo', description: 'Ammunition for slings' },

            // Spell Scrolls
            'Spell Scroll (1st level)': { type: 'scroll', description: 'Contains a 1st level spell. DC 13, +5 attack', consumable: true },
            'Spell Scroll (2nd level)': { type: 'scroll', description: 'Contains a 2nd level spell. DC 13, +5 attack', consumable: true },
            'Spell Scroll (3rd level)': { type: 'scroll', description: 'Contains a 3rd level spell. DC 15, +7 attack', consumable: true },
            'Spell Scroll (4th level)': { type: 'scroll', description: 'Contains a 4th level spell. DC 15, +7 attack', consumable: true },
            'Spell Scroll (5th level)': { type: 'scroll', description: 'Contains a 5th level spell. DC 17, +9 attack', consumable: true },

            // Common Magic Items
            'Bag of Holding': { type: 'wondrous', description: 'Holds up to 500 lbs, always weighs 15 lbs', rarity: 'uncommon' },
            'Cloak of Protection': { type: 'wondrous', description: '+1 to AC and saving throws while worn', rarity: 'uncommon', effects: { acBonus: 1, saveBonus: 1 }, attunement: true },
            'Ring of Protection': { type: 'wondrous', description: '+1 to AC and saving throws while worn', rarity: 'rare', effects: { acBonus: 1, saveBonus: 1 }, attunement: true },
            'Amulet of Health': { type: 'wondrous', description: 'CON becomes 19 while worn', rarity: 'rare', effects: { setCON: 19 }, attunement: true },
            'Belt of Giant Strength (Hill)': { type: 'wondrous', description: 'STR becomes 21 while worn', rarity: 'rare', effects: { setSTR: 21 }, attunement: true },
            'Boots of Elvenkind': { type: 'wondrous', description: 'Advantage on Stealth checks', rarity: 'uncommon' },
            'Cloak of Elvenkind': { type: 'wondrous', description: 'Advantage on Stealth checks, disadvantage to spot you', rarity: 'uncommon', attunement: true },
            'Goggles of Night': { type: 'wondrous', description: 'Darkvision 60 ft', rarity: 'uncommon' },
            'Immovable Rod': { type: 'wondrous', description: 'Holds up to 8,000 lbs when activated', rarity: 'uncommon' },
            'Rope of Climbing': { type: 'wondrous', description: '60 ft rope that moves on command', rarity: 'uncommon' },

            // +1/+2/+3 Weapons
            '+1 Weapon': { type: 'weapon', description: '+1 to attack and damage rolls', rarity: 'uncommon', effects: { attackBonus: 1, damageBonus: 1 } },
            '+2 Weapon': { type: 'weapon', description: '+2 to attack and damage rolls', rarity: 'rare', effects: { attackBonus: 2, damageBonus: 2 } },
            '+3 Weapon': { type: 'weapon', description: '+3 to attack and damage rolls', rarity: 'very rare', effects: { attackBonus: 3, damageBonus: 3 } },

            // +1/+2/+3 Armor
            '+1 Armor': { type: 'armor', description: '+1 to AC', rarity: 'rare', effects: { acBonus: 1 } },
            '+2 Armor': { type: 'armor', description: '+2 to AC', rarity: 'very rare', effects: { acBonus: 2 } },
            '+3 Armor': { type: 'armor', description: '+3 to AC', rarity: 'legendary', effects: { acBonus: 3 } }
        };
        let rollMode = 'normal';
        let currentRollData = null;

        // ===== SPELL DATA (subset for prepared casters) =====
        const PREPARED_CASTER_CLASSES = ['cleric', 'druid', 'paladin', 'wizard'];

        // Wizards use a spellbook - they can only prepare spells they've learned
        // Other prepared casters (cleric, druid, paladin) can prepare from full class list
        function isWizard() {
            return character && character.class?.toLowerCase() === 'wizard';
        }

        // Check if this is a prepared caster with full class spell access (not wizard)
        function isFullListPreparedCaster() {
            if (!character) return false;
            const cls = character.class?.toLowerCase();
            return ['cleric', 'druid', 'paladin'].includes(cls);
        }

        // Get wizard's spellbook contents (spells they've learned)
        function getWizardSpellbook() {
            if (!isWizard()) return [];

            // Initialize spellbook from character's known spells if not already set
            if (!gameState.spellbook || gameState.spellbook.length === 0) {
                // Wizards start with 6 1st-level spells at level 1
                // And gain 2 spells per level after that
                const knownSpells = [];
                for (let i = 1; i <= 9; i++) {
                    const levelSpells = character.spells?.[`level${i}`] || [];
                    knownSpells.push(...levelSpells);
                }
                gameState.spellbook = [...knownSpells];
                // Save the initialized spellbook
                if (knownSpells.length > 0) {
                    saveGameState();
                }
            }
            return gameState.spellbook;
        }

        // Add a spell to wizard's spellbook
        function addSpellToSpellbook(spellName) {
            if (!isWizard()) return false;
            if (!gameState.spellbook) gameState.spellbook = [];
            if (!gameState.spellbook.includes(spellName)) {
                gameState.spellbook.push(spellName);
                saveGameState();
                return true;
            }
            return false;
        }

        // Calculate how many spells a wizard should know at their level
        function getWizardSpellbookSize() {
            if (!isWizard()) return 0;
            // Wizards start with 6 spells at level 1, learn 2 more per level
            return 6 + (character.level - 1) * 2;
        }

        // Get spells available for wizard to learn at a specific level (for level up)
        function getLearnableWizardSpells(maxLevel) {
            const wizardSpellList = CLASS_SPELL_LISTS.wizard || {};
            const currentSpellbook = getWizardSpellbook();
            const learnable = [];

            for (let lvl = 1; lvl <= maxLevel; lvl++) {
                const spellsAtLevel = wizardSpellList[lvl] || [];
                spellsAtLevel.forEach(spell => {
                    if (!currentSpellbook.includes(spell)) {
                        learnable.push({ name: spell, level: lvl });
                    }
                });
            }
            return learnable;
        }

        // Spellcasting ability by class
        const SPELLCASTING_ABILITY = {
            bard: 'CHA',
            cleric: 'WIS',
            druid: 'WIS',
            paladin: 'CHA',
            ranger: 'WIS',
            sorcerer: 'CHA',
            warlock: 'CHA',
            wizard: 'INT',
            // Subclass casters
            eldritchknight: 'INT',
            arcanetrickster: 'INT'
        };

        // Get spellcasting ability for current character (handles subclass casters)
        function getSpellcastingAbility() {
            if (isSubclassCaster()) {
                const subclass = character.subclass?.toLowerCase();
                return SPELLCASTING_ABILITY[subclass] || 'INT';
            }
            return SPELLCASTING_ABILITY[character.class?.toLowerCase()] || 'WIS';
        }

        // Saving throw proficiencies by class
        const CLASS_SAVES = {
            barbarian: ['STR', 'CON'],
            bard: ['DEX', 'CHA'],
            cleric: ['WIS', 'CHA'],
            druid: ['INT', 'WIS'],
            fighter: ['STR', 'CON'],
            monk: ['STR', 'DEX'],
            paladin: ['WIS', 'CHA'],
            ranger: ['STR', 'DEX'],
            rogue: ['DEX', 'INT'],
            sorcerer: ['CON', 'CHA'],
            warlock: ['WIS', 'CHA'],
            wizard: ['INT', 'WIS']
        };

        function getSavingThrowProficiencies() {
            return CLASS_SAVES[character.class] || [];
        }

        // Conditions
        const CONDITIONS = [
            'Blinded', 'Charmed', 'Deafened', 'Frightened', 'Grappled',
            'Incapacitated', 'Invisible', 'Paralyzed', 'Petrified', 'Poisoned',
            'Prone', 'Restrained', 'Stunned', 'Unconscious', 'Exhaustion'
        ];

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
        });

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('dnd-active-character');
            if (saved) {
                try {
                    character = JSON.parse(saved);
                    loadGameState();
                    renderCharacterSheet();
                } catch (e) {
                    console.error('Failed to load character:', e);
                }
            }
        }

        function loadGameState() {
            const saved = localStorage.getItem('dnd-game-state-' + (character.name || 'unnamed'));
            if (saved) {
                try {
                    gameState = { ...gameState, ...JSON.parse(saved) };
                } catch (e) {
                    console.error('Failed to load game state:', e);
                }
            } else {
                // Initialize fresh game state
                gameState.currentHP = calculateMaxHP();
                // For prepared casters, start with no prepared spells (they need to prepare on first long rest)
                // For known casters, all spells are "prepared" (always castable)
                if (isPreparedCaster()) {
                    gameState.preparedSpells = [];
                } else {
                    // Known casters: all leveled spells are always available
                    const allKnown = [];
                    for (let i = 1; i <= 9; i++) {
                        const lvlSpells = character.spells?.[`level${i}`] || [];
                        allKnown.push(...lvlSpells);
                    }
                    gameState.preparedSpells = allKnown;
                }
            }

            // Validate prepared spells against current max
            if (isPreparedCaster() && gameState.preparedSpells) {
                const maxPrep = getMaxPreparedSpells();
                const maxSpellLevel = getMaxSpellLevelForClass(character.class, character.level);

                // Filter out cantrips and spells that are too high level for current character level
                const validSpells = gameState.preparedSpells.filter(spell => {
                    const spellData = SPELL_DESCRIPTIONS[spell];
                    // Check if this spell is a cantrip - cantrips cannot be prepared (they're always available)
                    if (spellData && spellData.level && spellData.level.toLowerCase().includes('cantrip')) {
                        return false; // Remove cantrips from prepared list
                    }
                    if (!spellData || !spellData.level) return true; // Keep if we can't determine level
                    const levelMatch = spellData.level.match(/(\d+)/);
                    if (!levelMatch) return false; // Remove if no level number found (likely cantrip)
                    const spellLevel = parseInt(levelMatch[1]);
                    return spellLevel <= maxSpellLevel;
                });

                // Trim to max prepared if over limit
                if (validSpells.length > maxPrep) {
                    gameState.preparedSpells = validSpells.slice(0, maxPrep);
                } else {
                    gameState.preparedSpells = validSpells;
                }

                // Save the corrected state
                saveGameState();
            }

            // Validate usedHitDice doesn't exceed character level
            if (gameState.usedHitDice > character.level) {
                gameState.usedHitDice = character.level;
                saveGameState();
            }
        }

        function saveGameState() {
            if (character) {
                localStorage.setItem('dnd-game-state-' + (character.name || 'unnamed'), JSON.stringify(gameState));
            }
        }

        function loadFromFile() {
            document.getElementById('fileInput').click();
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        character = JSON.parse(e.target.result);
                        localStorage.setItem('dnd-active-character', JSON.stringify(character));
                        loadGameState();
                        renderCharacterSheet();
                    } catch (err) {
                        alert('Invalid character file');
                    }
                };
                reader.readAsText(file);
            }
        }

        function saveCharacter() {
            if (!character) return;
            const data = {
                character: character,
                gameState: gameState
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${character.name || 'character'}-save.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ===== CALCULATIONS =====
        function getModifier(score) {
            return Math.floor((score - 10) / 2);
        }

        function formatModifier(mod) {
            return mod >= 0 ? '+' + mod : '' + mod;
        }

        function getProficiencyBonus() {
            return Math.ceil(character.level / 4) + 1;
        }

        function getAbilityScore(ability) {
            // Base score from character, then apply equipment bonuses
            let score = character.abilities?.[ability] || 10;

            // Apply equipment effects
            if (gameState.inventory) {
                gameState.inventory.forEach(item => {
                    if (item.equipped && item.effects) {
                        // "Set" effects (like Amulet of Health setting CON to 19)
                        const setKey = 'set' + ability;
                        if (item.effects[setKey] && item.effects[setKey] > score) {
                            score = item.effects[setKey];
                        }
                        // Bonus effects (like +2 STR)
                        const bonusKey = 'bonus' + ability;
                        if (item.effects[bonusKey]) {
                            score += item.effects[bonusKey];
                        }
                    }
                });
            }

            return Math.min(30, score); // Cap at 30
        }

        function calculateMaxHP() {
            if (!character || !character.class) return 10;

            const hitDice = {
                barbarian: 12, bard: 8, cleric: 8, druid: 8, fighter: 10,
                monk: 8, paladin: 10, ranger: 10, rogue: 8, sorcerer: 6,
                warlock: 8, wizard: 6
            };

            const hitDie = hitDice[character.class] || 8;
            const conMod = getModifier(getAbilityScore('CON'));
            const avgDie = Math.floor(hitDie / 2) + 1;

            return hitDie + conMod + (character.level - 1) * (avgDie + conMod);
        }

        function getSpellSlots() {
            if (!character || !character.class) return [];

            const fullCasters = ['bard', 'cleric', 'druid', 'sorcerer', 'wizard'];
            const halfCasters = ['paladin', 'ranger'];
            const level = character.level;

            if (character.class === 'warlock') {
                const numSlots = level >= 17 ? 4 : level >= 11 ? 3 : level >= 2 ? 2 : 1;
                const slotLevel = Math.min(5, Math.ceil(level / 2));
                return [{ level: slotLevel, slots: numSlots, isPact: true }];
            }

            const slotProgression = {
                1: [2], 2: [3], 3: [4,2], 4: [4,3], 5: [4,3,2],
                6: [4,3,3], 7: [4,3,3,1], 8: [4,3,3,2], 9: [4,3,3,3,1],
                10: [4,3,3,3,2], 11: [4,3,3,3,2,1], 12: [4,3,3,3,2,1],
                13: [4,3,3,3,2,1,1], 14: [4,3,3,3,2,1,1], 15: [4,3,3,3,2,1,1,1],
                16: [4,3,3,3,2,1,1,1], 17: [4,3,3,3,2,1,1,1,1], 18: [4,3,3,3,3,1,1,1,1],
                19: [4,3,3,3,3,2,1,1,1], 20: [4,3,3,3,3,2,2,1,1]
            };

            const halfSlotProgression = {
                2: [2], 3: [3], 4: [3], 5: [4,2], 6: [4,2], 7: [4,3],
                8: [4,3], 9: [4,3,2], 10: [4,3,2], 11: [4,3,3], 12: [4,3,3],
                13: [4,3,3,1], 14: [4,3,3,1], 15: [4,3,3,2], 16: [4,3,3,2],
                17: [4,3,3,3,1], 18: [4,3,3,3,1], 19: [4,3,3,3,2], 20: [4,3,3,3,2]
            };

            let slots = [];
            if (fullCasters.includes(character.class)) {
                slots = slotProgression[level] || [];
            } else if (halfCasters.includes(character.class) && level >= 2) {
                slots = halfSlotProgression[level] || [];
            }

            return slots.map((count, idx) => ({ level: idx + 1, slots: count }));
        }

        function getMaxPreparedSpells() {
            if (!character || !PREPARED_CASTER_CLASSES.includes(character.class)) return 0;

            const ability = getSpellcastingAbility();
            const mod = getModifier(getAbilityScore(ability));

            if (character.class === 'wizard') {
                return character.level + mod;
            } else if (character.class === 'paladin') {
                return Math.max(1, Math.floor(character.level / 2) + mod);
            } else {
                return Math.max(1, character.level + mod);
            }
        }

        function isPreparedCaster() {
            return character && PREPARED_CASTER_CLASSES.includes(character.class);
        }

        // ===== RENDER =====
        function renderCharacterSheet() {
            console.log('renderCharacterSheet called, character level:', character ? character.level : 'null');
            if (!character) {
                const noChar = document.getElementById('noCharacter');
                if (noChar) noChar.style.display = 'flex';
                return;
            }

            // Hide no-character message if it still exists (first render only)
            const noChar = document.getElementById('noCharacter');
            if (noChar) noChar.style.display = 'none';

            const container = document.getElementById('mainContent');
            if (!container) {
                console.error('mainContent container not found!');
                return;
            }
            console.log('About to update container innerHTML');
            container.innerHTML = `
                <!-- Left Column -->
                <div class="left-column">
                    <!-- Character Info -->
                    <div class="panel">
                        <div class="char-name">${character.name || 'Unnamed Hero'}</div>
                        <div class="char-info">
                            <div class="char-detail">
                                <span class="char-detail-label">RACE</span>
                                <span class="char-detail-value">${getDisplayRace()}</span>
                            </div>
                            <div class="char-detail">
                                <span class="char-detail-label">CLASS</span>
                                <span class="char-detail-value">${getDisplayClass()}</span>
                            </div>
                            <div class="char-detail">
                                <span class="char-detail-label">LEVEL</span>
                                <span class="char-detail-value">${character.level}</span>
                            </div>
                            <div class="char-detail">
                                <span class="char-detail-label">BACKGROUND</span>
                                <span class="char-detail-value">${getDisplayBackground()}</span>
                            </div>
                            <div class="char-detail">
                                <span class="char-detail-label">ALIGNMENT</span>
                                <span class="char-detail-value">${getAlignmentName(character.alignment)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- HP Tracker -->
                    <div class="panel">
                        <div class="panel-title">HIT POINTS</div>
                        <div class="hp-tracker">
                            <div class="hp-bar-container">
                                <div class="hp-bar" id="hpBar" style="width: ${getHPPercent()}%"></div>
                                <div class="hp-bar-text" id="hpText">${gameState.currentHP} / ${calculateMaxHP()}</div>
                            </div>
                            <div class="hp-controls">
                                <input type="number" class="hp-input" id="hpAmount" value="1" min="1">
                                <button class="hp-btn damage" onclick="takeDamage()">DAMAGE</button>
                                <button class="hp-btn heal" onclick="heal()">HEAL</button>
                            </div>
                            <div class="temp-hp">
                                <span>TEMP HP:</span>
                                <input type="number" class="temp-hp-input" id="tempHP" value="${gameState.tempHP}" min="0" onchange="updateTempHP()">
                            </div>
                        </div>

                        <div class="death-saves ${gameState.currentHP <= 0 ? 'active' : ''}" id="deathSaves">
                            <div class="death-saves-title">DEATH SAVING THROWS</div>
                            <div class="death-saves-row">
                                <span class="death-save-label success">SUCCESSES</span>
                                <div class="death-save-boxes">
                                    ${[0,1,2].map(i => `
                                        <div class="death-save-box success ${gameState.deathSaves.successes > i ? 'filled' : ''}"
                                             onclick="toggleDeathSave('successes', ${i})"></div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="death-saves-row">
                                <span class="death-save-label failure">FAILURES</span>
                                <div class="death-save-boxes">
                                    ${[0,1,2].map(i => `
                                        <div class="death-save-box failure ${gameState.deathSaves.failures > i ? 'filled' : ''}"
                                             onclick="toggleDeathSave('failures', ${i})"></div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <div class="hit-dice-section">
                            <div class="hit-dice-row">
                                <span>HIT DICE (${getHitDie()})</span>
                                <div class="hit-dice-pips">
                                    ${Array(character.level).fill(0).map((_, i) => `
                                        <div class="hit-die-pip ${i < gameState.usedHitDice ? 'used' : ''}"
                                             onclick="toggleHitDie(${i})">${getHitDie().replace('d','')}</div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ability Scores -->
                    <div class="panel">
                        <div class="panel-title">ABILITY SCORES</div>
                        <div class="abilities-grid">
                            ${['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'].map(ability => `
                                <div class="ability-box" onclick="rollAbilityCheck('${ability}')">
                                    <div class="ability-name">${ability}</div>
                                    <div class="ability-score">${getAbilityScore(ability)}</div>
                                    <div class="ability-mod">${formatModifier(getModifier(getAbilityScore(ability)))}</div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="saves-grid">
                            ${['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'].map(ability => {
                                const isProficient = getSavingThrowProficiencies().includes(ability);
                                const mod = getModifier(getAbilityScore(ability)) + (isProficient ? getProficiencyBonus() : 0);
                                return `
                                    <div class="save-item ${isProficient ? 'proficient' : ''}" onclick="rollSave('${ability}')">
                                        <div class="save-prof"></div>
                                        <span>${ability} Save</span>
                                        <span class="save-mod">${formatModifier(mod)}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Rest Buttons -->
                    <div class="rest-buttons">
                        <button class="rest-btn short" onclick="shortRest()">SHORT REST</button>
                        <button class="rest-btn long" onclick="longRest()">LONG REST</button>
                    </div>
                </div>

                <!-- Middle Column -->
                <div class="middle-column">
                    <!-- Combat Stats -->
                    <div class="panel">
                        <div class="combat-stats">
                            <div class="combat-stat" onclick="showACBreakdown()" style="cursor: pointer;" title="Click for AC breakdown">
                                <div class="combat-stat-label">AC</div>
                                <div class="combat-stat-value" id="acValue">${calculateAC()}</div>
                            </div>
                            <div class="combat-stat" onclick="rollInitiative()" style="cursor: pointer;">
                                <div class="combat-stat-label">INITIATIVE</div>
                                <div class="combat-stat-value">${formatModifier(getModifier(getAbilityScore('DEX')))}</div>
                            </div>
                            <div class="combat-stat">
                                <div class="combat-stat-label">SPEED</div>
                                <div class="combat-stat-value">${getSpeed()}</div>
                            </div>
                            <div class="combat-stat">
                                <div class="combat-stat-label">PROF</div>
                                <div class="combat-stat-value">+${getProficiencyBonus()}</div>
                            </div>
                            <div class="combat-stat">
                                <div class="combat-stat-label">PASSIVE</div>
                                <div class="combat-stat-value">${10 + getModifier(getAbilityScore('WIS')) + (character.skills?.includes('Perception') ? getProficiencyBonus() : 0)}</div>
                            </div>
                            <div class="combat-stat">
                                <div class="combat-stat-label">HIT DIE</div>
                                <div class="combat-stat-value">${getHitDie()}</div>
                            </div>
                        </div>

                        <!-- Conditions -->
                        <div class="conditions-panel">
                            <div class="panel-title" style="font-size: 0.5rem; margin-bottom: 8px;">CONDITIONS</div>
                            <div class="conditions-grid">
                                ${CONDITIONS.map(cond => `
                                    <div class="condition-tag ${gameState.conditions.includes(cond) ? 'active' : ''}"
                                         onclick="toggleCondition('${cond}')">${cond}</div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Skills -->
                    <div class="panel">
                        <div class="panel-title">SKILLS</div>
                        <div class="skills-list">
                            ${renderSkills()}
                        </div>
                    </div>

                    <!-- Level Up -->
                    <div class="panel">
                        <div class="panel-title">CHARACTER LEVEL</div>
                        <div style="text-align: center; padding: 10px;">
                            <div style="font-size: 0.8rem; color: #daa520; margin-bottom: 10px;">Level ${character.level}</div>
                            <button class="rest-btn" onclick="levelUp()" style="width: 100%; font-size: 0.45rem; background: #2e7d32; border-color: #4caf50;">
                                LEVEL UP TO ${character.level + 1}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="right-column">
                    <!-- Tabs -->
                    <div class="panel">
                        <div class="tabs">
                            <button class="tab-btn active" onclick="switchTab('spells')">SPELLS</button>
                            <button class="tab-btn" onclick="switchTab('features')">FEATURES</button>
                            <button class="tab-btn" onclick="switchTab('inventory')">INVENTORY</button>
                        </div>

                        <!-- Spells Tab -->
                        <div class="tab-content active" id="spellsTab">
                            ${isPreparedCaster() ? `
                                <button class="rest-btn" onclick="showSpellPreparation()" style="width: 100%; margin-bottom: 10px; font-size: 0.45rem;">
                                    MANAGE PREPARED SPELLS
                                </button>
                            ` : ''}
                            ${isWizard() ? `
                                <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                                    <button class="rest-btn" onclick="showLearnFromScroll()" style="flex: 1; font-size: 0.4rem; background: #4a148c; border-color: #7b1fa2;">
                                         LEARN FROM SCROLL
                                    </button>
                                    <button class="rest-btn" onclick="showSpellbookInfo()" style="padding: 8px 12px; font-size: 0.4rem; background: #1565c0; border-color: #1976d2;">
                                         SPELLBOOK (${getWizardSpellbook().length})
                                    </button>
                                </div>
                            ` : ''}
                            ${renderSpellSlots()}
                            ${renderSpells()}
                        </div>

                        <!-- Features Tab -->
                        <div class="tab-content" id="featuresTab">
                            ${renderFeatures()}
                        </div>

                        <!-- Inventory Tab -->
                        <div class="tab-content" id="inventoryTab">
                            ${renderInventory()}
                        </div>
                    </div>
                </div>
            `;

            updateHPBar();
        }

        function getDisplayRace() {
            const raceNames = {
                'elf': 'Elf', 'dwarf': 'Dwarf', 'human': 'Human', 'halfling': 'Halfling',
                'dragonborn': 'Dragonborn', 'gnome': 'Gnome', 'half-elf': 'Half-Elf',
                'half-orc': 'Half-Orc', 'tiefling': 'Tiefling', 'aasimar': 'Aasimar'
            };
            const subraceNames = {
                'high': 'High', 'wood': 'Wood', 'dark': 'Dark', 'eladrin': 'Eladrin',
                'hill': 'Hill', 'mountain': 'Mountain', 'duergar': 'Duergar',
                'lightfoot': 'Lightfoot', 'stout': 'Stout', 'ghostwise': 'Ghostwise',
                'forest': 'Forest', 'rock': 'Rock', 'deep': 'Deep',
                'black': 'Black', 'blue': 'Blue', 'brass': 'Brass', 'bronze': 'Bronze',
                'copper': 'Copper', 'gold': 'Gold', 'green': 'Green', 'red': 'Red',
                'silver': 'Silver', 'white': 'White',
                'protector': 'Protector', 'scourge': 'Scourge', 'fallen': 'Fallen'
            };

            const race = raceNames[character.race?.toLowerCase()] ||
                (character.race ? character.race.charAt(0).toUpperCase() + character.race.slice(1) : 'Unknown');

            if (character.subrace) {
                const subrace = subraceNames[character.subrace?.toLowerCase()] ||
                    character.subrace.charAt(0).toUpperCase() + character.subrace.slice(1);
                return `${subrace} ${race}`;
            }
            return race;
        }

        function getDisplayClass() {
            const classNames = {
                'barbarian': 'Barbarian', 'bard': 'Bard', 'cleric': 'Cleric', 'druid': 'Druid',
                'fighter': 'Fighter', 'monk': 'Monk', 'paladin': 'Paladin', 'ranger': 'Ranger',
                'rogue': 'Rogue', 'sorcerer': 'Sorcerer', 'warlock': 'Warlock', 'wizard': 'Wizard'
            };
            const subclassNames = {
                // Druid
                'land': 'Circle of the Land', 'moon': 'Circle of the Moon', 'dreams': 'Circle of Dreams',
                'shepherd': 'Circle of the Shepherd', 'spores': 'Circle of Spores', 'stars': 'Circle of Stars',
                'wildfire': 'Circle of Wildfire',
                // Cleric
                'knowledge': 'Knowledge Domain', 'life': 'Life Domain', 'light': 'Light Domain',
                'nature': 'Nature Domain', 'tempest': 'Tempest Domain', 'trickery': 'Trickery Domain',
                'war': 'War Domain', 'death': 'Death Domain', 'forge': 'Forge Domain',
                'grave': 'Grave Domain', 'order': 'Order Domain', 'peace': 'Peace Domain',
                'twilight': 'Twilight Domain',
                // Fighter
                'champion': 'Champion', 'battlemaster': 'Battle Master', 'eldritchknight': 'Eldritch Knight',
                // Rogue
                'thief': 'Thief', 'assassin': 'Assassin', 'arcanetrickster': 'Arcane Trickster',
                // Wizard
                'abjuration': 'School of Abjuration', 'conjuration': 'School of Conjuration',
                'divination': 'School of Divination', 'enchantment': 'School of Enchantment',
                'evocation': 'School of Evocation', 'illusion': 'School of Illusion',
                'necromancy': 'School of Necromancy', 'transmutation': 'School of Transmutation',
                // Barbarian
                'berserker': 'Path of the Berserker', 'totem': 'Path of the Totem Warrior',
                // Bard
                'lore': 'College of Lore', 'valor': 'College of Valor',
                // Monk
                'openhand': 'Way of the Open Hand', 'shadow': 'Way of Shadow', 'fourelements': 'Way of the Four Elements',
                // Paladin
                'devotion': 'Oath of Devotion', 'ancients': 'Oath of the Ancients', 'vengeance': 'Oath of Vengeance',
                // Ranger
                'hunter': 'Hunter', 'beastmaster': 'Beast Master',
                // Sorcerer
                'draconic': 'Draconic Bloodline', 'wildmagic': 'Wild Magic',
                // Warlock
                'archfey': 'The Archfey', 'fiend': 'The Fiend', 'greatoldone': 'The Great Old One'
            };

            const cls = classNames[character.class?.toLowerCase()] ||
                (character.class ? character.class.charAt(0).toUpperCase() + character.class.slice(1) : 'Unknown');

            if (character.subclass) {
                const subclass = subclassNames[character.subclass?.toLowerCase()] ||
                    character.subclass.charAt(0).toUpperCase() + character.subclass.slice(1);
                return `${cls} (${subclass})`;
            }
            return cls;
        }

        function getAlignmentName(code) {
            const alignments = {
                'LG': 'Lawful Good', 'NG': 'Neutral Good', 'CG': 'Chaotic Good',
                'LN': 'Lawful Neutral', 'TN': 'True Neutral', 'CN': 'Chaotic Neutral',
                'LE': 'Lawful Evil', 'NE': 'Neutral Evil', 'CE': 'Chaotic Evil'
            };
            // If already a full name, capitalize it
            if (code && !alignments[code]) {
                return code.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
            }
            return alignments[code] || code || 'Unknown';
        }

        function getDisplayBackground() {
            if (!character.background) return 'Unknown';
            return character.background.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
        }

        function getHitDie() {
            const hitDice = {
                barbarian: 'd12', bard: 'd8', cleric: 'd8', druid: 'd8', fighter: 'd10',
                monk: 'd8', paladin: 'd10', ranger: 'd10', rogue: 'd8', sorcerer: 'd6',
                warlock: 'd8', wizard: 'd6'
            };
            return hitDice[character.class] || 'd8';
        }

        function getSpeed() {
            const speeds = {
                human: 30, elf: 30, dwarf: 25, halfling: 25, gnome: 25,
                'half-elf': 30, 'half-orc': 30, tiefling: 30, dragonborn: 30
            };
            return speeds[character.race] || 30;
        }

        function calculateAC() {
            const dexMod = getModifier(getAbilityScore('DEX'));
            let baseAC = 10 + dexMod; // Unarmored default

            // Check equipment for armor
            const equipment = character.equipment?.granted || [];
            const allEquipment = [...equipment];

            // Add equipment choices
            if (character.equipment?.choices) {
                Object.values(character.equipment.choices).forEach(choice => {
                    if (Array.isArray(choice)) {
                        allEquipment.push(...choice);
                    } else if (choice) {
                        allEquipment.push(choice);
                    }
                });
            }

            const equipmentStr = allEquipment.join(' ').toLowerCase();

            // Check for armor types (from heaviest to lightest)
            if (equipmentStr.includes('plate')) {
                baseAC = 18;
            } else if (equipmentStr.includes('splint')) {
                baseAC = 17;
            } else if (equipmentStr.includes('chain mail')) {
                baseAC = 16;
            } else if (equipmentStr.includes('half plate')) {
                baseAC = 15 + Math.min(2, dexMod);
            } else if (equipmentStr.includes('breastplate')) {
                baseAC = 14 + Math.min(2, dexMod);
            } else if (equipmentStr.includes('scale mail')) {
                baseAC = 14 + Math.min(2, dexMod);
            } else if (equipmentStr.includes('chain shirt')) {
                baseAC = 13 + Math.min(2, dexMod);
            } else if (equipmentStr.includes('ring mail')) {
                baseAC = 14;
            } else if (equipmentStr.includes('hide')) {
                baseAC = 12 + Math.min(2, dexMod);
            } else if (equipmentStr.includes('studded leather')) {
                baseAC = 12 + dexMod;
            } else if (equipmentStr.includes('leather armor') || equipmentStr.includes('leather armour')) {
                baseAC = 11 + dexMod;
            } else if (equipmentStr.includes('padded')) {
                baseAC = 11 + dexMod;
            }

            // Check for shield
            if (equipmentStr.includes('shield')) {
                baseAC += 2;
            }

            // Barbarian Unarmored Defense
            if (character.class === 'barbarian' && !equipmentStr.includes('armor') && !equipmentStr.includes('armour')) {
                const conMod = getModifier(getAbilityScore('CON'));
                const barbarianAC = 10 + dexMod + conMod;
                if (barbarianAC > baseAC) baseAC = barbarianAC;
            }

            // Monk Unarmored Defense
            if (character.class === 'monk' && !equipmentStr.includes('armor') && !equipmentStr.includes('armour')) {
                const wisMod = getModifier(getAbilityScore('WIS'));
                const monkAC = 10 + dexMod + wisMod;
                if (monkAC > baseAC) baseAC = monkAC;
            }

            // Add equipment bonuses from inventory
            if (gameState.inventory) {
                gameState.inventory.forEach(item => {
                    if (item.equipped && item.effects?.acBonus) {
                        baseAC += item.effects.acBonus;
                    }
                });
            }

            return baseAC;
        }

        // Get detailed AC breakdown for display
        function getACBreakdown() {
            const dexMod = getModifier(getAbilityScore('DEX'));
            let breakdown = [];
            let baseAC = 10;
            let armorName = 'Unarmored';
            let armorType = 'none';
            let shieldBonus = 0;
            let equipmentBonuses = [];

            // Check equipment for armor
            const equipment = character.equipment?.granted || [];
            const allEquipment = [...equipment];

            if (character.equipment?.choices) {
                Object.values(character.equipment.choices).forEach(choice => {
                    if (Array.isArray(choice)) {
                        allEquipment.push(...choice);
                    } else if (choice) {
                        allEquipment.push(choice);
                    }
                });
            }

            const equipmentStr = allEquipment.join(' ').toLowerCase();

            // Determine armor type
            if (equipmentStr.includes('plate') && !equipmentStr.includes('half plate') && !equipmentStr.includes('breastplate')) {
                baseAC = 18; armorName = 'Plate Armor'; armorType = 'heavy';
            } else if (equipmentStr.includes('splint')) {
                baseAC = 17; armorName = 'Splint Armor'; armorType = 'heavy';
            } else if (equipmentStr.includes('chain mail')) {
                baseAC = 16; armorName = 'Chain Mail'; armorType = 'heavy';
            } else if (equipmentStr.includes('ring mail')) {
                baseAC = 14; armorName = 'Ring Mail'; armorType = 'heavy';
            } else if (equipmentStr.includes('half plate')) {
                baseAC = 15; armorName = 'Half Plate'; armorType = 'medium';
            } else if (equipmentStr.includes('breastplate')) {
                baseAC = 14; armorName = 'Breastplate'; armorType = 'medium';
            } else if (equipmentStr.includes('scale mail')) {
                baseAC = 14; armorName = 'Scale Mail'; armorType = 'medium';
            } else if (equipmentStr.includes('chain shirt')) {
                baseAC = 13; armorName = 'Chain Shirt'; armorType = 'medium';
            } else if (equipmentStr.includes('hide')) {
                baseAC = 12; armorName = 'Hide Armor'; armorType = 'medium';
            } else if (equipmentStr.includes('studded leather')) {
                baseAC = 12; armorName = 'Studded Leather'; armorType = 'light';
            } else if (equipmentStr.includes('leather armor') || equipmentStr.includes('leather armour')) {
                baseAC = 11; armorName = 'Leather Armor'; armorType = 'light';
            } else if (equipmentStr.includes('padded')) {
                baseAC = 11; armorName = 'Padded Armor'; armorType = 'light';
            }

            // Check for shield
            if (equipmentStr.includes('shield')) {
                shieldBonus = 2;
            }

            // Build breakdown
            if (armorType === 'none') {
                breakdown.push(`Base: 10`);
                breakdown.push(`DEX modifier: ${dexMod >= 0 ? '+' : ''}${dexMod}`);
            } else if (armorType === 'light') {
                breakdown.push(`${armorName}: ${baseAC}`);
                breakdown.push(`DEX modifier: ${dexMod >= 0 ? '+' : ''}${dexMod}`);
                baseAC += dexMod;
            } else if (armorType === 'medium') {
                const cappedDex = Math.min(2, dexMod);
                breakdown.push(`${armorName}: ${baseAC}`);
                breakdown.push(`DEX modifier (max +2): ${cappedDex >= 0 ? '+' : ''}${cappedDex}`);
                baseAC += cappedDex;
            } else if (armorType === 'heavy') {
                breakdown.push(`${armorName}: ${baseAC}`);
                breakdown.push(`(Heavy armor: no DEX bonus)`);
            }

            // Barbarian Unarmored Defense
            if (character.class === 'barbarian' && armorType === 'none') {
                const conMod = getModifier(getAbilityScore('CON'));
                const barbarianAC = 10 + dexMod + conMod;
                if (barbarianAC > baseAC) {
                    breakdown = [`Unarmored Defense: 10`, `DEX modifier: ${dexMod >= 0 ? '+' : ''}${dexMod}`, `CON modifier: ${conMod >= 0 ? '+' : ''}${conMod}`];
                    baseAC = barbarianAC;
                }
            }

            // Monk Unarmored Defense
            if (character.class === 'monk' && armorType === 'none') {
                const wisMod = getModifier(getAbilityScore('WIS'));
                const monkAC = 10 + dexMod + wisMod;
                if (monkAC > baseAC) {
                    breakdown = [`Unarmored Defense: 10`, `DEX modifier: ${dexMod >= 0 ? '+' : ''}${dexMod}`, `WIS modifier: ${wisMod >= 0 ? '+' : ''}${wisMod}`];
                    baseAC = monkAC;
                }
            }

            // Shield
            if (shieldBonus > 0) {
                breakdown.push(`Shield: +${shieldBonus}`);
                baseAC += shieldBonus;
            }

            // Equipment bonuses from inventory
            if (gameState.inventory) {
                gameState.inventory.forEach(item => {
                    if (item.equipped && item.effects?.acBonus) {
                        breakdown.push(`${item.name}: +${item.effects.acBonus}`);
                        baseAC += item.effects.acBonus;
                    }
                });
            }

            breakdown.push(``);
            breakdown.push(`TOTAL AC: ${baseAC}`);

            // Add note about Mage Armor if known but not wearing armor
            if (character.spells?.level1?.includes('Mage Armor') && armorType === 'none') {
                breakdown.push(``);
                breakdown.push(` With Mage Armor: ${13 + dexMod + shieldBonus}`);
                breakdown.push(`(13 + DEX${shieldBonus > 0 ? ' + Shield' : ''})`);
            }

            return breakdown.join('\n');
        }

        function showACBreakdown() {
            alert('AC BREAKDOWN\n\n' + getACBreakdown());
        }

        function getHPPercent() {
            const max = calculateMaxHP();
            return Math.max(0, Math.min(100, (gameState.currentHP / max) * 100));
        }

        function renderSkills() {
            const skills = [
                { name: 'Acrobatics', ability: 'DEX' },
                { name: 'Animal Handling', ability: 'WIS' },
                { name: 'Arcana', ability: 'INT' },
                { name: 'Athletics', ability: 'STR' },
                { name: 'Deception', ability: 'CHA' },
                { name: 'History', ability: 'INT' },
                { name: 'Insight', ability: 'WIS' },
                { name: 'Intimidation', ability: 'CHA' },
                { name: 'Investigation', ability: 'INT' },
                { name: 'Medicine', ability: 'WIS' },
                { name: 'Nature', ability: 'INT' },
                { name: 'Perception', ability: 'WIS' },
                { name: 'Performance', ability: 'CHA' },
                { name: 'Persuasion', ability: 'CHA' },
                { name: 'Religion', ability: 'INT' },
                { name: 'Sleight of Hand', ability: 'DEX' },
                { name: 'Stealth', ability: 'DEX' },
                { name: 'Survival', ability: 'WIS' }
            ];

            return skills.map(skill => {
                const isProficient = character.skills?.includes(skill.name);
                const isExpertise = character.expertise?.includes(skill.name);
                const mod = getModifier(getAbilityScore(skill.ability)) +
                           (isProficient ? getProficiencyBonus() : 0) +
                           (isExpertise ? getProficiencyBonus() : 0);

                return `
                    <div class="skill-item ${isProficient ? 'proficient' : ''} ${isExpertise ? 'expertise' : ''}"
                         onclick="rollSkill('${skill.name}', '${skill.ability}')">
                        <div class="skill-prof"></div>
                        <span class="skill-name">${skill.name}</span>
                        <span class="skill-ability">(${skill.ability})</span>
                        <span class="skill-mod">${formatModifier(mod)}</span>
                    </div>
                `;
            }).join('');
        }

        function renderSpellSlots() {
            const slots = getSpellSlots();
            if (slots.length === 0) return '<div style="color: #6b4423; font-size: 0.45rem;">No spellcasting</div>';

            return `
                <div class="spell-slots-grid">
                    ${slots.map(slot => {
                        const used = gameState.usedSpellSlots[slot.level] || 0;
                        return `
                            <div class="spell-slot-row" data-spell-slot-level="${slot.level}">
                                <span class="spell-slot-level">${slot.isPact ? 'PACT' : 'LVL ' + slot.level}</span>
                                <div class="spell-slot-pips">
                                    ${Array(slot.slots).fill(0).map((_, i) => `
                                        <div class="spell-slot-pip ${i < used ? 'used' : ''}"
                                             onclick="toggleSpellSlot(${slot.level}, ${i}, event)"></div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Spell metadata - ritual spells and their properties
        const SPELL_DATA = {
            // Level 1 Rituals
            'Alarm': { ritual: true, duration: '8 hours' },
            'Comprehend Languages': { ritual: true, duration: '1 hour' },
            'Detect Magic': { ritual: true, duration: '10 min', concentration: true },
            'Find Familiar': { ritual: true, duration: 'Instant' },
            'Identify': { ritual: true, duration: 'Instant' },
            'Illusory Script': { ritual: true, duration: '10 days' },
            'Speak with Animals': { ritual: true, duration: '10 min' },
            'Tenser\'s Floating Disk': { ritual: true, duration: '1 hour' },
            'Unseen Servant': { ritual: true, duration: '1 hour' },
            // Level 1 Concentration
            'Bless': { duration: '1 min', concentration: true },
            'Bane': { duration: '1 min', concentration: true },
            'Hunter\'s Mark': { duration: '1 hour', concentration: true },
            'Hex': { duration: '1 hour', concentration: true },
            'Faerie Fire': { duration: '1 min', concentration: true },
            'Entangle': { duration: '1 min', concentration: true },
            'Shield of Faith': { duration: '10 min', concentration: true },
            'Heroism': { duration: '1 min', concentration: true },
            'Compelled Duel': { duration: '1 min', concentration: true },
            'Ensnaring Strike': { duration: '1 min', concentration: true },
            'Hail of Thorns': { duration: '1 min', concentration: true },
            'Witch Bolt': { duration: '1 min', concentration: true },
            'Fog Cloud': { duration: '1 hour', concentration: true },
            // Level 2 Rituals
            'Animal Messenger': { ritual: true, duration: '24 hours' },
            'Augury': { ritual: true, duration: 'Instant' },
            'Beast Sense': { ritual: true, duration: '1 hour', concentration: true },
            'Gentle Repose': { ritual: true, duration: '10 days' },
            'Locate Animals or Plants': { ritual: true, duration: 'Instant' },
            'Magic Mouth': { ritual: true, duration: 'Until dispelled' },
            'Silence': { ritual: true, duration: '10 min', concentration: true },
            // Level 2 Concentration
            'Hold Person': { duration: '1 min', concentration: true },
            'Invisibility': { duration: '1 hour', concentration: true },
            'Blur': { duration: '1 min', concentration: true },
            'Darkness': { duration: '10 min', concentration: true },
            'Darkvision': { duration: '8 hours' },
            'Detect Thoughts': { duration: '1 min', concentration: true },
            'Enhance Ability': { duration: '1 hour', concentration: true },
            'Enlarge/Reduce': { duration: '1 min', concentration: true },
            'Flaming Sphere': { duration: '1 min', concentration: true },
            'Heat Metal': { duration: '1 min', concentration: true },
            'Levitate': { duration: '10 min', concentration: true },
            'Moonbeam': { duration: '1 min', concentration: true },
            'Pass without Trace': { duration: '1 hour', concentration: true },
            'Phantasmal Force': { duration: '1 min', concentration: true },
            'Spider Climb': { duration: '1 hour', concentration: true },
            'Spike Growth': { duration: '10 min', concentration: true },
            'Spiritual Weapon': { duration: '1 min' },
            'Warding Bond': { duration: '1 hour' },
            'Barkskin': { duration: '1 hour', concentration: true },
            // Level 3 Rituals
            'Feign Death': { ritual: true, duration: '1 hour' },
            'Leomund\'s Tiny Hut': { ritual: true, duration: '8 hours' },
            'Meld into Stone': { ritual: true, duration: '8 hours' },
            'Phantom Steed': { ritual: true, duration: '1 hour' },
            'Speak with Dead': { ritual: true, duration: '10 min' },
            'Water Breathing': { ritual: true, duration: '24 hours' },
            'Water Walk': { ritual: true, duration: '1 hour' },
            // Level 3 Concentration
            'Call Lightning': { duration: '10 min', concentration: true },
            'Conjure Animals': { duration: '1 hour', concentration: true },
            'Crusader\'s Mantle': { duration: '1 min', concentration: true },
            'Fly': { duration: '10 min', concentration: true },
            'Haste': { duration: '1 min', concentration: true },
            'Hypnotic Pattern': { duration: '1 min', concentration: true },
            'Major Image': { duration: '10 min', concentration: true },
            'Protection from Energy': { duration: '1 hour', concentration: true },
            'Sleet Storm': { duration: '1 min', concentration: true },
            'Slow': { duration: '1 min', concentration: true },
            'Spirit Guardians': { duration: '10 min', concentration: true },
            'Stinking Cloud': { duration: '1 min', concentration: true },
            'Vampiric Touch': { duration: '1 min', concentration: true },
            // Level 4 Rituals
            'Divination': { ritual: true, duration: 'Instant' },
            // Level 4 Concentration
            'Banishment': { duration: '1 min', concentration: true },
            'Blight': { duration: 'Instant' },
            'Compulsion': { duration: '1 min', concentration: true },
            'Confusion': { duration: '1 min', concentration: true },
            'Conjure Minor Elementals': { duration: '1 hour', concentration: true },
            'Conjure Woodland Beings': { duration: '1 hour', concentration: true },
            'Dominate Beast': { duration: '1 min', concentration: true },
            'Giant Insect': { duration: '10 min', concentration: true },
            'Greater Invisibility': { duration: '1 min', concentration: true },
            'Polymorph': { duration: '1 hour', concentration: true },
            'Stoneskin': { duration: '1 hour', concentration: true },
            // Level 5 Rituals
            'Commune': { ritual: true, duration: '1 min' },
            'Commune with Nature': { ritual: true, duration: 'Instant' },
            'Contact Other Plane': { ritual: true, duration: '1 min' },
            'Rary\'s Telepathic Bond': { ritual: true, duration: '1 hour' },
            // Level 5 Concentration
            'Conjure Elemental': { duration: '1 hour', concentration: true },
            'Dominate Person': { duration: '1 min', concentration: true },
            'Hold Monster': { duration: '1 min', concentration: true },
            'Telekinesis': { duration: '10 min', concentration: true },
            'Wall of Force': { duration: '10 min', concentration: true },
            'Wall of Stone': { duration: '10 min', concentration: true },
            // Level 6 Rituals
            'Drawmij\'s Instant Summons': { ritual: true, duration: 'Until used' },
            'Forbiddance': { ritual: true, duration: '1 day' },
            // Concentration spells (non-ritual)
            'Bless': { duration: '1 min', concentration: true },
            'Bane': { duration: '1 min', concentration: true },
            'Hunter\'s Mark': { duration: '1 hour', concentration: true },
            'Hex': { duration: '1 hour', concentration: true },
            'Hold Person': { duration: '1 min', concentration: true },
            'Invisibility': { duration: '1 hour', concentration: true },
            'Faerie Fire': { duration: '1 min', concentration: true },
            'Entangle': { duration: '1 min', concentration: true }
        };

        // Full spell descriptions for modal
        const SPELL_DESCRIPTIONS = {
            // Cantrips
            'Druidcraft': { level: 'Cantrip', school: 'Transmutation', time: '1 action', range: '30 feet', components: 'V, S', duration: 'Instantaneous', desc: 'Whispering to the spirits of nature, you create one of the following effects within range: Create a tiny, harmless sensory effect that predicts weather for the next 24 hours. Make a flower blossom, a seed pod open, or a leaf bud bloom. Create an instantaneous, harmless sensory effect, such as falling leaves, a puff of wind, the sound of a small animal, or the faint odor of skunk. Instantly light or snuff out a candle, torch, or small campfire.' },
            'Produce Flame': { level: 'Cantrip', school: 'Conjuration', time: '1 action', range: 'Self', components: 'V, S', duration: '10 minutes', desc: 'A flickering flame appears in your hand. The flame remains for the duration and harms neither you nor your equipment. The flame sheds bright light in a 10-foot radius and dim light for an additional 10 feet. The spell ends if you dismiss it or cast it again. You can also attack with the flame. Make a ranged spell attack. On a hit, the target takes 1d8 fire damage. The spell\'s damage increases by 1d8 when you reach 5th level (2d8), 11th level (3d8), and 17th level (4d8).' },
            'Guidance': { level: 'Cantrip', school: 'Divination', time: '1 action', range: 'Touch', components: 'V, S', duration: 'Concentration, up to 1 minute', desc: 'You touch one willing creature. Once before the spell ends, the target can roll a d4 and add the number rolled to one ability check of its choice. It can roll the die before or after making the ability check. The spell then ends.' },
            'Thorn Whip': { level: 'Cantrip', school: 'Transmutation', time: '1 action', range: '30 feet', components: 'V, S, M (stem of a plant with thorns)', duration: 'Instantaneous', desc: 'You create a long, vine-like whip covered in thorns that lashes out at your command toward a creature in range. Make a melee spell attack against the target. If the attack hits, the creature takes 1d6 piercing damage, and if the creature is Large or smaller, you pull the creature up to 10 feet closer to you. The spell\'s damage increases by 1d6 when you reach 5th level (2d6), 11th level (3d6), and 17th level (4d6).' },

            // Level 1
            'Cure Wounds': { level: '1st', school: 'Evocation', time: '1 action', range: 'Touch', components: 'V, S', duration: 'Instantaneous', desc: 'A creature you touch regains a number of hit points equal to 1d8 + your spellcasting ability modifier. This spell has no effect on undead or constructs.', higher: 'When you cast this spell using a spell slot of 2nd level or higher, the healing increases by 1d8 for each slot level above 1st.' },
            'Healing Word': { level: '1st', school: 'Evocation', time: '1 bonus action', range: '60 feet', components: 'V', duration: 'Instantaneous', desc: 'A creature of your choice that you can see within range regains hit points equal to 1d4 + your spellcasting ability modifier. This spell has no effect on undead or constructs.', higher: 'When you cast this spell using a spell slot of 2nd level or higher, the healing increases by 1d4 for each slot level above 1st.' },
            'Entangle': { level: '1st', school: 'Conjuration', time: '1 action', range: '90 feet', components: 'V, S', duration: 'Concentration, up to 1 minute', concentration: true, desc: 'Grasping weeds and vines sprout from the ground in a 20-foot square starting from a point within range. For the duration, these plants turn the ground in the area into difficult terrain. A creature in the area when you cast the spell must succeed on a Strength saving throw or be restrained by the entangling plants until the spell ends. A creature restrained by the plants can use its action to make a Strength check against your spell save DC. On a success, it frees itself.' },
            'Faerie Fire': { level: '1st', school: 'Evocation', time: '1 action', range: '60 feet', components: 'V', duration: 'Concentration, up to 1 minute', concentration: true, desc: 'Each object in a 20-foot cube within range is outlined in blue, green, or violet light (your choice). Any creature in the area when the spell is cast is also outlined if it fails a Dexterity saving throw. For the duration, objects and affected creatures shed dim light in a 10-foot radius. Any attack roll against an affected creature or object has advantage if the attacker can see it, and the affected creature or object can\'t benefit from being invisible.' },
            'Goodberry': { level: '1st', school: 'Transmutation', time: '1 action', range: 'Touch', components: 'V, S, M (sprig of mistletoe)', duration: 'Instantaneous', desc: 'Up to ten berries appear in your hand and are infused with magic for the duration. A creature can use its action to eat one berry. Eating a berry restores 1 hit point, and the berry provides enough nourishment to sustain a creature for one day. The berries lose their potency if they have not been consumed within 24 hours of the casting of this spell.' },
            'Thunderwave': { level: '1st', school: 'Evocation', time: '1 action', range: 'Self (15-foot cube)', components: 'V, S', duration: 'Instantaneous', desc: 'A wave of thunderous force sweeps out from you. Each creature in a 15-foot cube originating from you must make a Constitution saving throw. On a failed save, a creature takes 2d8 thunder damage and is pushed 10 feet away from you. On a successful save, the creature takes half as much damage and isn\'t pushed.', higher: 'When you cast this spell using a spell slot of 2nd level or higher, the damage increases by 1d8 for each slot level above 1st.' },
            'Detect Magic': { level: '1st', school: 'Divination', time: '1 action', range: 'Self', components: 'V, S', duration: 'Concentration, up to 10 minutes', ritual: true, concentration: true, desc: 'For the duration, you sense the presence of magic within 30 feet of you. If you sense magic in this way, you can use your action to see a faint aura around any visible creature or object in the area that bears magic, and you learn its school of magic, if any.' },
            'Speak with Animals': { level: '1st', school: 'Divination', time: '1 action', range: 'Self', components: 'V, S', duration: '10 minutes', ritual: true, desc: 'You gain the ability to comprehend and verbally communicate with beasts for the duration. The knowledge and awareness of many beasts is limited by their intelligence, but at minimum, beasts can give you information about nearby locations and monsters, including whatever they can perceive or have perceived within the past day.' },
            'Guiding Bolt': { level: '1st', school: 'Evocation', time: '1 action', range: '120 feet', components: 'V, S', duration: 'Instantaneous', desc: 'A flash of light streaks toward a creature of your choice within range. Make a ranged spell attack against the target. On a hit, the target takes 4d6 radiant damage, and the next attack roll made against this target before the end of your next turn has advantage.', higher: 'When you cast this spell using a spell slot of 2nd level or higher, the damage increases by 1d6 for each slot level above 1st.' },
            'Animal Friendship': { level: '1st', school: 'Enchantment', time: '1 action', range: '30 feet', components: 'V, S, M (a morsel of food)', duration: '24 hours', desc: 'This spell lets you convince a beast that you mean it no harm. Choose a beast that you can see within range. It must see and hear you. If the beast\'s Intelligence is 4 or higher, the spell fails. Otherwise, the beast must succeed on a Wisdom saving throw or be charmed by you for the spell\'s duration. If you or one of your companions harms the target, the spell ends.', higher: 'When you cast this spell using a spell slot of 2nd level or higher, you can affect one additional beast for each slot level above 1st.' },
            'Charm Person': { level: '1st', school: 'Enchantment', time: '1 action', range: '30 feet', components: 'V, S', duration: '1 hour', desc: 'You attempt to charm a humanoid you can see within range. It must make a Wisdom saving throw, and does so with advantage if you or your companions are fighting it. If it fails the saving throw, it is charmed by you until the spell ends or until you or your companions do anything harmful to it. The charmed creature regards you as a friendly acquaintance. When the spell ends, the creature knows it was charmed by you.', higher: 'When you cast this spell using a spell slot of 2nd level or higher, you can target one additional creature for each slot level above 1st.' },
            'Create or Destroy Water': { level: '1st', school: 'Transmutation', time: '1 action', range: '30 feet', components: 'V, S, M (a drop of water if creating water or a few grains of sand if destroying it)', duration: 'Instantaneous', desc: 'You either create or destroy water. Create Water: You create up to 10 gallons of clean water within range in an open container. Alternatively, the water falls as rain in a 30-foot cube within range. Destroy Water: You destroy up to 10 gallons of water in an open container within range. Alternatively, you destroy fog in a 30-foot cube within range.', higher: 'When you cast this spell using a spell slot of 2nd level or higher, you create or destroy 10 additional gallons of water, or the size of the cube increases by 5 feet, for each slot level above 1st.' },
            'Detect Poison and Disease': { level: '1st', school: 'Divination', time: '1 action', range: 'Self', components: 'V, S, M (a yew leaf)', duration: 'Concentration, up to 10 minutes', ritual: true, concentration: true, desc: 'For the duration, you can sense the presence and location of poisons, poisonous creatures, and diseases within 30 feet of you. You also identify the kind of poison, poisonous creature, or disease in each case.' },
            'Fog Cloud': { level: '1st', school: 'Conjuration', time: '1 action', range: '120 feet', components: 'V, S', duration: 'Concentration, up to 1 hour', concentration: true, desc: 'You create a 20-foot-radius sphere of fog centered on a point within range. The sphere spreads around corners, and its area is heavily obscured. It lasts for the duration or until a wind of moderate or greater speed (at least 10 miles per hour) disperses it.', higher: 'When you cast this spell using a spell slot of 2nd level or higher, the radius of the fog increases by 20 feet for each slot level above 1st.' },
            'Jump': { level: '1st', school: 'Transmutation', time: '1 action', range: 'Touch', components: 'V, S, M (a grasshopper\'s hind leg)', duration: '1 minute', desc: 'You touch a creature. The creature\'s jump distance is tripled until the spell ends.' },
            'Longstrider': { level: '1st', school: 'Transmutation', time: '1 action', range: 'Touch', components: 'V, S, M (a pinch of dirt)', duration: '1 hour', desc: 'You touch a creature. The target\'s speed increases by 10 feet until the spell ends.', higher: 'When you cast this spell using a spell slot of 2nd level or higher, you can target one additional creature for each slot level above 1st.' },
            'Purify Food and Drink': { level: '1st', school: 'Transmutation', time: '1 action', range: '10 feet', components: 'V, S', duration: 'Instantaneous', ritual: true, desc: 'All nonmagical food and drink within a 5-foot-radius sphere centered on a point of your choice within range is purified and rendered free of poison and disease.' },

            // Level 2
            'Moonbeam': { level: '2nd', school: 'Evocation', time: '1 action', range: '120 feet', components: 'V, S, M (several seeds of any moonseed plant and a piece of opalescent feldspar)', duration: 'Concentration, up to 1 minute', concentration: true, desc: 'A silvery beam of pale light shines down in a 5-foot-radius, 40-foot-high cylinder centered on a point within range. Until the spell ends, dim light fills the cylinder. When a creature enters the spell\'s area for the first time on a turn or starts its turn there, it is engulfed in ghostly flames that cause searing pain, and it must make a Constitution saving throw. It takes 2d10 radiant damage on a failed save, or half as much damage on a successful one. A shapechanger makes its saving throw with disadvantage. On each of your turns after you cast this spell, you can use an action to move the beam up to 60 feet in any direction.', higher: 'When you cast this spell using a spell slot of 3rd level or higher, the damage increases by 1d10 for each slot level above 2nd.' },
            'Barkskin': { level: '2nd', school: 'Transmutation', time: '1 action', range: 'Touch', components: 'V, S, M (handful of oak bark)', duration: 'Concentration, up to 1 hour', concentration: true, desc: 'You touch a willing creature. Until the spell ends, the target\'s skin has a rough, bark-like appearance, and the target\'s AC can\'t be less than 16, regardless of what kind of armor it is wearing.' },
            'Hold Person': { level: '2nd', school: 'Enchantment', time: '1 action', range: '60 feet', components: 'V, S, M (small, straight piece of iron)', duration: 'Concentration, up to 1 minute', concentration: true, desc: 'Choose a humanoid that you can see within range. The target must succeed on a Wisdom saving throw or be paralyzed for the duration. At the end of each of its turns, the target can make another Wisdom saving throw. On a success, the spell ends on the target.', higher: 'When you cast this spell using a spell slot of 3rd level or higher, you can target one additional humanoid for each slot level above 2nd.' },
            'Pass without Trace': { level: '2nd', school: 'Abjuration', time: '1 action', range: 'Self', components: 'V, S, M (ashes from a burned leaf of mistletoe and a sprig of spruce)', duration: 'Concentration, up to 1 hour', concentration: true, desc: 'A veil of shadows and silence radiates from you, masking you and your companions from detection. For the duration, each creature you choose within 30 feet of you (including you) has a +10 bonus to Dexterity (Stealth) checks and can\'t be tracked except by magical means.' },
            'Lesser Restoration': { level: '2nd', school: 'Abjuration', time: '1 action', range: 'Touch', components: 'V, S', duration: 'Instantaneous', desc: 'You touch a creature and can end either one disease or one condition afflicting it. The condition can be blinded, deafened, paralyzed, or poisoned.' },
            'Misty Step': { level: '2nd', school: 'Conjuration', time: '1 bonus action', range: 'Self', components: 'V', duration: 'Instantaneous', desc: 'Briefly surrounded by silvery mist, you teleport up to 30 feet to an unoccupied space that you can see.' },

            // Level 2 continued
            'Animal Messenger': { level: '2nd', school: 'Enchantment', time: '1 action', range: '30 feet', components: 'V, S, M (a morsel of food)', duration: '24 hours', ritual: true, desc: 'By means of this spell, you use an animal to deliver a message. Choose a Tiny beast you can see within range, such as a squirrel, a blue jay, or a bat. You specify a location, which you must have visited, and a recipient who matches a general description. You also speak a message of up to twenty-five words. The target beast travels for the duration of the spell toward the specified location, covering about 50 miles per 24 hours for a flying messenger, or 25 miles for other animals.' },
            'Beast Sense': { level: '2nd', school: 'Divination', time: '1 action', range: 'Touch', components: 'S', duration: 'Concentration, up to 1 hour', ritual: true, concentration: true, desc: 'You touch a willing beast. For the duration of the spell, you can use your action to see through the beast\'s eyes and hear what it hears, and continue to do so until you use your action to return to your normal senses.' },
            'Darkvision': { level: '2nd', school: 'Transmutation', time: '1 action', range: 'Touch', components: 'V, S, M (either a pinch of dried carrot or an agate)', duration: '8 hours', desc: 'You touch a willing creature to grant it the ability to see in the dark. For the duration, that creature has darkvision out to a range of 60 feet.' },
            'Enhance Ability': { level: '2nd', school: 'Transmutation', time: '1 action', range: 'Touch', components: 'V, S, M (fur or a feather from a beast)', duration: 'Concentration, up to 1 hour', concentration: true, desc: 'You touch a creature and bestow upon it a magical enhancement. Choose one of the following effects; the target gains that effect until the spell ends. Bear\'s Endurance, Bull\'s Strength, Cat\'s Grace, Eagle\'s Splendor, Fox\'s Cunning, or Owl\'s Wisdom. Each grants advantage on ability checks with the corresponding ability score, plus additional benefits.' },
            'Find Traps': { level: '2nd', school: 'Divination', time: '1 action', range: '120 feet', components: 'V, S', duration: 'Instantaneous', desc: 'You sense the presence of any trap within range that is within line of sight. A trap, for the purpose of this spell, includes anything that would inflict a sudden or unexpected effect you consider harmful or undesirable, which was specifically intended as such by its creator.' },
            'Flame Blade': { level: '2nd', school: 'Evocation', time: '1 bonus action', range: 'Self', components: 'V, S, M (leaf of sumac)', duration: 'Concentration, up to 10 minutes', concentration: true, desc: 'You evoke a fiery blade in your free hand. The blade is similar in size and shape to a scimitar, and it lasts for the duration. You can use your action to make a melee spell attack with the fiery blade. On a hit, the target takes 3d6 fire damage. The blade sheds bright light in a 10-foot radius and dim light for an additional 10 feet.', higher: 'When you cast this spell using a spell slot of 4th level or higher, the damage increases by 1d6 for every two slot levels above 2nd.' },
            'Flaming Sphere': { level: '2nd', school: 'Conjuration', time: '1 action', range: '60 feet', components: 'V, S, M (a bit of tallow, a pinch of brimstone, and a dusting of powdered iron)', duration: 'Concentration, up to 1 minute', concentration: true, desc: 'A 5-foot-diameter sphere of fire appears in an unoccupied space of your choice within range and lasts for the duration. Any creature that ends its turn within 5 feet of the sphere must make a Dexterity saving throw. The creature takes 2d6 fire damage on a failed save, or half as much damage on a successful one. As a bonus action, you can move the sphere up to 30 feet.', higher: 'When you cast this spell using a spell slot of 3rd level or higher, the damage increases by 1d6 for each slot level above 2nd.' },
            'Gust of Wind': { level: '2nd', school: 'Evocation', time: '1 action', range: 'Self (60-foot line)', components: 'V, S, M (a legume seed)', duration: 'Concentration, up to 1 minute', concentration: true, desc: 'A line of strong wind 60 feet long and 10 feet wide blasts from you in a direction you choose for the spell\'s duration. Each creature that starts its turn in the line must succeed on a Strength saving throw or be pushed 15 feet away from you in a direction following the line. Any creature in the line must spend 2 feet of movement for every 1 foot it moves when moving closer to you.' },
            'Heat Metal': { level: '2nd', school: 'Transmutation', time: '1 action', range: '60 feet', components: 'V, S, M (a piece of iron and a flame)', duration: 'Concentration, up to 1 minute', concentration: true, desc: 'Choose a manufactured metal object, such as a metal weapon or a suit of heavy or medium metal armor, that you can see within range. You cause the object to glow red-hot. Any creature in physical contact with the object takes 2d8 fire damage when you cast the spell. Until the spell ends, you can use a bonus action on each of your subsequent turns to cause this damage again.', higher: 'When you cast this spell using a spell slot of 3rd level or higher, the damage increases by 1d8 for each slot level above 2nd.' },
            'Locate Animals or Plants': { level: '2nd', school: 'Divination', time: '1 action', range: 'Self', components: 'V, S, M (a bit of fur from a bloodhound)', duration: 'Instantaneous', ritual: true, desc: 'Describe or name a specific kind of beast or plant. Concentrating on the voice of nature in your surroundings, you learn the direction and distance to the closest creature or plant of that kind within 5 miles, if any are present.' },
            'Locate Object': { level: '2nd', school: 'Divination', time: '1 action', range: 'Self', components: 'V, S, M (a forked twig)', duration: 'Concentration, up to 10 minutes', concentration: true, desc: 'Describe or name an object that is familiar to you. You sense the direction to the object\'s location, as long as that object is within 1,000 feet of you. If the object is in motion, you know the direction of its movement.' },
            'Protection from Poison': { level: '2nd', school: 'Abjuration', time: '1 action', range: 'Touch', components: 'V, S', duration: '1 hour', desc: 'You touch a creature. If it is poisoned, you neutralize the poison. If more than one poison afflicts the target, you neutralize one poison that you know is present, or you neutralize one at random. For the duration, the target has advantage on saving throws against being poisoned, and it has resistance to poison damage.' },
            'Spike Growth': { level: '2nd', school: 'Transmutation', time: '1 action', range: '150 feet', components: 'V, S, M (seven sharp thorns or seven small twigs, each sharpened to a point)', duration: 'Concentration, up to 10 minutes', concentration: true, desc: 'The ground in a 20-foot radius centered on a point within range twists and sprouts hard spikes and thorns. The area becomes difficult terrain for the duration. When a creature moves into or within the area, it takes 2d4 piercing damage for every 5 feet it travels. The transformation of the ground is camouflaged to look natural.' },

            // Level 3
            'Call Lightning': { level: '3rd', school: 'Conjuration', time: '1 action', range: '120 feet', components: 'V, S', duration: 'Concentration, up to 10 minutes', concentration: true, desc: 'A storm cloud appears in the shape of a cylinder that is 10 feet tall with a 60-foot radius, centered on a point you can see within range directly above you. When you cast the spell, choose a point you can see under the cloud. A bolt of lightning flashes down from the cloud to that point. Each creature within 5 feet of that point must make a Dexterity saving throw. A creature takes 3d10 lightning damage on a failed save, or half as much damage on a successful one. On each of your turns until the spell ends, you can use your action to call down lightning in this way again, targeting the same point or a different one. If you are outdoors in stormy conditions, the spell deals an extra 1d10 damage.', higher: 'When you cast this spell using a spell slot of 4th level or higher, the damage increases by 1d10 for each slot level above 3rd.' },
            'Conjure Animals': { level: '3rd', school: 'Conjuration', time: '1 action', range: '60 feet', components: 'V, S', duration: 'Concentration, up to 1 hour', concentration: true, desc: 'You summon fey spirits that take the form of beasts and appear in unoccupied spaces that you can see within range. Choose one of the following options: One beast of CR 2 or lower, Two beasts of CR 1 or lower, Four beasts of CR 1/2 or lower, or Eight beasts of CR 1/4 or lower. Each beast is considered fey, and it disappears when it drops to 0 hit points or when the spell ends. The summoned creatures are friendly to you and your companions and obey your verbal commands.', higher: 'When you cast this spell using certain higher-level spell slots, you choose one of the summoning options above, and more creatures appear.' },
            'Daylight': { level: '3rd', school: 'Evocation', time: '1 action', range: '60 feet', components: 'V, S', duration: '1 hour', desc: 'A 60-foot-radius sphere of light spreads out from a point you choose within range. The sphere is bright light and sheds dim light for an additional 60 feet. If you chose a point on an object you are holding or one that isn\'t being worn or carried, the light shines from the object and moves with it.' },
            'Dispel Magic': { level: '3rd', school: 'Abjuration', time: '1 action', range: '120 feet', components: 'V, S', duration: 'Instantaneous', desc: 'Choose one creature, object, or magical effect within range. Any spell of 3rd level or lower on the target ends. For each spell of 4th level or higher on the target, make an ability check using your spellcasting ability. The DC equals 10 + the spell\'s level. On a successful check, the spell ends.', higher: 'When you cast this spell using a spell slot of 4th level or higher, you automatically end the effects of a spell on the target if the spell\'s level is equal to or less than the level of the spell slot you used.' },
            'Feign Death': { level: '3rd', school: 'Necromancy', time: '1 action', range: 'Touch', components: 'V, S, M (a pinch of graveyard dirt)', duration: '1 hour', ritual: true, desc: 'You touch a willing creature and put it into a cataleptic state that is indistinguishable from death. For the spell\'s duration, or until you use an action to touch the target and dismiss the spell, the target appears dead to all outward inspection and to spells used to determine the target\'s status.' },
            'Meld into Stone': { level: '3rd', school: 'Transmutation', time: '1 action', range: 'Touch', components: 'V, S', duration: '8 hours', ritual: true, desc: 'You step into a stone object or surface large enough to fully contain your body, melding yourself and all the equipment you carry with the stone for the duration. Nothing of your presence remains visible or otherwise detectable by nonmagical senses.' },
            'Plant Growth': { level: '3rd', school: 'Transmutation', time: '1 action or 8 hours', range: '150 feet', components: 'V, S', duration: 'Instantaneous', desc: 'If you cast this spell using 1 action, choose a point within range. All normal plants in a 100-foot radius centered on that point become thick and overgrown. A creature moving through the area must spend 4 feet of movement for every 1 foot it moves. If you cast this spell over 8 hours, you enrich the land. All plants in a half-mile radius centered on a point within range become enriched for 1 year. The plants yield twice the normal amount of food when harvested.' },
            'Protection from Energy': { level: '3rd', school: 'Abjuration', time: '1 action', range: 'Touch', components: 'V, S', duration: 'Concentration, up to 1 hour', concentration: true, desc: 'For the duration, the willing creature you touch has resistance to one damage type of your choice: acid, cold, fire, lightning, or thunder.' },
            'Sleet Storm': { level: '3rd', school: 'Conjuration', time: '1 action', range: '150 feet', components: 'V, S, M (a pinch of dust and a few drops of water)', duration: 'Concentration, up to 1 minute', concentration: true, desc: 'Until the spell ends, freezing rain and sleet fall in a 20-foot-tall cylinder with a 40-foot radius centered on a point you choose within range. The area is heavily obscured, and exposed flames in the area are doused. The ground in the area is covered with slick ice, making it difficult terrain. When a creature enters the spell\'s area for the first time on a turn or starts its turn there, it must make a Dexterity saving throw. On a failed save, it falls prone.' },
            'Speak with Plants': { level: '3rd', school: 'Transmutation', time: '1 action', range: 'Self (30-foot radius)', components: 'V, S', duration: '10 minutes', desc: 'You imbue plants within 30 feet of you with limited sentience and animation, giving them the ability to communicate with you and follow your simple commands. You can question plants about events in the spell\'s area within the past day, gaining information about creatures that have passed, weather, and other circumstances.' },
            'Water Breathing': { level: '3rd', school: 'Transmutation', time: '1 action', range: '30 feet', components: 'V, S, M (a short reed or piece of straw)', duration: '24 hours', ritual: true, desc: 'This spell grants up to ten willing creatures you can see within range the ability to breathe underwater until the spell ends. Affected creatures also retain their normal mode of respiration.' },
            'Water Walk': { level: '3rd', school: 'Transmutation', time: '1 action', range: '30 feet', components: 'V, S, M (a piece of cork)', duration: '1 hour', ritual: true, desc: 'This spell grants the ability to move across any liquid surfacesuch as water, acid, mud, snow, quicksand, or lavaas if it were harmless solid ground (creatures crossing molten lava can still take damage from the heat). Up to ten willing creatures you can see within range gain this ability for the duration.' },
            'Wind Wall': { level: '3rd', school: 'Evocation', time: '1 action', range: '120 feet', components: 'V, S, M (a tiny fan and a feather of exotic origin)', duration: 'Concentration, up to 1 minute', concentration: true, desc: 'A wall of strong wind rises from the ground at a point you choose within range. You can make the wall up to 50 feet long, 15 feet high, and 1 foot thick. The wall lasts for the duration. When the wall appears, each creature within its area must make a Strength saving throw. A creature takes 3d8 bludgeoning damage on a failed save, or half as much damage on a successful one. The strong wind keeps fog, smoke, and other gases at bay.' },

            // Level 4
            'Blight': { level: '4th', school: 'Necromancy', time: '1 action', range: '30 feet', components: 'V, S', duration: 'Instantaneous', desc: 'Necromantic energy washes over a creature of your choice that you can see within range, draining moisture and vitality from it. The target must make a Constitution saving throw. The target takes 8d8 necrotic damage on a failed save, or half as much damage on a successful one. This spell has no effect on undead or constructs. If you target a plant creature or a magical plant, it makes the saving throw with disadvantage, and the spell deals maximum damage to it. If you target a nonmagical plant that isn\'t a creature, such as a tree or shrub, it doesn\'t make a saving throw; it simply withers and dies.', higher: 'When you cast this spell using a spell slot of 5th level or higher, the damage increases by 1d8 for each slot level above 4th.' },
            'Conjure Minor Elementals': { level: '4th', school: 'Conjuration', time: '1 minute', range: '90 feet', components: 'V, S', duration: 'Concentration, up to 1 hour', concentration: true, desc: 'You summon elementals that appear in unoccupied spaces that you can see within range. Choose one of the following options: One elemental of CR 2 or lower, Two elementals of CR 1 or lower, Four elementals of CR 1/2 or lower, or Eight elementals of CR 1/4 or lower. An elemental summoned by this spell disappears when it drops to 0 hit points or when the spell ends. The summoned creatures are friendly to you and your companions.' },
            'Conjure Woodland Beings': { level: '4th', school: 'Conjuration', time: '1 action', range: '60 feet', components: 'V, S, M (one holly berry per creature summoned)', duration: 'Concentration, up to 1 hour', concentration: true, desc: 'You summon fey creatures that appear in unoccupied spaces that you can see within range. Choose one of the following options: One fey creature of CR 2 or lower, Two fey creatures of CR 1 or lower, Four fey creatures of CR 1/2 or lower, or Eight fey creatures of CR 1/4 or lower. The summoned creatures are friendly to you and your companions.' },
            'Dominate Beast': { level: '4th', school: 'Enchantment', time: '1 action', range: '60 feet', components: 'V, S', duration: 'Concentration, up to 1 minute', concentration: true, desc: 'You attempt to beguile a beast that you can see within range. It must succeed on a Wisdom saving throw or be charmed by you for the duration. If you or creatures that are friendly to you are fighting it, it has advantage on the saving throw. While the beast is charmed, you have a telepathic link with it as long as the two of you are on the same plane of existence. You can use this telepathic link to issue commands to the creature while you are conscious.' },
            'Freedom of Movement': { level: '4th', school: 'Abjuration', time: '1 action', range: 'Touch', components: 'V, S, M (leather strap, bound around the arm or similar appendage)', duration: '1 hour', desc: 'You touch a willing creature. For the duration, the target\'s movement is unaffected by difficult terrain, and spells and other magical effects can neither reduce the target\'s speed nor cause the target to be paralyzed or restrained. The target can also spend 5 feet of movement to automatically escape from nonmagical restraints.' },
            'Giant Insect': { level: '4th', school: 'Transmutation', time: '1 action', range: '30 feet', components: 'V, S', duration: 'Concentration, up to 10 minutes', concentration: true, desc: 'You transform up to ten centipedes, three spiders, five wasps, or one scorpion within range into giant versions of their natural forms for the duration. The creatures are friendly to you and your companions and obey your verbal commands.' },
            'Grasping Vine': { level: '4th', school: 'Conjuration', time: '1 bonus action', range: '30 feet', components: 'V, S', duration: 'Concentration, up to 1 minute', concentration: true, desc: 'You conjure a vine that sprouts from the ground in an unoccupied space of your choice that you can see within range. When you cast this spell, you can direct the vine to lash out at a creature within 30 feet of it. The creature must succeed on a Dexterity saving throw or be pulled 20 feet directly toward the vine. As a bonus action on each of your turns, you can direct the vine to lash out at the same creature or a different one.' },
            'Guardian of Nature': { level: '4th', school: 'Transmutation', time: '1 bonus action', range: 'Self', components: 'V', duration: 'Concentration, up to 1 minute', concentration: true, desc: 'A nature spirit answers your call and transforms you into a powerful guardian. The transformation lasts until the spell ends. You choose one of the following forms to assume: Primal Beast or Great Tree.' },
            'Ice Storm': { level: '4th', school: 'Evocation', time: '1 action', range: '300 feet', components: 'V, S, M (a pinch of dust and a few drops of water)', duration: 'Instantaneous', desc: 'A hail of rock-hard ice pounds to the ground in a 20-foot-radius, 40-foot-high cylinder centered on a point within range. Each creature in the cylinder must make a Dexterity saving throw. A creature takes 2d8 bludgeoning damage and 4d6 cold damage on a failed save, or half as much damage on a successful one. Hailstones turn the storm\'s area of effect into difficult terrain until the end of your next turn.', higher: 'When you cast this spell using a spell slot of 5th level or higher, the bludgeoning damage increases by 1d8 for each slot level above 4th.' },
            'Confusion': { level: '4th', school: 'Enchantment', time: '1 action', range: '90 feet', components: 'V, S, M (three nut shells)', duration: 'Concentration, up to 1 minute', concentration: true, desc: 'This spell assaults and twists creatures\' minds, spawning delusions and provoking uncontrolled action. Each creature in a 10-foot-radius sphere centered on a point you choose within range must succeed on a Wisdom saving throw when you cast this spell or be affected by it. An affected target can\'t take reactions and must roll a d10 at the start of each of its turns to determine its behavior for that turn.', higher: 'When you cast this spell using a spell slot of 5th level or higher, the radius of the sphere increases by 5 feet for each slot level above 4th.' },
            'Control Water': { level: '4th', school: 'Transmutation', time: '1 action', range: '300 feet', components: 'V, S, M (a drop of water and a pinch of dust)', duration: 'Concentration, up to 10 minutes', concentration: true, desc: 'Until the spell ends, you control any freestanding water inside an area you choose that is a cube up to 100 feet on a side. You can choose from any of the following effects when you cast this spell. As an action on your turn, you can repeat the same effect or choose a different one: Flood, Part Water, Redirect Flow, or Whirlpool.' },
            'Hallucinatory Terrain': { level: '4th', school: 'Illusion', time: '10 minutes', range: '300 feet', components: 'V, S, M (a stone, a twig, and a bit of green plant)', duration: '24 hours', desc: 'You make natural terrain in a 150-foot cube in range look, sound, and smell like some other sort of natural terrain. Thus, open fields or a road can be made to resemble a swamp, hill, crevasse, or some other difficult or impassable terrain. A pond can be made to seem like a grassy meadow, a precipice like a gentle slope, or a rock-strewn gully like a wide and smooth road.' },
            'Locate Creature': { level: '4th', school: 'Divination', time: '1 action', range: 'Self', components: 'V, S, M (a bit of fur from a bloodhound)', duration: 'Concentration, up to 1 hour', concentration: true, desc: 'Describe or name a creature that is familiar to you. You sense the direction to the creature\'s location, as long as that creature is within 1,000 feet of you. If the creature is moving, you know the direction of its movement. The spell can locate a specific creature known to you, or the nearest creature of a specific kind, as long as you have seen such a creature up closewithin 30 feetat least once.' },
            'Polymorph': { level: '4th', school: 'Transmutation', time: '1 action', range: '60 feet', components: 'V, S, M (a caterpillar cocoon)', duration: 'Concentration, up to 1 hour', concentration: true, desc: 'This spell transforms a creature that you can see within range into a new form. An unwilling creature must make a Wisdom saving throw to avoid the effect. The transformation lasts for the duration, or until the target drops to 0 hit points or dies. The new form can be any beast whose CR is equal to or less than the target\'s (or the target\'s level, if it doesn\'t have a CR).' },
            'Stone Shape': { level: '4th', school: 'Transmutation', time: '1 action', range: 'Touch', components: 'V, S, M (soft clay, to be crudely worked into the desired shape)', duration: 'Instantaneous', desc: 'You touch a stone object of Medium size or smaller or a section of stone no more than 5 feet in any dimension and form it into any shape that suits your purpose.' },
            'Stoneskin': { level: '4th', school: 'Abjuration', time: '1 action', range: 'Touch', components: 'V, S, M (diamond dust worth 100 gp, which the spell consumes)', duration: 'Concentration, up to 1 hour', concentration: true, desc: 'This spell turns the flesh of a willing creature you touch as hard as stone. Until the spell ends, the target has resistance to nonmagical bludgeoning, piercing, and slashing damage.' },
            'Wall of Fire': { level: '4th', school: 'Evocation', time: '1 action', range: '120 feet', components: 'V, S, M (a small piece of phosphorus)', duration: 'Concentration, up to 1 minute', concentration: true, desc: 'You create a wall of fire on a solid surface within range. You can make the wall up to 60 feet long, 20 feet high, and 1 foot thick, or a ringed wall up to 20 feet in diameter, 20 feet high, and 1 foot thick. The wall is opaque and lasts for the duration. When the wall appears, each creature within its area must make a Dexterity saving throw. On a failed save, a creature takes 5d8 fire damage, or half as much damage on a successful save. One side of the wall, selected by you when you cast this spell, deals 5d8 fire damage to each creature that ends its turn within 10 feet of that side or inside the wall. A creature takes the same damage when it enters the wall for the first time on a turn or ends its turn there.', higher: 'When you cast this spell using a spell slot of 5th level or higher, the damage increases by 1d8 for each slot level above 4th.' },

            // Level 5
            'Antilife Shell': { level: '5th', school: 'Abjuration', time: '1 action', range: 'Self (10-foot radius)', components: 'V, S', duration: 'Concentration, up to 1 hour', concentration: true, desc: 'A shimmering barrier extends out from you in a 10-foot radius and moves with you, remaining centered on you and hedging out creatures other than undead and constructs. The barrier lasts for the duration. The barrier prevents an affected creature from passing or reaching through. An affected creature can cast spells or make attacks with ranged or reach weapons through the barrier.' },
            'Awaken': { level: '5th', school: 'Transmutation', time: '8 hours', range: 'Touch', components: 'V, S, M (an agate worth at least 1,000 gp, which the spell consumes)', duration: 'Instantaneous', desc: 'After spending the casting time tracing magical pathways within a precious gemstone, you touch a Huge or smaller beast or plant. The target must have either no Intelligence score or an Intelligence of 3 or less. The target gains an Intelligence of 10. The target also gains the ability to speak one language you know. The awakened beast or plant is charmed by you for 30 days or until you or your companions do anything harmful to it.' },
            'Commune with Nature': { level: '5th', school: 'Divination', time: '1 minute', range: 'Self', components: 'V, S', duration: 'Instantaneous', ritual: true, desc: 'You briefly become one with nature and gain knowledge of the surrounding territory. In the outdoors, the spell gives you knowledge of the land within 3 miles of you. In caves and other natural underground settings, the radius is limited to 300 feet. The spell doesn\'t function where nature has been replaced by construction, such as in dungeons and towns.' },
            'Cone of Cold': { level: '5th', school: 'Evocation', time: '1 action', range: 'Self (60-foot cone)', components: 'V, S, M (a small crystal or glass cone)', duration: 'Instantaneous', desc: 'A blast of cold air erupts from your hands. Each creature in a 60-foot cone must make a Constitution saving throw. A creature takes 8d8 cold damage on a failed save, or half as much damage on a successful one. A creature killed by this spell becomes a frozen statue until it thaws.', higher: 'When you cast this spell using a spell slot of 6th level or higher, the damage increases by 1d8 for each slot level above 5th.' },
            'Conjure Elemental': { level: '5th', school: 'Conjuration', time: '1 minute', range: '90 feet', components: 'V, S, M (burning incense for air, soft clay for earth, sulfur and phosphorus for fire, or water and sand for water)', duration: 'Concentration, up to 1 hour', concentration: true, desc: 'You call forth an elemental servant. Choose an area of air, earth, fire, or water that fills a 10-foot cube within range. An elemental of CR 5 or lower appropriate to the area you chose appears in an unoccupied space within 10 feet of it. The elemental disappears when it drops to 0 hit points or when the spell ends. The elemental is friendly to you and your companions for the duration.' },
            'Contagion': { level: '5th', school: 'Necromancy', time: '1 action', range: 'Touch', components: 'V, S', duration: '7 days', desc: 'Your touch inflicts disease. Make a melee spell attack against a creature within your reach. On a hit, the target is poisoned. At the end of each of the poisoned target\'s turns, the target must make a Constitution saving throw. If the target succeeds on three of these saves, it is no longer poisoned, and the spell ends. If the target fails three of these saves, the target is no longer poisoned, but choose one of the diseases described below. The target is subjected to the chosen disease for the spell\'s duration.' },
            'Geas': { level: '5th', school: 'Enchantment', time: '1 minute', range: '60 feet', components: 'V', duration: '30 days', desc: 'You place a magical command on a creature that you can see within range, forcing it to carry out some service or refrain from some action or course of activity as you decide. If the creature can understand you, it must succeed on a Wisdom saving throw or become charmed by you for the duration. While the creature is charmed by you, it takes 5d10 psychic damage each time it acts in a manner directly counter to your instructions.' },
            'Greater Restoration': { level: '5th', school: 'Abjuration', time: '1 action', range: 'Touch', components: 'V, S, M (diamond dust worth at least 100 gp, which the spell consumes)', duration: 'Instantaneous', desc: 'You imbue a creature you touch with positive energy to undo a debilitating effect. You can reduce the target\'s exhaustion level by one, or end one of the following effects on the target: One effect that charmed or petrified the target, One curse, including the target\'s attunement to a cursed magic item, Any reduction to one of the target\'s ability scores, or One effect reducing the target\'s hit point maximum.' },
            'Insect Plague': { level: '5th', school: 'Conjuration', time: '1 action', range: '300 feet', components: 'V, S, M (a few grains of sugar, some kernels of grain, and a smear of fat)', duration: 'Concentration, up to 10 minutes', concentration: true, desc: 'Swarming, biting locusts fill a 20-foot-radius sphere centered on a point you choose within range. The sphere spreads around corners. The sphere remains for the duration, and its area is lightly obscured. The sphere\'s area is difficult terrain. When the area appears, each creature in it must make a Constitution saving throw. A creature takes 4d10 piercing damage on a failed save, or half as much damage on a successful one. A creature must also make this saving throw when it enters the spell\'s area for the first time on a turn or ends its turn there.', higher: 'When you cast this spell using a spell slot of 6th level or higher, the damage increases by 1d10 for each slot level above 5th.' },
            'Mass Cure Wounds': { level: '5th', school: 'Evocation', time: '1 action', range: '60 feet', components: 'V, S', duration: 'Instantaneous', desc: 'A wave of healing energy washes out from a point of your choice within range. Choose up to six creatures in a 30-foot-radius sphere centered on that point. Each target regains hit points equal to 3d8 + your spellcasting ability modifier. This spell has no effect on undead or constructs.', higher: 'When you cast this spell using a spell slot of 6th level or higher, the healing increases by 1d8 for each slot level above 5th.' },
            'Planar Binding': { level: '5th', school: 'Abjuration', time: '1 hour', range: '60 feet', components: 'V, S, M (a jewel worth at least 1,000 gp, which the spell consumes)', duration: '24 hours', desc: 'With this spell, you attempt to bind a celestial, an elemental, a fey, or a fiend to your service. The creature must be within range for the entire casting of the spell. At the completion of the casting, the target must make a Charisma saving throw. On a failed save, it is bound to serve you for the duration. A bound creature must follow your instructions to the best of its ability.', higher: 'When you cast this spell using a spell slot of a higher level, the duration increases to 10 days with a 6th-level slot, to 30 days with a 7th-level slot, to 180 days with an 8th-level slot, and to a year and a day with a 9th-level spell slot.' },
            'Reincarnate': { level: '5th', school: 'Transmutation', time: '1 hour', range: 'Touch', components: 'V, S, M (rare oils and unguents worth at least 1,000 gp, which the spell consumes)', duration: 'Instantaneous', desc: 'You touch a dead humanoid or a piece of a dead humanoid. Provided that the creature has been dead no longer than 10 days, the spell forms a new adult body for it and then calls the soul to enter that body. If the target\'s soul isn\'t free or willing to do so, the spell fails. The DM rolls on the Reincarnate table to determine what form the creature takes when restored to life, or the DM chooses a form.' },
            'Scrying': { level: '5th', school: 'Divination', time: '10 minutes', range: 'Self', components: 'V, S, M (a focus worth at least 1,000 gp, such as a crystal ball, a silver mirror, or a font filled with holy water)', duration: 'Concentration, up to 10 minutes', concentration: true, desc: 'You can see and hear a particular creature you choose that is on the same plane of existence as you. The target must make a Wisdom saving throw, which is modified by how well you know the target and the sort of physical connection you have to it. If a target knows you\'re casting this spell, it can fail the saving throw voluntarily if it wants to be observed.' },
            'Tree Stride': { level: '5th', school: 'Conjuration', time: '1 action', range: 'Self', components: 'V, S', duration: 'Concentration, up to 1 minute', concentration: true, desc: 'You gain the ability to enter a tree and move from inside it to inside another tree of the same kind within 500 feet. Both trees must be living and at least the same size as you. You must use 5 feet of movement to enter a tree. You instantly know the location of all other trees of the same kind within 500 feet and, as part of the move used to enter the tree, can either pass into one of those trees or step out of the tree you\'re in.' },
            'Wall of Stone': { level: '5th', school: 'Evocation', time: '1 action', range: '120 feet', components: 'V, S, M (a small block of granite)', duration: 'Concentration, up to 10 minutes', concentration: true, desc: 'A nonmagical wall of solid stone springs into existence at a point you choose within range. The wall is 6 inches thick and is composed of ten 10-foot-by-10-foot panels. Each panel must be contiguous with at least one other panel. If the wall cuts through a creature\'s space when it appears, the creature is pushed to one side of the wall (your choice). If a creature would be surrounded on all sides by the wall, that creature can make a Dexterity saving throw.' },

            // Wizard Cantrips
            'Fire Bolt': { level: 'Cantrip', school: 'Evocation', time: '1 action', range: '120 feet', components: 'V, S', duration: 'Instantaneous', desc: 'You hurl a mote of fire at a creature or object within range. Make a ranged spell attack against the target. On a hit, the target takes 1d10 fire damage. A flammable object hit by this spell ignites if it isn\'t being worn or carried. This spell\'s damage increases by 1d10 when you reach 5th level (2d10), 11th level (3d10), and 17th level (4d10).' },
            'Mage Hand': { level: 'Cantrip', school: 'Conjuration', time: '1 action', range: '30 feet', components: 'V, S', duration: '1 minute', desc: 'A spectral, floating hand appears at a point you choose within range. The hand lasts for the duration or until you dismiss it as an action. The hand vanishes if it is ever more than 30 feet away from you or if you cast this spell again. You can use your action to control the hand and manipulate an object, open an unlocked door or container, stow or retrieve an item from an open container, or pour the contents out of a vial. The hand can\'t attack, activate magic items, or carry more than 10 pounds.' },
            'Prestidigitation': { level: 'Cantrip', school: 'Transmutation', time: '1 action', range: '10 feet', components: 'V, S', duration: 'Up to 1 hour', desc: 'This spell is a minor magical trick that novice spellcasters use for practice. You create one of the following magical effects within range: a harmless sensory effect, light or snuff a small flame, clean or soil a small object, chill/warm/flavor nonliving material, make a small mark or symbol, or create a trinket or illusory image that fits in your hand.' },
            'Ray of Frost': { level: 'Cantrip', school: 'Evocation', time: '1 action', range: '60 feet', components: 'V, S', duration: 'Instantaneous', desc: 'A frigid beam of blue-white light streaks toward a creature within range. Make a ranged spell attack against the target. On a hit, it takes 1d8 cold damage, and its speed is reduced by 10 feet until the start of your next turn. The spell\'s damage increases by 1d8 when you reach 5th level (2d8), 11th level (3d8), and 17th level (4d8).' },
            'Shocking Grasp': { level: 'Cantrip', school: 'Evocation', time: '1 action', range: 'Touch', components: 'V, S', duration: 'Instantaneous', desc: 'Lightning springs from your hand to deliver a shock to a creature you try to touch. Make a melee spell attack against the target. You have advantage on the attack roll if the target is wearing armor made of metal. On a hit, the target takes 1d8 lightning damage, and it can\'t take reactions until the start of its next turn. The spell\'s damage increases by 1d8 when you reach 5th level (2d8), 11th level (3d8), and 17th level (4d8).' },
            'Minor Illusion': { level: 'Cantrip', school: 'Illusion', time: '1 action', range: '30 feet', components: 'S, M (a bit of fleece)', duration: '1 minute', desc: 'You create a sound or an image of an object within range that lasts for the duration. The illusion also ends if you dismiss it as an action or cast this spell again. If you create a sound, its volume can range from a whisper to a scream. If you create an image of an object, it must be no larger than a 5-foot cube. The image can\'t create sound, light, smell, or any other sensory effect. Physical interaction with the image reveals it to be an illusion.' },
            'Light': { level: 'Cantrip', school: 'Evocation', time: '1 action', range: 'Touch', components: 'V, M (a firefly or phosphorescent moss)', duration: '1 hour', desc: 'You touch one object that is no larger than 10 feet in any dimension. Until the spell ends, the object sheds bright light in a 20-foot radius and dim light for an additional 20 feet. The light can be colored as you like. Completely covering the object with something opaque blocks the light. The spell ends if you cast it again or dismiss it as an action.' },
            'Chill Touch': { level: 'Cantrip', school: 'Necromancy', time: '1 action', range: '120 feet', components: 'V, S', duration: '1 round', desc: 'You create a ghostly, skeletal hand in the space of a creature within range. Make a ranged spell attack against the creature to assail it with the chill of the grave. On a hit, the target takes 1d8 necrotic damage, and it can\'t regain hit points until the start of your next turn. Until then, the hand clings to the target. If you hit an undead target, it also has disadvantage on attack rolls against you until the end of your next turn. This spell\'s damage increases by 1d8 when you reach 5th level (2d8), 11th level (3d8), and 17th level (4d8).' },
            'Acid Splash': { level: 'Cantrip', school: 'Conjuration', time: '1 action', range: '60 feet', components: 'V, S', duration: 'Instantaneous', desc: 'You hurl a bubble of acid. Choose one creature within range, or choose two creatures within range that are within 5 feet of each other. A target must succeed on a Dexterity saving throw or take 1d6 acid damage. This spell\'s damage increases by 1d6 when you reach 5th level (2d6), 11th level (3d6), and 17th level (4d6).' },
            'Dancing Lights': { level: 'Cantrip', school: 'Evocation', time: '1 action', range: '120 feet', components: 'V, S, M (a bit of phosphorus or wychwood, or a glowworm)', duration: 'Concentration, up to 1 minute', concentration: true, desc: 'You create up to four torch-sized lights within range, making them appear as torches, lanterns, or glowing orbs that hover in the air for the duration. You can also combine the four lights into one glowing vaguely humanoid form of Medium size. Each light sheds dim light in a 10-foot radius. As a bonus action on your turn, you can move the lights up to 60 feet to a new spot within range.' },
            'Message': { level: 'Cantrip', school: 'Transmutation', time: '1 action', range: '120 feet', components: 'V, S, M (a short piece of copper wire)', duration: '1 round', desc: 'You point your finger toward a creature within range and whisper a message. The target (and only the target) hears the message and can reply in a whisper that only you can hear. You can cast this spell through solid objects if you are familiar with the target and know it is beyond the barrier.' },
            'Mending': { level: 'Cantrip', school: 'Transmutation', time: '1 minute', range: 'Touch', components: 'V, S, M (two lodestones)', duration: 'Instantaneous', desc: 'This spell repairs a single break or tear in an object you touch, such as a broken chain link, two halves of a broken key, a torn cloak, or a leaking wineskin. As long as the break or tear is no larger than 1 foot in any dimension, you mend it, leaving no trace of the former damage.' },
            'Poison Spray': { level: 'Cantrip', school: 'Conjuration', time: '1 action', range: '10 feet', components: 'V, S', duration: 'Instantaneous', desc: 'You extend your hand toward a creature you can see within range and project a puff of noxious gas from your palm. The creature must succeed on a Constitution saving throw or take 1d12 poison damage. This spell\'s damage increases by 1d12 when you reach 5th level (2d12), 11th level (3d12), and 17th level (4d12).' },

            // Wizard Level 1 Spells
            'Magic Missile': { level: '1st', school: 'Evocation', time: '1 action', range: '120 feet', components: 'V, S', duration: 'Instantaneous', desc: 'You create three glowing darts of magical force. Each dart hits a creature of your choice that you can see within range. A dart deals 1d4+1 force damage to its target. The darts all strike simultaneously, and you can direct them to hit one creature or several.', higher: 'When you cast this spell using a spell slot of 2nd level or higher, the spell creates one more dart for each slot level above 1st.' },
            'Shield': { level: '1st', school: 'Abjuration', time: '1 reaction', range: 'Self', components: 'V, S', duration: '1 round', desc: 'An invisible barrier of magical force appears and protects you. Until the start of your next turn, you have a +5 bonus to AC, including against the triggering attack, and you take no damage from magic missile.' },
            'Mage Armor': { level: '1st', school: 'Abjuration', time: '1 action', range: 'Touch', components: 'V, S, M (a piece of cured leather)', duration: '8 hours', desc: 'You touch a willing creature who isn\'t wearing armor, and a protective magical force surrounds it until the spell ends. The target\'s base AC becomes 13 + its Dexterity modifier. The spell ends if the target dons armor or if you dismiss the spell as an action.' },
            'Sleep': { level: '1st', school: 'Enchantment', time: '1 action', range: '90 feet', components: 'V, S, M (a pinch of fine sand, rose petals, or a cricket)', duration: '1 minute', desc: 'This spell sends creatures into a magical slumber. Roll 5d8; the total is how many hit points of creatures this spell can affect. Creatures within 20 feet of a point you choose within range are affected in ascending order of their current hit points (ignoring unconscious creatures). Starting with the creature that has the lowest current hit points, each creature affected by this spell falls unconscious until the spell ends, the sleeper takes damage, or someone uses an action to shake or slap the sleeper awake. Subtract each creature\'s hit points from the total before moving on to the creature with the next lowest hit points. A creature\'s hit points must be equal to or less than the remaining total for that creature to be affected. Undead and creatures immune to being charmed aren\'t affected by this spell.', higher: 'When you cast this spell using a spell slot of 2nd level or higher, roll an additional 2d8 for each slot level above 1st.' },
            'Burning Hands': { level: '1st', school: 'Evocation', time: '1 action', range: 'Self (15-foot cone)', components: 'V, S', duration: 'Instantaneous', desc: 'As you hold your hands with thumbs touching and fingers spread, a thin sheet of flames shoots forth from your outstretched fingertips. Each creature in a 15-foot cone must make a Dexterity saving throw. A creature takes 3d6 fire damage on a failed save, or half as much damage on a successful one. The fire ignites any flammable objects in the area that aren\'t being worn or carried.', higher: 'When you cast this spell using a spell slot of 2nd level or higher, the damage increases by 1d6 for each slot level above 1st.' },
            'Chromatic Orb': { level: '1st', school: 'Evocation', time: '1 action', range: '90 feet', components: 'V, S, M (a diamond worth at least 50 gp)', duration: 'Instantaneous', desc: 'You hurl a 4-inch-diameter sphere of energy at a creature that you can see within range. You choose acid, cold, fire, lightning, poison, or thunder for the type of orb you create, and then make a ranged spell attack against the target. On a hit, the creature takes 3d8 damage of the type you chose.', higher: 'When you cast this spell using a spell slot of 2nd level or higher, the damage increases by 1d8 for each slot level above 1st.' },
            'Color Spray': { level: '1st', school: 'Illusion', time: '1 action', range: 'Self (15-foot cone)', components: 'V, S, M (a pinch of powder or sand that is colored red, yellow, and blue)', duration: '1 round', desc: 'A dazzling array of flashing, colored light springs from your hand. Roll 6d10; the total is how many hit points of creatures this spell can affect. Creatures in a 15-foot cone originating from you are affected in ascending order of their current hit points (ignoring unconscious creatures). Each creature affected by this spell is blinded until the end of your next turn.', higher: 'When you cast this spell using a spell slot of 2nd level or higher, roll an additional 2d10 for each slot level above 1st.' },
            'Comprehend Languages': { level: '1st', school: 'Divination', time: '1 action', range: 'Self', components: 'V, S, M (a pinch of soot and salt)', duration: '1 hour', ritual: true, desc: 'For the duration, you understand the literal meaning of any spoken language that you hear. You also understand any written language that you see, but you must be touching the surface on which the words are written. It takes about 1 minute to read one page of text. This spell doesn\'t decode secret messages in a text or a glyph, such as an arcane sigil, that isn\'t part of a written language.' },
            'Disguise Self': { level: '1st', school: 'Illusion', time: '1 action', range: 'Self', components: 'V, S', duration: '1 hour', desc: 'You make yourselfincluding your clothing, armor, weapons, and other belongings on your personlook different until the spell ends or until you use your action to dismiss it. You can seem 1 foot shorter or taller and can appear thin, fat, or in between. You can\'t change your body type, so you must adopt a form that has the same basic arrangement of limbs. Otherwise, the extent of the illusion is up to you.' },
            'Expeditious Retreat': { level: '1st', school: 'Transmutation', time: '1 bonus action', range: 'Self', components: 'V, S', duration: 'Concentration, up to 10 minutes', concentration: true, desc: 'This spell allows you to move at an incredible pace. When you cast this spell, and then as a bonus action on each of your turns until the spell ends, you can take the Dash action.' },
            'False Life': { level: '1st', school: 'Necromancy', time: '1 action', range: 'Self', components: 'V, S, M (a small amount of alcohol or distilled spirits)', duration: '1 hour', desc: 'Bolstering yourself with a necromantic facsimile of life, you gain 1d4+4 temporary hit points for the duration.', higher: 'When you cast this spell using a spell slot of 2nd level or higher, you gain 5 additional temporary hit points for each slot level above 1st.' },
            'Feather Fall': { level: '1st', school: 'Transmutation', time: '1 reaction', range: '60 feet', components: 'V, M (a small feather or piece of down)', duration: '1 minute', desc: 'Choose up to five falling creatures within range. A falling creature\'s rate of descent slows to 60 feet per round until the spell ends. If the creature lands before the spell ends, it takes no falling damage and can land on its feet, and the spell ends for that creature.' },
            'Find Familiar': { level: '1st', school: 'Conjuration', time: '1 hour', range: '10 feet', components: 'V, S, M (10 gp worth of charcoal, incense, and herbs that must be consumed by fire in a brass brazier)', duration: 'Instantaneous', ritual: true, desc: 'You gain the service of a familiar, a spirit that takes an animal form you choose: bat, cat, crab, frog (toad), hawk, lizard, octopus, owl, poisonous snake, fish (quipper), rat, raven, sea horse, spider, or weasel. The familiar can telepathically communicate with you and share its senses. As an action, you can temporarily dismiss it or permanently dismiss it.' },
            'Grease': { level: '1st', school: 'Conjuration', time: '1 action', range: '60 feet', components: 'V, S, M (a bit of pork rind or butter)', duration: '1 minute', desc: 'Slick grease covers the ground in a 10-foot square centered on a point within range and turns it into difficult terrain for the duration. When the grease appears, each creature standing in its area must succeed on a Dexterity saving throw or fall prone. A creature that enters the area or ends its turn there must also succeed on a Dexterity saving throw or fall prone.' },
            'Identify': { level: '1st', school: 'Divination', time: '1 minute', range: 'Touch', components: 'V, S, M (a pearl worth at least 100 gp and an owl feather)', duration: 'Instantaneous', ritual: true, desc: 'You choose one object that you must touch throughout the casting of the spell. If it is a magic item or some other magic-imbued object, you learn its properties and how to use them, whether it requires attunement to use, and how many charges it has, if any. You learn whether any spells are affecting the item and what they are. If the item was created by a spell, you learn which spell created it.' },
            'Ray of Sickness': { level: '1st', school: 'Necromancy', time: '1 action', range: '60 feet', components: 'V, S', duration: 'Instantaneous', desc: 'A ray of sickening greenish energy lashes out toward a creature within range. Make a ranged spell attack against the target. On a hit, the target takes 2d8 poison damage and must make a Constitution saving throw. On a failed save, it is also poisoned until the end of your next turn.', higher: 'When you cast this spell using a spell slot of 2nd level or higher, the damage increases by 1d8 for each slot level above 1st.' },
            'Silent Image': { level: '1st', school: 'Illusion', time: '1 action', range: '60 feet', components: 'V, S, M (a bit of fleece)', duration: 'Concentration, up to 10 minutes', concentration: true, desc: 'You create the image of an object, a creature, or some other visible phenomenon that is no larger than a 15-foot cube. The image appears at a spot within range and lasts for the duration. The image is purely visual; it isn\'t accompanied by sound, smell, or other sensory effects. You can use your action to cause the image to move to any spot within range. As the image changes location, you can alter its appearance so that its movements appear natural for the image.' },
            'Tasha\'s Hideous Laughter': { level: '1st', school: 'Enchantment', time: '1 action', range: '30 feet', components: 'V, S, M (tiny tarts and a feather that is waved in the air)', duration: 'Concentration, up to 1 minute', concentration: true, desc: 'A creature of your choice that you can see within range perceives everything as hilariously funny and falls into fits of laughter if this spell affects it. The target must succeed on a Wisdom saving throw or fall prone, becoming incapacitated and unable to stand up for the duration. A creature with an Intelligence score of 4 or less isn\'t affected. At the end of each of its turns, and each time it takes damage, the target can make another Wisdom saving throw. The target has advantage on the saving throw if it\'s triggered by damage. On a success, the spell ends.' },
            'Tenser\'s Floating Disk': { level: '1st', school: 'Conjuration', time: '1 action', range: '30 feet', components: 'V, S, M (a drop of mercury)', duration: '1 hour', ritual: true, desc: 'This spell creates a circular, horizontal plane of force, 3 feet in diameter and 1 inch thick, that floats 3 feet above the ground in an unoccupied space of your choice that you can see within range. The disk remains for the duration, and can hold up to 500 pounds. If more weight is placed on it, the spell ends, and everything on the disk falls to the ground.' },
            'Unseen Servant': { level: '1st', school: 'Conjuration', time: '1 action', range: '60 feet', components: 'V, S, M (a piece of string and a bit of wood)', duration: '1 hour', ritual: true, desc: 'This spell creates an invisible, mindless, shapeless, Medium force that performs simple tasks at your command until the spell ends. The servant springs into existence in an unoccupied space on the ground within range. It has AC 10, 1 hit point, and a Strength of 2, and it can\'t attack. If it drops to 0 hit points, the spell ends.' },
            'Witch Bolt': { level: '1st', school: 'Evocation', time: '1 action', range: '30 feet', components: 'V, S, M (a twig from a tree that has been struck by lightning)', duration: 'Concentration, up to 1 minute', concentration: true, desc: 'A beam of crackling, blue energy lances out toward a creature within range, forming a sustained arc of lightning between you and the target. Make a ranged spell attack against that creature. On a hit, the target takes 1d12 lightning damage, and on each of your turns for the duration, you can use your action to deal 1d12 lightning damage to the target automatically. The spell ends if you use your action to do anything else. The spell also ends if the target is ever outside the spell\'s range or if it has total cover from you.', higher: 'When you cast this spell using a spell slot of 2nd level or higher, the initial damage increases by 1d12 for each slot level above 1st.' },
            'Alarm': { level: '1st', school: 'Abjuration', time: '1 minute', range: '30 feet', components: 'V, S, M (a tiny bell and a piece of fine silver wire)', duration: '8 hours', ritual: true, desc: 'You set an alarm against unwanted intrusion. Choose a door, a window, or an area within range that is no larger than a 20-foot cube. Until the spell ends, an alarm alerts you whenever a Tiny or larger creature touches or enters the warded area. When you cast the spell, you can designate creatures that won\'t set off the alarm. You also choose whether the alarm is mental or audible.' }
        };

        // Full class spell lists for prepared casters
        const CLASS_SPELL_LISTS = {
            druid: {
                1: ['Animal Friendship', 'Charm Person', 'Create or Destroy Water', 'Cure Wounds', 'Detect Magic', 'Detect Poison and Disease', 'Entangle', 'Faerie Fire', 'Fog Cloud', 'Goodberry', 'Healing Word', 'Jump', 'Longstrider', 'Purify Food and Drink', 'Speak with Animals', 'Thunderwave'],
                2: ['Animal Messenger', 'Barkskin', 'Beast Sense', 'Darkvision', 'Enhance Ability', 'Find Traps', 'Flame Blade', 'Flaming Sphere', 'Gust of Wind', 'Heat Metal', 'Hold Person', 'Lesser Restoration', 'Locate Animals or Plants', 'Locate Object', 'Moonbeam', 'Pass without Trace', 'Protection from Poison', 'Spike Growth'],
                3: ['Call Lightning', 'Conjure Animals', 'Daylight', 'Dispel Magic', 'Feign Death', 'Meld into Stone', 'Plant Growth', 'Protection from Energy', 'Sleet Storm', 'Speak with Plants', 'Water Breathing', 'Water Walk', 'Wind Wall'],
                4: ['Blight', 'Confusion', 'Conjure Minor Elementals', 'Conjure Woodland Beings', 'Control Water', 'Dominate Beast', 'Freedom of Movement', 'Giant Insect', 'Grasping Vine', 'Guardian of Nature', 'Hallucinatory Terrain', 'Ice Storm', 'Locate Creature', 'Polymorph', 'Stone Shape', 'Stoneskin', 'Wall of Fire'],
                5: ['Antilife Shell', 'Awaken', 'Commune with Nature', 'Cone of Cold', 'Conjure Elemental', 'Contagion', 'Geas', 'Greater Restoration', 'Insect Plague', 'Mass Cure Wounds', 'Planar Binding', 'Reincarnate', 'Scrying', 'Tree Stride', 'Wall of Stone'],
                6: ['Conjure Fey', 'Find the Path', 'Heal', 'Heroes\' Feast', 'Move Earth', 'Sunbeam', 'Transport via Plants', 'Wall of Thorns', 'Wind Walk'],
                7: ['Fire Storm', 'Mirage Arcane', 'Plane Shift', 'Regenerate', 'Reverse Gravity'],
                8: ['Animal Shapes', 'Antipathy/Sympathy', 'Control Weather', 'Earthquake', 'Feeblemind', 'Sunburst', 'Tsunami'],
                9: ['Foresight', 'Shapechange', 'Storm of Vengeance', 'True Resurrection']
            },
            cleric: {
                1: ['Bane', 'Bless', 'Command', 'Create or Destroy Water', 'Cure Wounds', 'Detect Evil and Good', 'Detect Magic', 'Detect Poison and Disease', 'Guiding Bolt', 'Healing Word', 'Inflict Wounds', 'Protection from Evil and Good', 'Purify Food and Drink', 'Sanctuary', 'Shield of Faith'],
                2: ['Aid', 'Augury', 'Blindness/Deafness', 'Calm Emotions', 'Continual Flame', 'Enhance Ability', 'Find Traps', 'Gentle Repose', 'Hold Person', 'Lesser Restoration', 'Locate Object', 'Prayer of Healing', 'Protection from Poison', 'Silence', 'Spiritual Weapon', 'Warding Bond', 'Zone of Truth'],
                3: ['Animate Dead', 'Beacon of Hope', 'Bestow Curse', 'Clairvoyance', 'Create Food and Water', 'Daylight', 'Dispel Magic', 'Feign Death', 'Glyph of Warding', 'Magic Circle', 'Mass Healing Word', 'Meld into Stone', 'Protection from Energy', 'Remove Curse', 'Revivify', 'Sending', 'Speak with Dead', 'Spirit Guardians', 'Tongues', 'Water Walk'],
                4: ['Banishment', 'Control Water', 'Death Ward', 'Divination', 'Freedom of Movement', 'Guardian of Faith', 'Locate Creature', 'Stone Shape'],
                5: ['Commune', 'Contagion', 'Dispel Evil and Good', 'Flame Strike', 'Geas', 'Greater Restoration', 'Hallow', 'Insect Plague', 'Legend Lore', 'Mass Cure Wounds', 'Planar Binding', 'Raise Dead', 'Scrying'],
                6: ['Blade Barrier', 'Create Undead', 'Find the Path', 'Forbiddance', 'Harm', 'Heal', 'Heroes\' Feast', 'Planar Ally', 'True Seeing', 'Word of Recall'],
                7: ['Conjure Celestial', 'Divine Word', 'Etherealness', 'Fire Storm', 'Plane Shift', 'Regenerate', 'Resurrection', 'Symbol'],
                8: ['Antimagic Field', 'Control Weather', 'Earthquake', 'Holy Aura'],
                9: ['Astral Projection', 'Gate', 'Mass Heal', 'True Resurrection']
            },
            paladin: {
                1: ['Bless', 'Ceremony', 'Command', 'Compelled Duel', 'Cure Wounds', 'Detect Evil and Good', 'Detect Magic', 'Detect Poison and Disease', 'Divine Favor', 'Heroism', 'Protection from Evil and Good', 'Purify Food and Drink', 'Searing Smite', 'Shield of Faith', 'Thunderous Smite', 'Wrathful Smite'],
                2: ['Aid', 'Branding Smite', 'Find Steed', 'Gentle Repose', 'Lesser Restoration', 'Locate Object', 'Magic Weapon', 'Prayer of Healing', 'Protection from Poison', 'Warding Bond', 'Zone of Truth'],
                3: ['Aura of Vitality', 'Blinding Smite', 'Create Food and Water', 'Crusader\'s Mantle', 'Daylight', 'Dispel Magic', 'Elemental Weapon', 'Magic Circle', 'Remove Curse', 'Revivify', 'Spirit Shroud'],
                4: ['Aura of Life', 'Aura of Purity', 'Banishment', 'Death Ward', 'Find Greater Steed', 'Locate Creature', 'Staggering Smite'],
                5: ['Banishing Smite', 'Circle of Power', 'Destructive Wave', 'Dispel Evil and Good', 'Geas', 'Holy Weapon', 'Raise Dead', 'Summon Celestial']
            },
            wizard: {
                1: ['Absorb Elements', 'Alarm', 'Burning Hands', 'Catapult', 'Cause Fear', 'Charm Person', 'Chromatic Orb', 'Color Spray', 'Comprehend Languages', 'Detect Magic', 'Disguise Self', 'Distort Value', 'Earth Tremor', 'Expeditious Retreat', 'False Life', 'Feather Fall', 'Find Familiar', 'Fog Cloud', 'Frost Fingers', 'Grease', 'Ice Knife', 'Identify', 'Illusory Script', 'Jump', 'Longstrider', 'Mage Armor', 'Magic Missile', 'Magnify Gravity', 'Protection from Evil and Good', 'Ray of Sickness', 'Shield', 'Silent Image', 'Silvery Barbs', 'Sleep', 'Snare', 'Tasha\'s Caustic Brew', 'Tasha\'s Hideous Laughter', 'Tenser\'s Floating Disk', 'Thunderwave', 'Unseen Servant', 'Witch Bolt'],
                2: ['Aganazzar\'s Scorcher', 'Alter Self', 'Arcane Lock', 'Augury', 'Blindness/Deafness', 'Blur', 'Borrowed Knowledge', 'Cloud of Daggers', 'Continual Flame', 'Crown of Madness', 'Darkness', 'Darkvision', 'Detect Thoughts', 'Dragon\'s Breath', 'Dust Devil', 'Earthbind', 'Enhance Ability', 'Enlarge/Reduce', 'Flaming Sphere', 'Fortune\'s Favor', 'Gentle Repose', 'Gift of Gab', 'Gust of Wind', 'Hold Person', 'Immovable Object', 'Invisibility', 'Kinetic Jaunt', 'Knock', 'Levitate', 'Locate Object', 'Magic Mouth', 'Magic Weapon', 'Maximillian\'s Earthen Grasp', 'Melf\'s Acid Arrow', 'Mind Spike', 'Mirror Image', 'Misty Step', 'Nathair\'s Mischief', 'Nystul\'s Magic Aura', 'Phantasmal Force', 'Pyrotechnics', 'Ray of Enfeeblement', 'Rime\'s Binding Ice', 'Rope Trick', 'Scorching Ray', 'See Invisibility', 'Shadow Blade', 'Shatter', 'Skywrite', 'Snilloc\'s Snowball Swarm', 'Spider Climb', 'Suggestion', 'Tasha\'s Mind Whip', 'Vortex Warp', 'Warding Wind', 'Web', 'Wither and Bloom'],
                3: ['Animate Dead', 'Antagonize', 'Ashardalon\'s Stride', 'Bestow Curse', 'Blink', 'Catnap', 'Clairvoyance', 'Counterspell', 'Dispel Magic', 'Enemies Abound', 'Erupting Earth', 'Fast Friends', 'Fear', 'Feign Death', 'Fireball', 'Flame Arrows', 'Fly', 'Gaseous Form', 'Glyph of Warding', 'Haste', 'Hypnotic Pattern', 'Incite Greed', 'Intellect Fortress', 'Leomund\'s Tiny Hut', 'Life Transference', 'Lightning Bolt', 'Magic Circle', 'Major Image', 'Melf\'s Minute Meteors', 'Nondetection', 'Phantom Steed', 'Protection from Energy', 'Pulse Wave', 'Remove Curse', 'Sending', 'Sleet Storm', 'Slow', 'Spirit Shroud', 'Stinking Cloud', 'Summon Fey', 'Summon Lesser Demons', 'Summon Shadowspawn', 'Summon Undead', 'Thunder Step', 'Tidal Wave', 'Tiny Servant', 'Tongues', 'Vampiric Touch', 'Wall of Sand', 'Wall of Water', 'Water Breathing'],
                4: ['Arcane Eye', 'Banishment', 'Blight', 'Charm Monster', 'Confusion', 'Conjure Minor Elementals', 'Control Water', 'Dimension Door', 'Elemental Bane', 'Evard\'s Black Tentacles', 'Fabricate', 'Fire Shield', 'Galder\'s Speedy Courier', 'Gravity Sinkhole', 'Greater Invisibility', 'Hallucinatory Terrain', 'Ice Storm', 'Leomund\'s Secret Chest', 'Locate Creature', 'Mordenkainen\'s Faithful Hound', 'Mordenkainen\'s Private Sanctum', 'Otiluke\'s Resilient Sphere', 'Phantasmal Killer', 'Polymorph', 'Raulothim\'s Psychic Lance', 'Sickening Radiance', 'Stone Shape', 'Stoneskin', 'Storm Sphere', 'Summon Aberration', 'Summon Construct', 'Summon Elemental', 'Summon Greater Demon', 'Vitriolic Sphere', 'Wall of Fire', 'Watery Sphere'],
                5: ['Animate Objects', 'Bigby\'s Hand', 'Cloudkill', 'Cone of Cold', 'Conjure Elemental', 'Contact Other Plane', 'Control Winds', 'Creation', 'Danse Macabre', 'Dawn', 'Dominate Person', 'Dream', 'Enervation', 'Far Step', 'Geas', 'Hold Monster', 'Immolation', 'Infernal Calling', 'Legend Lore', 'Mislead', 'Modify Memory', 'Negative Energy Flood', 'Passwall', 'Planar Binding', 'Rary\'s Telepathic Bond', 'Scrying', 'Seeming', 'Skill Empowerment', 'Steel Wind Strike', 'Summon Draconic Spirit', 'Synaptic Static', 'Telekinesis', 'Teleportation Circle', 'Temporal Shunt', 'Transmute Rock', 'Wall of Force', 'Wall of Light', 'Wall of Stone'],
                6: ['Arcane Gate', 'Chain Lightning', 'Circle of Death', 'Contingency', 'Create Homunculus', 'Create Undead', 'Disintegrate', 'Drawmij\'s Instant Summons', 'Eyebite', 'Fizban\'s Platinum Shield', 'Flesh to Stone', 'Globe of Invulnerability', 'Gravity Fissure', 'Guards and Wards', 'Investiture of Flame', 'Investiture of Ice', 'Investiture of Stone', 'Investiture of Wind', 'Magic Jar', 'Mass Suggestion', 'Mental Prison', 'Move Earth', 'Otiluke\'s Freezing Sphere', 'Otto\'s Irresistible Dance', 'Programmed Illusion', 'Scatter', 'Soul Cage', 'Summon Fiend', 'Sunbeam', 'Tasha\'s Otherworldly Guise', 'Tenser\'s Transformation', 'True Seeing', 'Wall of Ice'],
                7: ['Crown of Stars', 'Delayed Blast Fireball', 'Draconic Transformation', 'Dream of the Blue Veil', 'Etherealness', 'Finger of Death', 'Forcecage', 'Mirage Arcane', 'Mordenkainen\'s Magnificent Mansion', 'Mordenkainen\'s Sword', 'Plane Shift', 'Power Word Pain', 'Prismatic Spray', 'Project Image', 'Reverse Gravity', 'Sequester', 'Simulacrum', 'Symbol', 'Teleport', 'Tether Essence', 'Whirlwind'],
                8: ['Abi-Dalzim\'s Horrid Wilting', 'Antimagic Field', 'Antipathy/Sympathy', 'Clone', 'Control Weather', 'Dark Star', 'Demiplane', 'Dominate Monster', 'Feeblemind', 'Illusory Dragon', 'Incendiary Cloud', 'Maddening Darkness', 'Maze', 'Mighty Fortress', 'Mind Blank', 'Power Word Stun', 'Reality Break', 'Sunburst', 'Telepathy'],
                9: ['Astral Projection', 'Blade of Disaster', 'Foresight', 'Gate', 'Imprisonment', 'Invulnerability', 'Mass Polymorph', 'Meteor Swarm', 'Power Word Kill', 'Prismatic Wall', 'Psychic Scream', 'Ravenous Void', 'Shapechange', 'Time Ravage', 'Time Stop', 'True Polymorph', 'Weird', 'Wish']
            },
            // Known caster spell lists
            sorcerer: {
                1: ['Absorb Elements', 'Burning Hands', 'Catapult', 'Chaos Bolt', 'Charm Person', 'Chromatic Orb', 'Color Spray', 'Comprehend Languages', 'Detect Magic', 'Disguise Self', 'Distort Value', 'Earth Tremor', 'Expeditious Retreat', 'False Life', 'Feather Fall', 'Fog Cloud', 'Grease', 'Ice Knife', 'Jump', 'Mage Armor', 'Magic Missile', 'Ray of Sickness', 'Shield', 'Silent Image', 'Silvery Barbs', 'Sleep', 'Tasha\'s Caustic Brew', 'Thunderwave', 'Witch Bolt'],
                2: ['Aganazzar\'s Scorcher', 'Alter Self', 'Blindness/Deafness', 'Blur', 'Cloud of Daggers', 'Crown of Madness', 'Darkness', 'Darkvision', 'Detect Thoughts', 'Dragon\'s Breath', 'Dust Devil', 'Earthbind', 'Enhance Ability', 'Enlarge/Reduce', 'Flame Blade', 'Flaming Sphere', 'Gust of Wind', 'Hold Person', 'Invisibility', 'Kinetic Jaunt', 'Knock', 'Levitate', 'Magic Weapon', 'Maximilian\'s Earthen Grasp', 'Mind Spike', 'Mirror Image', 'Misty Step', 'Nathair\'s Mischief', 'Phantasmal Force', 'Pyrotechnics', 'Scorching Ray', 'See Invisibility', 'Shadow Blade', 'Shatter', 'Snilloc\'s Snowball Swarm', 'Spider Climb', 'Suggestion', 'Tasha\'s Mind Whip', 'Vortex Warp', 'Web', 'Wither and Bloom'],
                3: ['Ashardalon\'s Stride', 'Blink', 'Catnap', 'Clairvoyance', 'Counterspell', 'Daylight', 'Dispel Magic', 'Enemies Abound', 'Erupting Earth', 'Fear', 'Fireball', 'Flame Arrows', 'Fly', 'Gaseous Form', 'Haste', 'Hypnotic Pattern', 'Intellect Fortress', 'Lightning Bolt', 'Major Image', 'Melf\'s Minute Meteors', 'Protection from Energy', 'Sleet Storm', 'Slow', 'Stinking Cloud', 'Thunder Step', 'Tidal Wave', 'Tongues', 'Vampiric Touch', 'Wall of Water', 'Water Breathing', 'Water Walk'],
                4: ['Banishment', 'Blight', 'Charm Monster', 'Confusion', 'Dimension Door', 'Dominate Beast', 'Fire Shield', 'Greater Invisibility', 'Ice Storm', 'Polymorph', 'Raulothim\'s Psychic Lance', 'Sickening Radiance', 'Stoneskin', 'Storm Sphere', 'Vitriolic Sphere', 'Wall of Fire', 'Watery Sphere'],
                5: ['Animate Objects', 'Bigby\'s Hand', 'Cloudkill', 'Cone of Cold', 'Control Winds', 'Creation', 'Dominate Person', 'Enervation', 'Far Step', 'Hold Monster', 'Immolation', 'Insect Plague', 'Seeming', 'Skill Empowerment', 'Summon Draconic Spirit', 'Synaptic Static', 'Telekinesis', 'Teleportation Circle', 'Wall of Light', 'Wall of Stone'],
                6: ['Arcane Gate', 'Chain Lightning', 'Circle of Death', 'Disintegrate', 'Eyebite', 'Fizban\'s Platinum Shield', 'Flesh to Stone', 'Globe of Invulnerability', 'Investiture of Flame', 'Investiture of Ice', 'Investiture of Stone', 'Investiture of Wind', 'Mass Suggestion', 'Mental Prison', 'Move Earth', 'Otiluke\'s Freezing Sphere', 'Scatter', 'Sunbeam', 'Tasha\'s Otherworldly Guise', 'True Seeing'],
                7: ['Crown of Stars', 'Delayed Blast Fireball', 'Draconic Transformation', 'Dream of the Blue Veil', 'Etherealness', 'Finger of Death', 'Fire Storm', 'Plane Shift', 'Power Word Pain', 'Prismatic Spray', 'Reverse Gravity', 'Teleport'],
                8: ['Abi-Dalzim\'s Horrid Wilting', 'Demiplane', 'Dominate Monster', 'Earthquake', 'Incendiary Cloud', 'Power Word Stun', 'Sunburst'],
                9: ['Blade of Disaster', 'Gate', 'Mass Polymorph', 'Meteor Swarm', 'Power Word Kill', 'Psychic Scream', 'Time Stop', 'Wish']
            },
            warlock: {
                1: ['Armor of Agathys', 'Arms of Hadar', 'Cause Fear', 'Charm Person', 'Comprehend Languages', 'Distort Value', 'Expeditious Retreat', 'Hellish Rebuke', 'Hex', 'Illusory Script', 'Protection from Evil and Good', 'Unseen Servant', 'Witch Bolt'],
                2: ['Borrowed Knowledge', 'Cloud of Daggers', 'Crown of Madness', 'Darkness', 'Earthbind', 'Enthrall', 'Flock of Familiars', 'Hold Person', 'Invisibility', 'Mind Spike', 'Mirror Image', 'Misty Step', 'Ray of Enfeeblement', 'Shadow Blade', 'Shatter', 'Spider Climb', 'Spray of Cards', 'Suggestion'],
                3: ['Antagonize', 'Counterspell', 'Dispel Magic', 'Enemies Abound', 'Fear', 'Fly', 'Gaseous Form', 'Hunger of Hadar', 'Hypnotic Pattern', 'Incite Greed', 'Intellect Fortress', 'Magic Circle', 'Major Image', 'Remove Curse', 'Spirit Shroud', 'Summon Fey', 'Summon Lesser Demons', 'Summon Shadowspawn', 'Summon Undead', 'Thunder Step', 'Tongues', 'Vampiric Touch'],
                4: ['Banishment', 'Blight', 'Charm Monster', 'Dimension Door', 'Elemental Bane', 'Galder\'s Speedy Courier', 'Hallucinatory Terrain', 'Raulothim\'s Psychic Lance', 'Shadow of Moil', 'Sickening Radiance', 'Summon Aberration', 'Summon Greater Demon'],
                5: ['Contact Other Plane', 'Danse Macabre', 'Dream', 'Enervation', 'Far Step', 'Hold Monster', 'Infernal Calling', 'Mislead', 'Negative Energy Flood', 'Planar Binding', 'Scrying', 'Synaptic Static', 'Teleportation Circle', 'Wall of Light'],
                6: ['Arcane Gate', 'Circle of Death', 'Conjure Fey', 'Create Undead', 'Eyebite', 'Flesh to Stone', 'Investiture of Flame', 'Investiture of Ice', 'Investiture of Stone', 'Investiture of Wind', 'Mass Suggestion', 'Mental Prison', 'Scatter', 'Soul Cage', 'Summon Fiend', 'Tasha\'s Otherworldly Guise', 'True Seeing'],
                7: ['Crown of Stars', 'Dream of the Blue Veil', 'Etherealness', 'Finger of Death', 'Forcecage', 'Plane Shift', 'Power Word Pain'],
                8: ['Demiplane', 'Dominate Monster', 'Feeblemind', 'Glibness', 'Maddening Darkness', 'Power Word Stun'],
                9: ['Astral Projection', 'Blade of Disaster', 'Foresight', 'Gate', 'Imprisonment', 'Power Word Kill', 'Psychic Scream', 'True Polymorph', 'Weird']
            },
            bard: {
                1: ['Animal Friendship', 'Bane', 'Charm Person', 'Color Spray', 'Command', 'Comprehend Languages', 'Cure Wounds', 'Detect Magic', 'Disguise Self', 'Dissonant Whispers', 'Distort Value', 'Earth Tremor', 'Faerie Fire', 'Feather Fall', 'Healing Word', 'Heroism', 'Identify', 'Illusory Script', 'Longstrider', 'Silent Image', 'Silvery Barbs', 'Sleep', 'Speak with Animals', 'Tasha\'s Hideous Laughter', 'Thunderwave', 'Unseen Servant'],
                2: ['Aid', 'Animal Messenger', 'Blindness/Deafness', 'Borrowed Knowledge', 'Calm Emotions', 'Cloud of Daggers', 'Crown of Madness', 'Detect Thoughts', 'Enhance Ability', 'Enlarge/Reduce', 'Enthrall', 'Gift of Gab', 'Heat Metal', 'Hold Person', 'Invisibility', 'Kinetic Jaunt', 'Knock', 'Lesser Restoration', 'Locate Animals or Plants', 'Locate Object', 'Magic Mouth', 'Mirror Image', 'Nathair\'s Mischief', 'Phantasmal Force', 'Pyrotechnics', 'See Invisibility', 'Shatter', 'Silence', 'Skywrite', 'Spray of Cards', 'Suggestion', 'Warding Wind', 'Zone of Truth'],
                3: ['Antagonize', 'Bestow Curse', 'Catnap', 'Clairvoyance', 'Dispel Magic', 'Enemies Abound', 'Fast Friends', 'Fear', 'Feign Death', 'Glyph of Warding', 'Hypnotic Pattern', 'Intellect Fortress', 'Leomund\'s Tiny Hut', 'Major Image', 'Mass Healing Word', 'Motivational Speech', 'Nondetection', 'Plant Growth', 'Sending', 'Slow', 'Speak with Dead', 'Speak with Plants', 'Stinking Cloud', 'Tongues'],
                4: ['Charm Monster', 'Compulsion', 'Confusion', 'Dimension Door', 'Freedom of Movement', 'Greater Invisibility', 'Hallucinatory Terrain', 'Locate Creature', 'Phantasmal Killer', 'Polymorph', 'Raulothim\'s Psychic Lance'],
                5: ['Animate Objects', 'Awaken', 'Dominate Person', 'Dream', 'Geas', 'Greater Restoration', 'Hold Monster', 'Legend Lore', 'Mass Cure Wounds', 'Mislead', 'Modify Memory', 'Planar Binding', 'Raise Dead', 'Rary\'s Telepathic Bond', 'Scrying', 'Seeming', 'Skill Empowerment', 'Synaptic Static', 'Teleportation Circle'],
                6: ['Eyebite', 'Find the Path', 'Guards and Wards', 'Heroes\' Feast', 'Mass Suggestion', 'Otto\'s Irresistible Dance', 'Programmed Illusion', 'True Seeing'],
                7: ['Dream of the Blue Veil', 'Etherealness', 'Forcecage', 'Mirage Arcane', 'Mordenkainen\'s Magnificent Mansion', 'Mordenkainen\'s Sword', 'Prismatic Spray', 'Project Image', 'Regenerate', 'Resurrection', 'Symbol', 'Teleport'],
                8: ['Antipathy/Sympathy', 'Dominate Monster', 'Feeblemind', 'Glibness', 'Mind Blank', 'Power Word Stun'],
                9: ['Foresight', 'Mass Polymorph', 'Power Word Heal', 'Power Word Kill', 'Prismatic Wall', 'Psychic Scream', 'True Polymorph']
            },
            ranger: {
                1: ['Absorb Elements', 'Alarm', 'Animal Friendship', 'Beast Bond', 'Cure Wounds', 'Detect Magic', 'Detect Poison and Disease', 'Ensnaring Strike', 'Entangle', 'Fog Cloud', 'Goodberry', 'Hail of Thorns', 'Hunter\'s Mark', 'Jump', 'Longstrider', 'Searing Smite', 'Snare', 'Speak with Animals', 'Zephyr Strike'],
                2: ['Aid', 'Animal Messenger', 'Barkskin', 'Beast Sense', 'Cordon of Arrows', 'Darkvision', 'Enhance Ability', 'Find Traps', 'Gust of Wind', 'Healing Spirit', 'Lesser Restoration', 'Locate Animals or Plants', 'Locate Object', 'Magic Weapon', 'Pass without Trace', 'Protection from Poison', 'Silence', 'Spike Growth', 'Summon Beast'],
                3: ['Ashardalon\'s Stride', 'Conjure Animals', 'Conjure Barrage', 'Daylight', 'Elemental Weapon', 'Flame Arrows', 'Lightning Arrow', 'Meld into Stone', 'Nondetection', 'Plant Growth', 'Protection from Energy', 'Revivify', 'Speak with Plants', 'Summon Fey', 'Water Breathing', 'Water Walk', 'Wind Wall'],
                4: ['Conjure Woodland Beings', 'Dominate Beast', 'Freedom of Movement', 'Grasping Vine', 'Guardian of Nature', 'Locate Creature', 'Stoneskin', 'Summon Elemental'],
                5: ['Commune with Nature', 'Conjure Volley', 'Greater Restoration', 'Steel Wind Strike', 'Swift Quiver', 'Tree Stride', 'Wrath of Nature']
            }
        };

        // Known spells progression by class and level
        // Format: [spellsKnown, cantripsKnown] at each character level
        const SPELLS_KNOWN_PROGRESSION = {
            sorcerer: {
                1: [2, 4], 2: [3, 4], 3: [4, 4], 4: [5, 5], 5: [6, 5],
                6: [7, 5], 7: [8, 5], 8: [9, 5], 9: [10, 5], 10: [11, 6],
                11: [12, 6], 12: [12, 6], 13: [13, 6], 14: [13, 6], 15: [14, 6],
                16: [14, 6], 17: [15, 6], 18: [15, 6], 19: [15, 6], 20: [15, 6]
            },
            warlock: {
                1: [2, 2], 2: [3, 2], 3: [4, 2], 4: [5, 3], 5: [6, 3],
                6: [7, 3], 7: [8, 3], 8: [9, 3], 9: [10, 3], 10: [10, 4],
                11: [11, 4], 12: [11, 4], 13: [12, 4], 14: [12, 4], 15: [13, 4],
                16: [13, 4], 17: [14, 4], 18: [14, 4], 19: [15, 4], 20: [15, 4]
            },
            bard: {
                1: [4, 2], 2: [5, 2], 3: [6, 2], 4: [7, 3], 5: [8, 3],
                6: [9, 3], 7: [10, 3], 8: [11, 3], 9: [12, 3], 10: [14, 4],
                11: [15, 4], 12: [15, 4], 13: [16, 4], 14: [18, 4], 15: [19, 4],
                16: [19, 4], 17: [20, 4], 18: [22, 4], 19: [22, 4], 20: [22, 4]
            },
            ranger: {
                1: [0, 0], 2: [2, 0], 3: [3, 0], 4: [3, 0], 5: [4, 0],
                6: [4, 0], 7: [5, 0], 8: [5, 0], 9: [6, 0], 10: [6, 0],
                11: [7, 0], 12: [7, 0], 13: [8, 0], 14: [8, 0], 15: [9, 0],
                16: [9, 0], 17: [10, 0], 18: [10, 0], 19: [11, 0], 20: [11, 0]
            },
            // Eldritch Knight (Fighter subclass) - starts at level 3
            eldritchknight: {
                1: [0, 0], 2: [0, 0], 3: [3, 2], 4: [4, 2], 5: [4, 2],
                6: [4, 2], 7: [5, 2], 8: [6, 2], 9: [6, 2], 10: [7, 3],
                11: [8, 3], 12: [8, 3], 13: [9, 3], 14: [10, 3], 15: [10, 3],
                16: [11, 3], 17: [11, 3], 18: [11, 3], 19: [12, 3], 20: [13, 3]
            },
            // Arcane Trickster (Rogue subclass) - starts at level 3
            arcanetrickster: {
                1: [0, 0], 2: [0, 0], 3: [3, 3], 4: [4, 3], 5: [4, 3],
                6: [4, 3], 7: [5, 3], 8: [6, 3], 9: [6, 3], 10: [7, 4],
                11: [8, 4], 12: [8, 4], 13: [9, 4], 14: [10, 4], 15: [10, 4],
                16: [11, 4], 17: [11, 4], 18: [11, 4], 19: [12, 4], 20: [13, 4]
            }
        };

        // Check if class is a "known" spellcaster (learns specific spells, can swap on level up)
        function isKnownCaster() {
            if (!character) return false;
            const cls = character.class?.toLowerCase();
            // Standard known casters
            if (['sorcerer', 'warlock', 'bard', 'ranger'].includes(cls)) return true;
            // Subclass casters (Eldritch Knight, Arcane Trickster)
            if (isSubclassCaster()) return true;
            return false;
        }

        // Check if this is a subclass that grants spellcasting
        function isSubclassCaster() {
            if (!character) return false;
            const cls = character.class?.toLowerCase();
            const subclass = character.subclass?.toLowerCase();

            // Eldritch Knight (Fighter) or Arcane Trickster (Rogue)
            if (cls === 'fighter' && subclass === 'eldritchknight') return true;
            if (cls === 'rogue' && subclass === 'arcanetrickster') return true;
            return false;
        }

        // Get how many spells a known caster should know at their level
        function getSpellsKnownCount() {
            if (!character || !isKnownCaster()) return 0;
            const cls = character.class?.toLowerCase();
            // Check for subclass casters first
            let progression;
            if (isSubclassCaster()) {
                const subclass = character.subclass?.toLowerCase();
                progression = SPELLS_KNOWN_PROGRESSION[subclass];
            } else {
                progression = SPELLS_KNOWN_PROGRESSION[cls];
            }
            if (!progression) return 0;
            return progression[character.level]?.[0] || 0;
        }

        // Get how many cantrips a known caster should know
        function getCantripsKnownCount() {
            if (!character || !isKnownCaster()) return 0;
            let progression;
            if (isSubclassCaster()) {
                const subclass = character.subclass?.toLowerCase();
                progression = SPELLS_KNOWN_PROGRESSION[subclass];
            } else {
                const cls = character.class?.toLowerCase();
                progression = SPELLS_KNOWN_PROGRESSION[cls];
            }
            if (!progression) return 0;
            return progression[character.level]?.[1] || 0;
        }

        // Calculate spells to learn on level up for known casters
        function getNewSpellsOnLevelUp(oldLevel, newLevel) {
            if (!isKnownCaster()) return 0;
            let progression;
            if (isSubclassCaster()) {
                const subclass = character.subclass?.toLowerCase();
                progression = SPELLS_KNOWN_PROGRESSION[subclass];
            } else {
                const cls = character.class?.toLowerCase();
                progression = SPELLS_KNOWN_PROGRESSION[cls];
            }
            if (!progression) return 0;

            const oldKnown = progression[oldLevel]?.[0] || 0;
            const newKnown = progression[newLevel]?.[0] || 0;
            return Math.max(0, newKnown - oldKnown);
        }

        // Get learnable spells for known casters (not in their known list)
        function getLearnableSpellsForKnownCaster(maxLevel) {
            const cls = character.class?.toLowerCase();
            let spellList;

            // Subclass casters use wizard spell list (for EK and AT)
            if (isSubclassCaster()) {
                spellList = CLASS_SPELL_LISTS.wizard || {};
            } else {
                spellList = CLASS_SPELL_LISTS[cls] || {};
            }

            const knownSpells = [];

            // Collect currently known spells
            for (let i = 1; i <= 9; i++) {
                const levelSpells = character.spells?.[`level${i}`] || [];
                knownSpells.push(...levelSpells);
            }

            const learnable = [];
            for (let lvl = 1; lvl <= maxLevel; lvl++) {
                const spellsAtLevel = spellList[lvl] || [];
                spellsAtLevel.forEach(spell => {
                    if (!knownSpells.includes(spell)) {
                        learnable.push({ name: spell, level: lvl });
                    }
                });
            }
            return learnable;
        }

        function showSpellInfo(spellName) {
            const modal = document.getElementById('spellModal');
            const data = SPELL_DESCRIPTIONS[spellName] || SPELL_DATA[spellName];

            // Calculate spell save DC and attack bonus
            const spellcastingAbility = getSpellcastingAbility();
            const abilityMod = getModifier(getAbilityScore(spellcastingAbility));
            const profBonus = getProficiencyBonus();
            const spellSaveDC = 8 + profBonus + abilityMod;
            const spellAttackBonus = profBonus + abilityMod;

            document.getElementById('spellModalTitle').textContent = spellName;

            if (data && data.level) {
                // Full description available
                document.getElementById('spellModalMeta').innerHTML = `
                    <div class="spell-meta-item"><span class="spell-meta-label">Level:</span> ${data.level}</div>
                    <div class="spell-meta-item"><span class="spell-meta-label">School:</span> ${data.school || 'Unknown'}</div>
                    <div class="spell-meta-item"><span class="spell-meta-label">Time:</span> ${data.time || 'Unknown'}</div>
                    <div class="spell-meta-item"><span class="spell-meta-label">Range:</span> ${data.range || 'Unknown'}</div>
                    <div class="spell-meta-item"><span class="spell-meta-label">Components:</span> ${data.components || 'Unknown'}</div>
                    <div class="spell-meta-item"><span class="spell-meta-label">Duration:</span> ${data.duration || 'Unknown'}</div>
                    ${data.concentration ? '<div class="spell-meta-item" style="background:#ff8f00;color:#1a0f07;">Concentration</div>' : ''}
                    ${data.ritual ? '<div class="spell-meta-item" style="background:#1565c0;">Ritual</div>' : ''}
                    <div class="spell-meta-item" style="background:#8e24aa;"><span class="spell-meta-label">Save DC:</span> ${spellSaveDC}</div>
                    <div class="spell-meta-item" style="background:#00897b;"><span class="spell-meta-label">Attack:</span> +${spellAttackBonus}</div>
                `;
                document.getElementById('spellModalDesc').textContent = data.desc || 'No description available.';
                document.getElementById('spellModalFooter').innerHTML = data.higher ? `<strong>At Higher Levels:</strong> ${data.higher}` : '';
            } else if (data) {
                // Only basic data (ritual, concentration, duration)
                document.getElementById('spellModalMeta').innerHTML = `
                    ${data.duration ? `<div class="spell-meta-item"><span class="spell-meta-label">Duration:</span> ${data.duration}</div>` : ''}
                    ${data.concentration ? '<div class="spell-meta-item" style="background:#ff8f00;color:#1a0f07;">Concentration</div>' : ''}
                    ${data.ritual ? '<div class="spell-meta-item" style="background:#1565c0;">Ritual</div>' : ''}
                    <div class="spell-meta-item" style="background:#8e24aa;"><span class="spell-meta-label">Save DC:</span> ${spellSaveDC}</div>
                    <div class="spell-meta-item" style="background:#00897b;"><span class="spell-meta-label">Attack:</span> +${spellAttackBonus}</div>
                `;
                document.getElementById('spellModalDesc').textContent = 'Full description not available. Check your Player\'s Handbook for details.';
                document.getElementById('spellModalFooter').innerHTML = '';
            } else {
                // No data at all
                document.getElementById('spellModalMeta').innerHTML = `
                    <div class="spell-meta-item" style="background:#8e24aa;"><span class="spell-meta-label">Save DC:</span> ${spellSaveDC}</div>
                    <div class="spell-meta-item" style="background:#00897b;"><span class="spell-meta-label">Attack:</span> +${spellAttackBonus}</div>
                `;
                document.getElementById('spellModalDesc').textContent = 'No spell data available. Check your Player\'s Handbook for details.';
                document.getElementById('spellModalFooter').innerHTML = '';
            }

            modal.classList.add('active');
        }

        function closeSpellModal() {
            document.getElementById('spellModal').classList.remove('active');
        }

        // Close modal on background click
        document.getElementById('spellModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeSpellModal();
        });

        function getSpellTags(spellName) {
            const data = SPELL_DATA[spellName];
            if (!data) return '';

            let tags = '';
            if (data.ritual) {
                tags += '<span class="spell-tag ritual">R</span>';
            }
            if (data.concentration) {
                tags += '<span class="spell-tag concentration">C</span>';
            }
            if (data.duration) {
                tags += `<span class="spell-tag duration">${data.duration}</span>`;
            }
            return tags;
        }

        function renderSpells() {
            // Ensure usedLimitedSpells is initialized
            if (!gameState.usedLimitedSpells) gameState.usedLimitedSpells = {};

            const allSpells = [];
            const maxLevel = character.maxSpellLevel || 9;

            // Get granted spells
            const grantedSubclassSpells = character.grantedSpells?.subclass?.spells || [];
            const grantedSubclassCantrips = character.grantedSpells?.subclass?.cantrips || [];
            const grantedFeatSpells = character.grantedSpells?.feats || [];

            // Spell tag legend
            allSpells.push(`
                <div style="font-size: 0.35rem; color: #8b7355; margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <span><span class="spell-tag ritual">R</span> = Ritual</span>
                    <span><span class="spell-tag concentration">C</span> = Concentration</span>
                    <span><span class="spell-tag granted">G</span> = Granted (always prepared)</span>
                </div>
            `);

            // Cantrips (combine regular + subclass granted)
            const regularCantrips = character.spells?.cantrips || [];
            const allCantrips = [...regularCantrips];

            if (allCantrips.length > 0 || grantedSubclassCantrips.length > 0) {
                allSpells.push(`
                    <div class="spell-level-group">
                        <div class="spell-level-title">CANTRIPS (at will)</div>
                        ${allCantrips.map(spell => `
                            <div class="spell-item" data-spell="${spell}" onclick="showSpellInfo(this.dataset.spell)">
                                <span class="spell-name">${spell}</span>
                                <span class="spell-tags">${getSpellTags(spell)}</span>
                            </div>
                        `).join('')}
                        ${grantedSubclassCantrips.map(spell => `
                            <div class="spell-item spell-granted" data-spell="${spell}" onclick="showSpellInfo(this.dataset.spell)">
                                <span class="spell-name">${spell}</span>
                                <span class="spell-tags"><span class="spell-tag granted">G</span>${getSpellTags(spell)}</span>
                            </div>
                        `).join('')}
                    </div>
                `);
            }

            // Feat-granted spells (1/long rest each)
            if (grantedFeatSpells.length > 0) {
                allSpells.push(`
                    <div class="spell-level-group">
                        <div class="spell-level-title">FEAT SPELLS (1/long rest each)</div>
                        ${grantedFeatSpells.map(spell => {
                            const isUsed = gameState.usedLimitedSpells[spell] || false;
                            const escapedSpell = spell.replace(/'/g, '&#39;');
                            return `
                            <div class="spell-item spell-limited ${isUsed ? 'used' : ''}" data-spell="${escapedSpell}">
                                <span class="spell-name" data-spell="${escapedSpell}" onclick="showSpellInfo(this.dataset.spell)">${spell}</span>
                                <span class="spell-tags">
                                    <span class="spell-use-pip ${isUsed ? 'used' : ''}" data-spell="${escapedSpell}" onclick="handleLimitedSpellClick(event, this.dataset.spell)" title="Click to toggle used"></span>
                                    ${getSpellTags(spell)}
                                </span>
                            </div>
                        `}).join('')}
                    </div>
                `);
            }

            // Subclass-granted leveled spells - some have limited uses (like Stars Druid Guiding Bolt = prof bonus/long rest)
            if (grantedSubclassSpells.length > 0) {
                const profBonus = getProficiencyBonus();
                allSpells.push(`
                    <div class="spell-level-group">
                        <div class="spell-level-title">SUBCLASS SPELLS (${profBonus}/long rest, no slot)</div>
                        ${grantedSubclassSpells.map(spell => {
                            const usedCount = gameState.usedLimitedSpells[spell] || 0;
                            const maxUses = profBonus;
                            const escapedSpell = spell.replace(/'/g, '&#39;');
                            return `
                            <div class="spell-item spell-limited ${usedCount >= maxUses ? 'used' : ''}" data-spell="${escapedSpell}" data-max="${maxUses}">
                                <span class="spell-name" data-spell="${escapedSpell}" onclick="showSpellInfo(this.dataset.spell)">${spell}</span>
                                <span class="spell-tags">
                                    <span class="spell-use-pips" data-spell="${escapedSpell}" data-max="${maxUses}" onclick="handleSubclassSpellClick(event, this.dataset.spell, parseInt(this.dataset.max))" title="Click to toggle uses">${Array(maxUses).fill(0).map((_, i) => `<span class="spell-use-pip ${i < usedCount ? 'used' : ''}"></span>`).join('')}</span>
                                    ${getSpellTags(spell)}
                                </span>
                            </div>
                        `}).join('')}
                    </div>
                `);
            }

            // Leveled spells - for prepared casters, show prepared spells; for others, show known spells
            if (isPreparedCaster()) {
                // Group prepared spells by level (using availableSpells to determine level)
                const spellLevelMap = {};
                if (character.availableSpells) {
                    for (let lvl = 1; lvl <= maxLevel; lvl++) {
                        const levelSpells = character.availableSpells[`level${lvl}`] || [];
                        levelSpells.forEach(spell => {
                            spellLevelMap[spell.name] = lvl;
                        });
                    }
                }

                // Group prepared spells by level
                const preparedByLevel = {};
                gameState.preparedSpells.forEach(spell => {
                    const level = spellLevelMap[spell] || 1;
                    if (!preparedByLevel[level]) preparedByLevel[level] = [];
                    preparedByLevel[level].push(spell);
                });

                // Show prepared spells by level
                for (let i = 1; i <= maxLevel; i++) {
                    const levelSpells = preparedByLevel[i] || [];
                    if (levelSpells.length > 0) {
                        allSpells.push(`
                            <div class="spell-level-group" data-slot-level="${i}">
                                <div class="spell-level-title">LEVEL ${i} (PREPARED)</div>
                                ${levelSpells.sort().map(spell => `
                                    <div class="spell-item prepared" data-spell="${spell}" onclick="showSpellInfo(this.dataset.spell)">
                                        <span class="spell-name">${spell}</span>
                                        <span class="spell-tags">${getSpellTags(spell)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `);
                    }
                }

                // Show message if no spells prepared
                if (Object.keys(preparedByLevel).length === 0 && grantedSubclassSpells.length === 0) {
                    allSpells.push(`
                        <div style="color: #8b7355; font-size: 0.4rem; margin-top: 10px; text-align: center;">
                            Use "Manage Prepared Spells" to prepare spells for the day
                        </div>
                    `);
                }
            } else {
                // For known casters (bard, sorcerer, warlock, ranger), show known spells
                for (let i = 1; i <= maxLevel; i++) {
                    const levelSpells = character.spells?.[`level${i}`] || [];
                    if (levelSpells.length > 0) {
                        allSpells.push(`
                            <div class="spell-level-group" data-slot-level="${i}">
                                <div class="spell-level-title">LEVEL ${i}</div>
                                ${levelSpells.map(spell => `
                                    <div class="spell-item" data-spell="${spell}" onclick="showSpellInfo(this.dataset.spell)">
                                        <span class="spell-name">${spell}</span>
                                        <span class="spell-tags">${getSpellTags(spell)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `);
                    }
                }
            }

            if (allSpells.length <= 1) { // Only legend
                return '<div class="spells-section"><div style="color: #6b4423; font-size: 0.45rem;">No spells known</div></div>';
            }

            return `<div class="spells-section">${allSpells.join('')}</div>`;
        }

        // Class and subclass features database
        const CLASS_FEATURES = {
            druid: {
                1: [
                    { name: 'Druidic', desc: 'You know Druidic, the secret language of druids.' },
                    { name: 'Spellcasting', desc: 'You can cast druid spells using Wisdom as your spellcasting ability.' }
                ],
                2: [
                    { name: 'Wild Shape', desc: 'You can use your action to magically assume the shape of a beast you have seen before. You can use this feature twice per short or long rest.', uses: 2, recharge: 'short' }
                ],
                4: [
                    { name: 'Wild Shape Improvement', desc: 'You can transform into beasts with CR 1/2 or lower (no flying speed).' }
                ],
                8: [
                    { name: 'Wild Shape Improvement', desc: 'You can transform into beasts with CR 1 or lower.' }
                ]
            },
            cleric: {
                1: [
                    { name: 'Spellcasting', desc: 'You can cast cleric spells using Wisdom as your spellcasting ability.' }
                ],
                2: [
                    { name: 'Channel Divinity', desc: 'You gain the ability to channel divine energy. You can use this feature once per short or long rest.', uses: 1, recharge: 'short' },
                    { name: 'Channel Divinity: Turn Undead', desc: 'Each undead within 30 feet must make a Wisdom save or be turned for 1 minute.' }
                ],
                5: [
                    { name: 'Destroy Undead', desc: 'When an undead fails its save against Turn Undead, it is instantly destroyed if its CR is 1/2 or lower.' }
                ],
                6: [
                    { name: 'Channel Divinity (2/rest)', desc: 'You can use Channel Divinity twice between rests.', uses: 2, recharge: 'short' }
                ]
            },
            wizard: {
                1: [
                    { name: 'Spellcasting', desc: 'You can cast wizard spells using Intelligence as your spellcasting ability.' },
                    { name: 'Arcane Recovery', desc: 'Once per day during a short rest, you can recover spell slots with a combined level equal to half your wizard level (rounded up).', uses: 1, recharge: 'long' }
                ],
                2: [
                    { name: 'Arcane Tradition', desc: 'You choose an arcane tradition that shapes your magic.' }
                ]
            },
            paladin: {
                1: [
                    { name: 'Divine Sense', desc: 'You can detect celestials, fiends, and undead within 60 feet. Uses: 1 + CHA mod per long rest.', uses: 'cha+1', recharge: 'long' },
                    { name: 'Lay on Hands', desc: 'You have a pool of healing power equal to 5  paladin level. You can restore HP or cure disease/poison.', uses: 'pool', recharge: 'long' }
                ],
                2: [
                    { name: 'Fighting Style', desc: 'You adopt a fighting style specialty.' },
                    { name: 'Spellcasting', desc: 'You can cast paladin spells using Charisma as your spellcasting ability.' },
                    { name: 'Divine Smite', desc: 'When you hit with a melee weapon, you can expend a spell slot to deal 2d8 + 1d8 per slot level above 1st radiant damage.' }
                ],
                3: [
                    { name: 'Divine Health', desc: 'You are immune to disease.' },
                    { name: 'Sacred Oath', desc: 'You swear an oath that binds you as a paladin.' }
                ]
            },
            fighter: {
                1: [
                    { name: 'Fighting Style', desc: 'You adopt a fighting style specialty.' },
                    { name: 'Second Wind', desc: 'On your turn, you can use a bonus action to regain 1d10 + fighter level HP. Once per short or long rest.', uses: 1, recharge: 'short' }
                ],
                2: [
                    { name: 'Action Surge', desc: 'You can take one additional action on your turn. Once per short or long rest.', uses: 1, recharge: 'short' }
                ],
                3: [
                    { name: 'Martial Archetype', desc: 'You choose an archetype that defines your martial techniques.' }
                ]
            }
        };

        const SUBCLASS_FEATURES = {
            stars: {  // Circle of Stars Druid
                2: [
                    { name: 'Star Map', desc: 'You have a star chart that serves as a spellcasting focus. You learn Guidance cantrip and Guiding Bolt, which you can cast without expending a spell slot a number of times equal to your proficiency bonus per long rest.' },
                    { name: 'Starry Form', desc: 'As a bonus action, you can expend a use of Wild Shape to take a starry form for 10 minutes. Choose Archer (bonus action ranged attack 1d8+WIS radiant), Chalice (heal 1d8+WIS when casting healing spell), or Dragon (minimum 10 on concentration checks, Fly 20ft hover).', uses: 2, recharge: 'short' }
                ],
                6: [
                    { name: 'Cosmic Omen', desc: 'After a long rest, roll a die. If even (Weal): reaction to add 1d6 to an ally\'s roll. If odd (Woe): reaction to subtract 1d6 from enemy\'s roll. Uses: proficiency bonus per long rest.', uses: 'prof', recharge: 'long' }
                ],
                10: [
                    { name: 'Twinkling Constellations', desc: 'Your starry form constellations improve. You can also change constellation at the start of each turn.' }
                ],
                14: [
                    { name: 'Full of Stars', desc: 'While in Starry Form, you have resistance to bludgeoning, piercing, and slashing damage.' }
                ]
            },
            life: {  // Life Domain Cleric
                1: [
                    { name: 'Bonus Proficiency', desc: 'You gain proficiency with heavy armor.' },
                    { name: 'Disciple of Life', desc: 'When you cast a healing spell, the target regains additional HP equal to 2 + the spell\'s level.' }
                ],
                2: [
                    { name: 'Channel Divinity: Preserve Life', desc: 'As an action, restore HP equal to 5  cleric level, divided among creatures within 30 feet.' }
                ],
                6: [
                    { name: 'Blessed Healer', desc: 'When you cast a healing spell on another creature, you regain HP equal to 2 + spell level.' }
                ]
            },
            champion: {  // Champion Fighter
                3: [
                    { name: 'Improved Critical', desc: 'Your weapon attacks score a critical hit on a roll of 19 or 20.' }
                ],
                7: [
                    { name: 'Remarkable Athlete', desc: 'Add half your proficiency bonus to STR, DEX, and CON checks that don\'t already use your proficiency.' }
                ],
                10: [
                    { name: 'Additional Fighting Style', desc: 'You learn a second Fighting Style option.' }
                ]
            },
            battlemaster: {  // Battle Master Fighter
                3: [
                    { name: 'Combat Superiority', desc: 'You learn maneuvers powered by superiority dice (d8). You have 4 superiority dice, regained on short or long rest.', uses: 4, recharge: 'short' },
                    { name: 'Student of War', desc: 'You gain proficiency with one type of artisan\'s tools.' }
                ],
                7: [
                    { name: 'Know Your Enemy', desc: 'Spend 1 minute observing a creature to learn if it is equal, superior, or inferior to you in various aspects.' }
                ]
            },
            // ===== WIZARD SCHOOLS =====
            evocation: {  // School of Evocation Wizard
                2: [
                    { name: 'Evocation Savant', desc: 'Gold and time to copy evocation spells into your spellbook is halved.' },
                    { name: 'Sculpt Spells', desc: 'When you cast an evocation spell that affects other creatures you can see, choose a number of them equal to 1 + the spell\'s level. Those creatures automatically succeed on their saves and take no damage from the spell.' }
                ],
                6: [
                    { name: 'Potent Cantrip', desc: 'When a creature succeeds on a saving throw against your cantrip, the creature takes half the cantrip\'s damage (if any) but suffers no additional effect.' }
                ],
                10: [
                    { name: 'Empowered Evocation', desc: 'Add your Intelligence modifier to one damage roll of any wizard evocation spell you cast.' }
                ],
                14: [
                    { name: 'Overchannel', desc: 'When you cast a wizard spell of 1st-5th level that deals damage, you can deal maximum damage. If you use this again before a long rest, you take 2d12 necrotic damage per spell level (increasing by 1d12 each subsequent use).' }
                ]
            },
            abjuration: {  // School of Abjuration Wizard
                2: [
                    { name: 'Abjuration Savant', desc: 'Gold and time to copy abjuration spells into your spellbook is halved.' },
                    { name: 'Arcane Ward', desc: 'When you cast an abjuration spell of 1st level or higher, you create a magical ward with HP equal to twice your wizard level + INT modifier. When you take damage, the ward takes damage first. Casting abjuration spells restores HP to the ward equal to twice the spell\'s level.' }
                ],
                6: [
                    { name: 'Projected Ward', desc: 'When a creature you can see within 30 feet takes damage, you can use your reaction to have your Arcane Ward absorb that damage instead.' }
                ],
                10: [
                    { name: 'Improved Abjuration', desc: 'When you cast an abjuration spell requiring an ability check (like Counterspell or Dispel Magic), add your proficiency bonus to that check.' }
                ],
                14: [
                    { name: 'Spell Resistance', desc: 'You have advantage on saving throws against spells. You also have resistance against the damage of spells.' }
                ]
            },
            conjuration: {  // School of Conjuration Wizard
                2: [
                    { name: 'Conjuration Savant', desc: 'Gold and time to copy conjuration spells into your spellbook is halved.' },
                    { name: 'Minor Conjuration', desc: 'As an action, conjure an inanimate object (no larger than 3 feet, no heavier than 10 lbs) in your hand or on the ground. It is visibly magical, sheds dim light 5 ft, and disappears after 1 hour or if it deals/takes damage.' }
                ],
                6: [
                    { name: 'Benign Transposition', desc: 'As an action, teleport up to 30 feet to an unoccupied space you can see, OR swap places with a willing Small or Medium creature within 30 feet. Recharges when you cast a conjuration spell of 1st level or higher.', uses: 1, recharge: 'special' }
                ],
                10: [
                    { name: 'Focused Conjuration', desc: 'Your concentration on a conjuration spell can\'t be broken as a result of taking damage.' }
                ],
                14: [
                    { name: 'Durable Summons', desc: 'Any creature you summon or create with a conjuration spell has 30 temporary hit points.' }
                ]
            },
            divination: {  // School of Divination Wizard
                2: [
                    { name: 'Divination Savant', desc: 'Gold and time to copy divination spells into your spellbook is halved.' },
                    { name: 'Portent', desc: 'After a long rest, roll two d20s and record the numbers. You can replace any attack roll, saving throw, or ability check made by you or a creature you can see with one of these rolls. You must choose before the roll. Each portent roll can be used only once.', uses: 2, recharge: 'long' }
                ],
                6: [
                    { name: 'Expert Divination', desc: 'When you cast a divination spell of 2nd level or higher using a spell slot, you regain one expended spell slot of a level lower than the spell cast (max 5th level).' }
                ],
                10: [
                    { name: 'The Third Eye', desc: 'As an action, gain one benefit until you are incapacitated or take a short/long rest: Darkvision 60ft, Ethereal Sight 60ft, Greater Comprehension (read any language), or See Invisibility 10ft.', uses: 1, recharge: 'short' }
                ],
                14: [
                    { name: 'Greater Portent', desc: 'You roll three d20s for your Portent feature, rather than two.', replaces: 'Portent' }
                ]
            },
            enchantment: {  // School of Enchantment Wizard
                2: [
                    { name: 'Enchantment Savant', desc: 'Gold and time to copy enchantment spells into your spellbook is halved.' },
                    { name: 'Hypnotic Gaze', desc: 'As an action, choose one creature within 5 feet. If it can see or hear you, it must make a WIS save or be charmed and incapacitated (speed 0) until end of your next turn. You can use your action each turn to maintain this effect. Ends if you move more than 5 feet away, the creature can\'t see or hear you, or takes damage.' }
                ],
                6: [
                    { name: 'Instinctive Charm', desc: 'When a creature you can see within 30 feet attacks you, you can use your reaction to redirect the attack to another creature within range (not the attacker). The attacker must make a WIS save or attack the new target. Recharges on long rest or when you don\'t use it.', uses: 1, recharge: 'long' }
                ],
                10: [
                    { name: 'Split Enchantment', desc: 'When you cast an enchantment spell of 1st level or higher that targets only one creature, you can have it target a second creature.' }
                ],
                14: [
                    { name: 'Alter Memories', desc: 'When you cast an enchantment spell that charms one or more creatures, you can alter one creature\'s understanding so it doesn\'t know it was charmed. Additionally, before the spell ends, you can use an action to make the creature forget some of the time it was charmed (up to 1 + CHA mod hours, minimum 1).' }
                ]
            },
            illusion: {  // School of Illusion Wizard
                2: [
                    { name: 'Illusion Savant', desc: 'Gold and time to copy illusion spells into your spellbook is halved.' },
                    { name: 'Improved Minor Illusion', desc: 'You learn the Minor Illusion cantrip (doesn\'t count against cantrips known). When you cast it, you can create both a sound and an image with a single casting.' }
                ],
                6: [
                    { name: 'Malleable Illusions', desc: 'When you cast an illusion spell with a duration of 1 minute or longer, you can use your action to change the nature of that illusion (using the spell\'s normal parameters).' }
                ],
                10: [
                    { name: 'Illusory Self', desc: 'When a creature makes an attack roll against you, you can use your reaction to create an illusory duplicate that causes the attack to miss. Recharges on short or long rest.', uses: 1, recharge: 'short' }
                ],
                14: [
                    { name: 'Illusory Reality', desc: 'When you cast an illusion spell of 1st level or higher, you can choose one inanimate, nonmagical object that is part of the illusion and make it real for 1 minute. The object can\'t deal damage or directly harm anyone.' }
                ]
            },
            necromancy: {  // School of Necromancy Wizard
                2: [
                    { name: 'Necromancy Savant', desc: 'Gold and time to copy necromancy spells into your spellbook is halved.' },
                    { name: 'Grim Harvest', desc: 'When you kill one or more creatures with a spell of 1st level or higher, you regain HP equal to twice the spell\'s level (or three times if it\'s a necromancy spell). Doesn\'t work on constructs or undead.' }
                ],
                6: [
                    { name: 'Undead Thralls', desc: 'You learn Animate Dead (doesn\'t count against spells known). When you cast Animate Dead, you can target one additional corpse or pile of bones. Undead you create have additional HP equal to your wizard level, and add your proficiency bonus to weapon damage rolls.' }
                ],
                10: [
                    { name: 'Inured to Undeath', desc: 'You have resistance to necrotic damage. Your hit point maximum can\'t be reduced by effects from undead creatures.' }
                ],
                14: [
                    { name: 'Command Undead', desc: 'As an action, target one undead within 60 feet. It must make a CHA save or obey your commands. Intelligent undead (INT 8+) have advantage and can repeat the save when taking damage. The effect lasts until you use this feature again.' }
                ]
            },
            transmutation: {  // School of Transmutation Wizard
                2: [
                    { name: 'Transmutation Savant', desc: 'Gold and time to copy transmutation spells into your spellbook is halved.' },
                    { name: 'Minor Alchemy', desc: 'Spend 10 minutes to temporarily transform one nonmagical object (wood, stone, iron, copper, or silver) into another of those materials. Lasts 1 hour or until you lose concentration.' }
                ],
                6: [
                    { name: 'Transmuter\'s Stone', desc: 'Spend 8 hours to create a transmuter\'s stone. While holding it, a creature gains one benefit you choose: Darkvision 60ft, +10 speed, proficiency in CON saves, or resistance to acid/cold/fire/lightning/thunder damage. You can change the benefit when you cast a transmutation spell of 1st level or higher.' }
                ],
                10: [
                    { name: 'Shapechanger', desc: 'You add Polymorph to your spellbook (doesn\'t count against spells known). When you cast Polymorph, you can target yourself and transform into a beast with CR equal to your level or lower.' }
                ],
                14: [
                    { name: 'Master Transmuter', desc: 'As an action, consume your transmuter\'s stone to choose one effect: Panacea (remove curses, diseases, poisons; heal all HP), Restore Life (cast Raise Dead without material components), Restore Youth (reduce apparent age by 3d10 years), or Major Transformation (transform one object worth no more than 5 gp into another of equal value).' }
                ]
            },
            // ===== BARBARIAN PATHS =====
            berserker: {
                3: [
                    { name: 'Frenzy', desc: 'You can go into a frenzy when you rage. While frenzied, you can make a single melee weapon attack as a bonus action on each turn. When your rage ends, you suffer one level of exhaustion.' }
                ],
                6: [
                    { name: 'Mindless Rage', desc: 'You can\'t be charmed or frightened while raging. If you are charmed or frightened when you enter rage, the effect is suspended for the duration.' }
                ],
                10: [
                    { name: 'Intimidating Presence', desc: 'As an action, frighten one creature within 30 feet that can see or hear you. WIS save (DC 8 + prof + CHA) or frightened until end of your next turn. Can extend each turn as an action.' }
                ],
                14: [
                    { name: 'Retaliation', desc: 'When you take damage from a creature within 5 feet, you can use your reaction to make a melee weapon attack against that creature.' }
                ]
            },
            totem: {
                3: [
                    { name: 'Spirit Seeker', desc: 'You can cast Beast Sense and Speak with Animals as rituals.' },
                    { name: 'Totem Spirit', desc: 'Choose Bear (resistance to all damage except psychic while raging), Eagle (enemies have disadvantage on opportunity attacks, can Dash as bonus action), or Wolf (allies have advantage on melee attacks against enemies within 5 ft of you).' }
                ],
                6: [
                    { name: 'Aspect of the Beast', desc: 'Choose Bear (carrying capacity doubled, advantage on STR checks to push/pull/lift), Eagle (see up to 1 mile clearly, dim light doesn\'t impose disadvantage on Perception), or Wolf (track creatures at fast pace, move stealthily at normal pace).' }
                ],
                10: [
                    { name: 'Spirit Walker', desc: 'You can cast Commune with Nature as a ritual.' }
                ],
                14: [
                    { name: 'Totemic Attunement', desc: 'Choose Bear (while raging, enemies within 5 ft have disadvantage on attacks against allies), Eagle (gain flying speed equal to walking speed while raging), or Wolf (while raging, use bonus action to knock Large or smaller creature prone on hit).' }
                ]
            },
            zealot: {
                3: [
                    { name: 'Divine Fury', desc: 'While raging, first creature you hit each turn takes extra 1d6 + half barbarian level radiant or necrotic damage (your choice).' },
                    { name: 'Warrior of the Gods', desc: 'Spells to restore you to life (not Revivify) don\'t require material components.' }
                ],
                6: [
                    { name: 'Fanatical Focus', desc: 'If you fail a saving throw while raging, you can reroll it and must use the new roll. Once per rage.', uses: 1, recharge: 'special' }
                ],
                10: [
                    { name: 'Zealous Presence', desc: 'As a bonus action, up to 10 creatures within 60 feet gain advantage on attack rolls and saving throws until start of your next turn. Once per long rest.', uses: 1, recharge: 'long' }
                ],
                14: [
                    { name: 'Rage Beyond Death', desc: 'While raging, dropping to 0 HP doesn\'t knock you unconscious. You still make death saves, and only die if you would die from failed saves AND your rage ends.' }
                ]
            },
            ancestral: {
                3: [
                    { name: 'Ancestral Protectors', desc: 'While raging, the first creature you hit on your turn has disadvantage on attacks against anyone but you, and others have resistance to its damage. Lasts until start of your next turn.' }
                ],
                6: [
                    { name: 'Spirit Shield', desc: 'If you\'re raging and an ally within 30 feet takes damage, you can reduce it by 2d6 as a reaction. Increases to 3d6 at 10th level and 4d6 at 14th level.' }
                ],
                10: [
                    { name: 'Consult the Spirits', desc: 'Cast Augury or Clairvoyance without material components. After casting, can\'t do so again until you finish a short or long rest.' }
                ],
                14: [
                    { name: 'Vengeful Ancestors', desc: 'When you use Spirit Shield to reduce damage, the attacker takes force damage equal to the damage prevented.' }
                ]
            },
            // ===== BARD COLLEGES =====
            lore: {
                3: [
                    { name: 'Bonus Proficiencies', desc: 'You gain proficiency with three skills of your choice.' },
                    { name: 'Cutting Words', desc: 'When a creature you can see within 60 feet makes an attack roll, ability check, or damage roll, you can use your reaction to expend a Bardic Inspiration die and subtract the number rolled from the creature\'s roll.' }
                ],
                6: [
                    { name: 'Additional Magical Secrets', desc: 'You learn two spells of your choice from any class. The spells must be of a level you can cast.' }
                ],
                14: [
                    { name: 'Peerless Skill', desc: 'When you make an ability check, you can expend one Bardic Inspiration die, roll it, and add to your ability check. You can do so after rolling but before knowing success or failure.' }
                ]
            },
            valor: {
                3: [
                    { name: 'Bonus Proficiencies', desc: 'You gain proficiency with medium armor, shields, and martial weapons.' },
                    { name: 'Combat Inspiration', desc: 'A creature that has a Bardic Inspiration die can add it to a weapon damage roll, or add it to AC as a reaction when hit (potentially causing the attack to miss).' }
                ],
                6: [
                    { name: 'Extra Attack', desc: 'You can attack twice, instead of once, whenever you take the Attack action on your turn.' }
                ],
                14: [
                    { name: 'Battle Magic', desc: 'When you use your action to cast a bard spell, you can make one weapon attack as a bonus action.' }
                ]
            },
            swords: {
                3: [
                    { name: 'Bonus Proficiencies', desc: 'You gain proficiency with medium armor and the scimitar. You can use a weapon as a spellcasting focus for bard spells.' },
                    { name: 'Fighting Style', desc: 'Choose Dueling (+2 damage with one-handed weapon) or Two-Weapon Fighting (add ability modifier to off-hand damage).' },
                    { name: 'Blade Flourish', desc: 'When you take the Attack action, your speed increases by 10 feet. Once per turn when you hit, you can expend a Bardic Inspiration for Defensive (+die to AC), Slashing (+die damage to another creature within 5 ft), or Mobile Flourish (+die damage and push, can move to follow).' }
                ],
                6: [
                    { name: 'Extra Attack', desc: 'You can attack twice, instead of once, whenever you take the Attack action on your turn.' }
                ],
                14: [
                    { name: 'Master\'s Flourish', desc: 'When you use a Blade Flourish, you can roll a d6 instead of expending a Bardic Inspiration die.' }
                ]
            },
            eloquence: {
                3: [
                    { name: 'Silver Tongue', desc: 'When you make a Charisma (Persuasion) or Charisma (Deception) check, you can treat a d20 roll of 9 or lower as a 10.' },
                    { name: 'Unsettling Words', desc: 'As a bonus action, expend one Bardic Inspiration and choose a creature within 60 feet. Subtract the die from its next saving throw before your next turn.' }
                ],
                6: [
                    { name: 'Unfailing Inspiration', desc: 'When a creature adds your Bardic Inspiration die to an ability check, attack roll, or saving throw and fails, they can keep the die.' },
                    { name: 'Universal Speech', desc: 'As an action, choose up to your CHA modifier creatures within 60 feet. They understand you for 1 hour, regardless of language.', uses: 1, recharge: 'long' }
                ],
                14: [
                    { name: 'Infectious Inspiration', desc: 'When a creature within 60 feet uses your Bardic Inspiration die and succeeds, you can use your reaction to give Bardic Inspiration to a different creature without expending a use. Uses: CHA modifier per long rest.' }
                ]
            },
            // ===== CLERIC DOMAINS =====
            light: {
                1: [
                    { name: 'Bonus Cantrip', desc: 'You gain the Light cantrip if you don\'t already know it.' },
                    { name: 'Warding Flare', desc: 'When attacked by a creature within 30 feet that you can see, use your reaction to impose disadvantage on the attack roll. Uses: WIS modifier per long rest.', uses: 'wis', recharge: 'long' }
                ],
                2: [
                    { name: 'Channel Divinity: Radiance of the Dawn', desc: 'As an action, dispel magical darkness within 30 feet. Each hostile creature within 30 feet takes 2d10 + cleric level radiant damage (CON save for half).' }
                ],
                6: [
                    { name: 'Improved Flare', desc: 'You can use Warding Flare when a creature you can see within 30 feet attacks a creature other than you.' }
                ],
                8: [
                    { name: 'Potent Spellcasting', desc: 'Add your WIS modifier to the damage you deal with any cleric cantrip.' }
                ],
                17: [
                    { name: 'Corona of Light', desc: 'As an action, activate an aura of sunlight (60-ft radius bright, 30-ft dim) for 1 minute. Enemies in bright light have disadvantage on saves vs fire or radiant spells.' }
                ]
            },
            tempest: {
                1: [
                    { name: 'Bonus Proficiencies', desc: 'You gain proficiency with martial weapons and heavy armor.' },
                    { name: 'Wrath of the Storm', desc: 'When a creature within 5 feet hits you, you can use your reaction to deal 2d8 lightning or thunder damage (DEX save for half). Uses: WIS modifier per long rest.', uses: 'wis', recharge: 'long' }
                ],
                2: [
                    { name: 'Channel Divinity: Destructive Wrath', desc: 'When you roll lightning or thunder damage, you can deal maximum damage instead of rolling.' }
                ],
                6: [
                    { name: 'Thunderbolt Strike', desc: 'When you deal lightning damage to a Large or smaller creature, you can also push it up to 10 feet away from you.' }
                ],
                8: [
                    { name: 'Divine Strike', desc: 'Once per turn when you hit with a weapon attack, deal an extra 1d8 thunder damage. Increases to 2d8 at 14th level.' }
                ],
                17: [
                    { name: 'Stormborn', desc: 'You have a flying speed equal to your walking speed whenever you are outdoors.' }
                ]
            },
            war: {
                1: [
                    { name: 'Bonus Proficiencies', desc: 'You gain proficiency with martial weapons and heavy armor.' },
                    { name: 'War Priest', desc: 'When you take the Attack action, you can make one weapon attack as a bonus action. Uses: WIS modifier per long rest.', uses: 'wis', recharge: 'long' }
                ],
                2: [
                    { name: 'Channel Divinity: Guided Strike', desc: 'When you make an attack roll, you can use your Channel Divinity to gain a +10 bonus to the roll. You make this choice after you see the roll.' }
                ],
                6: [
                    { name: 'Channel Divinity: War God\'s Blessing', desc: 'When a creature within 30 feet makes an attack roll, you can use your reaction to grant +10 to the roll.' }
                ],
                8: [
                    { name: 'Divine Strike', desc: 'Once per turn when you hit with a weapon attack, deal an extra 1d8 damage of the same type. Increases to 2d8 at 14th level.' }
                ],
                17: [
                    { name: 'Avatar of Battle', desc: 'You have resistance to bludgeoning, piercing, and slashing damage from nonmagical weapons.' }
                ]
            },
            knowledge: {
                1: [
                    { name: 'Blessings of Knowledge', desc: 'You learn two languages and gain proficiency in two skills from: Arcana, History, Nature, or Religion. Your proficiency bonus is doubled for checks with those skills.' }
                ],
                2: [
                    { name: 'Channel Divinity: Knowledge of the Ages', desc: 'As an action, gain proficiency with one skill or tool for 10 minutes.' }
                ],
                6: [
                    { name: 'Channel Divinity: Read Thoughts', desc: 'As an action, choose a creature within 60 feet. WIS save or you read its surface thoughts for 1 minute. While reading, you can cast Suggestion without a slot.' }
                ],
                8: [
                    { name: 'Potent Spellcasting', desc: 'Add your WIS modifier to the damage you deal with any cleric cantrip.' }
                ],
                17: [
                    { name: 'Visions of the Past', desc: 'Spend 1 minute meditating to receive dreamlike visions about an object you hold or your immediate surroundings. Once per short rest.' }
                ]
            },
            grave: {
                1: [
                    { name: 'Circle of Mortality', desc: 'When you would roll dice to restore HP with a spell to a creature at 0 HP, use the maximum instead. You learn Spare the Dying (bonus action, 30 ft range).' },
                    { name: 'Eyes of the Grave', desc: 'As an action, sense undead within 60 feet not behind total cover. Uses: WIS modifier per long rest.', uses: 'wis', recharge: 'long' }
                ],
                2: [
                    { name: 'Channel Divinity: Path to the Grave', desc: 'As an action, curse one creature within 30 feet. The next attack against it has advantage and deals double damage if it hits.' }
                ],
                6: [
                    { name: 'Sentinel at Death\'s Door', desc: 'As a reaction, turn a critical hit against you or an ally within 30 feet into a normal hit. Uses: WIS modifier per long rest.', uses: 'wis', recharge: 'long' }
                ],
                8: [
                    { name: 'Potent Spellcasting', desc: 'Add your WIS modifier to the damage you deal with any cleric cantrip.' }
                ],
                17: [
                    { name: 'Keeper of Souls', desc: 'When an enemy dies within 60 feet, you or an ally within 60 feet regains HP equal to the enemy\'s number of Hit Dice. Once per round.' }
                ]
            },
            // ===== DRUID CIRCLES =====
            land: {
                2: [
                    { name: 'Bonus Cantrip', desc: 'You learn one additional druid cantrip of your choice.' },
                    { name: 'Natural Recovery', desc: 'During a short rest, you can recover spell slots with a combined level equal to half your druid level (rounded up). No slot can be 6th level or higher. Once per long rest.', uses: 1, recharge: 'long' }
                ],
                3: [
                    { name: 'Circle Spells', desc: 'You gain access to circle spells based on your chosen land: Arctic, Coast, Desert, Forest, Grassland, Mountain, Swamp, or Underdark. These spells are always prepared and don\'t count against your prepared spells.' }
                ],
                6: [
                    { name: 'Land\'s Stride', desc: 'Moving through nonmagical difficult terrain costs no extra movement. You can pass through nonmagical plants without being slowed or taking damage. Advantage on saves vs magically created/manipulated plants.' }
                ],
                10: [
                    { name: 'Nature\'s Ward', desc: 'You can\'t be charmed or frightened by elementals or fey, and you\'re immune to poison and disease.' }
                ],
                14: [
                    { name: 'Nature\'s Sanctuary', desc: 'Beasts and plant creatures must make a WIS save to attack you. On a failed save, they must choose a different target or the attack misses.' }
                ]
            },
            moon: {
                2: [
                    { name: 'Combat Wild Shape', desc: 'You can use Wild Shape as a bonus action. While transformed, you can use a bonus action to expend a spell slot and regain 1d8 HP per slot level.' },
                    { name: 'Circle Forms', desc: 'You can transform into beasts with CR 1 (instead of CR 1/4). At 6th level, CR equals druid level  3, rounded down.' }
                ],
                6: [
                    { name: 'Primal Strike', desc: 'Your attacks in beast form count as magical for overcoming resistance and immunity.' }
                ],
                10: [
                    { name: 'Elemental Wild Shape', desc: 'You can expend two uses of Wild Shape to transform into an air, earth, fire, or water elemental.' }
                ],
                14: [
                    { name: 'Thousand Forms', desc: 'You can cast Alter Self at will.' }
                ]
            },
            shepherd: {
                2: [
                    { name: 'Speech of the Woods', desc: 'You can speak with beasts and learn Sylvan.' },
                    { name: 'Spirit Totem', desc: 'As a bonus action, summon an incorporeal spirit to a point within 60 feet (30-ft aura). Bear Spirit (temp HP = 5 + druid level), Hawk Spirit (advantage on Perception, advantage on attacks vs enemies in aura), or Unicorn Spirit (advantage on healing detection, healing spells heal extra HP = druid level).' }
                ],
                6: [
                    { name: 'Mighty Summoner', desc: 'Beasts and fey you summon gain +2 HP per Hit Die and their natural weapons count as magical.' }
                ],
                10: [
                    { name: 'Guardian Spirit', desc: 'Beasts and fey you summon regain HP equal to half your druid level when they end their turn in your Spirit Totem aura.' }
                ],
                14: [
                    { name: 'Faithful Summons', desc: 'If you drop to 0 HP or are incapacitated, you can immediately summon four beasts of CR 2 or lower within 20 feet. They are friendly and defend you. Once per long rest.', uses: 1, recharge: 'long' }
                ]
            },
            wildfire: {
                2: [
                    { name: 'Summon Wildfire Spirit', desc: 'As an action, expend a use of Wild Shape to summon a wildfire spirit. Each creature of your choice within 10 feet of the spirit takes 2d6 fire damage. The spirit obeys your commands and acts on your turn.', uses: 2, recharge: 'short' },
                    { name: 'Enhanced Bond', desc: 'When you cast a spell that deals fire damage or restores HP while your wildfire spirit is summoned, roll a d8 and gain a bonus to one damage or healing roll equal to the number rolled.' }
                ],
                6: [
                    { name: 'Fiery Teleportation', desc: 'When the wildfire spirit is summoned or as a bonus action on your turn, the spirit can teleport you and allies (willing, within 5 ft of spirit) up to 15 feet to unoccupied spaces within 5 ft of where the spirit lands. Creatures adjacent to the origin take 1d6 + PB fire damage.' }
                ],
                10: [
                    { name: 'Flames of Life', desc: 'When a Small or larger creature dies within 30 feet of you or your wildfire spirit, a harmless flame springs up in the dead creature\'s space and flickers there for 1 minute. As a reaction when you see the spectral flame, you cause the creature to regain HP equal to 2d10 + your WIS modifier.' }
                ],
                14: [
                    { name: 'Blazing Revival', desc: 'If your wildfire spirit is within 120 feet when you drop to 0 HP, you can cause the spirit to drop to 0 HP and you regain half your HP and rise to your feet. Once per long rest.', uses: 1, recharge: 'long' }
                ]
            },
            // ===== FIGHTER ARCHETYPES =====
            eldritchknight: {
                3: [
                    { name: 'Spellcasting', desc: 'You can cast wizard spells (abjuration and evocation, plus any school for some slots). Intelligence is your spellcasting ability.' },
                    { name: 'Weapon Bond', desc: 'You can bond with up to two weapons. You can\'t be disarmed of a bonded weapon and can summon it to your hand as a bonus action.' }
                ],
                7: [
                    { name: 'War Magic', desc: 'When you use your action to cast a cantrip, you can make one weapon attack as a bonus action.' }
                ],
                10: [
                    { name: 'Eldritch Strike', desc: 'When you hit a creature with a weapon attack, that creature has disadvantage on the next saving throw it makes against a spell you cast before the end of your next turn.' }
                ],
                15: [
                    { name: 'Arcane Charge', desc: 'When you use Action Surge, you can teleport up to 30 feet to an unoccupied space you can see.' }
                ],
                18: [
                    { name: 'Improved War Magic', desc: 'When you use your action to cast a spell, you can make one weapon attack as a bonus action.' }
                ]
            },
            samurai: {
                3: [
                    { name: 'Bonus Proficiency', desc: 'You gain proficiency in one of: History, Insight, Performance, or Persuasion.' },
                    { name: 'Fighting Spirit', desc: 'As a bonus action, gain advantage on all weapon attack rolls and 5 temporary HP (10 at 10th, 15 at 15th) until end of turn. Three uses per long rest.', uses: 3, recharge: 'long' }
                ],
                7: [
                    { name: 'Elegant Courtier', desc: 'Add your WIS modifier to Charisma (Persuasion) checks. You also gain proficiency in WIS saves, or INT or CHA saves if you already have WIS.' }
                ],
                10: [
                    { name: 'Tireless Spirit', desc: 'When you roll initiative and have no uses of Fighting Spirit, you regain one use.' }
                ],
                15: [
                    { name: 'Rapid Strike', desc: 'If you have advantage on a weapon attack and hit, you can forgo the advantage to make an additional attack against the same target. Once per turn.' }
                ],
                18: [
                    { name: 'Strength Before Death', desc: 'If you drop to 0 HP, you can delay falling unconscious and immediately take an extra turn. If you still have 0 HP at the end of that turn, you fall unconscious. Once per long rest.', uses: 1, recharge: 'long' }
                ]
            },
            cavalier: {
                3: [
                    { name: 'Bonus Proficiency', desc: 'You gain proficiency in Animal Handling, History, Insight, Performance, or Persuasion; or learn one language.' },
                    { name: 'Born to the Saddle', desc: 'Mounting/dismounting costs only 5 feet. Advantage on saves to avoid falling off mount. You land on your feet if you fall less than 10 feet and aren\'t incapacitated.' },
                    { name: 'Unwavering Mark', desc: 'When you hit a creature with a melee weapon attack, you can mark it until the end of your next turn. While marked, it has disadvantage on attacks against anyone but you, and you can make a bonus action attack against it if it deals damage to anyone else (adds half fighter level damage).' }
                ],
                7: [
                    { name: 'Warding Maneuver', desc: 'If you or a creature within 5 feet is hit, you can use your reaction to add 1d8 to AC and grant resistance if it still hits. Uses: CON modifier per long rest.', uses: 'con', recharge: 'long' }
                ],
                10: [
                    { name: 'Hold the Line', desc: 'Creatures provoke opportunity attacks when moving 5 feet or more within your reach. On hit, the target\'s speed becomes 0.' }
                ],
                15: [
                    { name: 'Ferocious Charger', desc: 'If you move 10+ feet in a straight line before attacking, the target must make a STR save or be knocked prone (bonus action attack vs prone target).' }
                ],
                18: [
                    { name: 'Vigilant Defender', desc: 'You get a special reaction for opportunity attacks on every creature\'s turn (not your own). You can\'t use it on a creature if you\'ve already used a reaction on its turn.' }
                ]
            },
            // ===== MONK TRADITIONS =====
            openhand: {
                3: [
                    { name: 'Open Hand Technique', desc: 'When you hit with a Flurry of Blows attack, you can impose one effect: knocked prone (DEX save), pushed 15 ft (STR save), or can\'t take reactions until end of your next turn.' }
                ],
                6: [
                    { name: 'Wholeness of Body', desc: 'As an action, regain HP equal to 3 your monk level. Once per long rest.', uses: 1, recharge: 'long' }
                ],
                11: [
                    { name: 'Tranquility', desc: 'At the end of a long rest, gain the effect of a Sanctuary spell (WIS save DC) until the start of your next long rest. Ends early if you attack or cast a spell affecting an enemy.' }
                ],
                17: [
                    { name: 'Quivering Palm', desc: 'When you hit with an unarmed strike, spend 3 ki points to start vibrations that last for days equal to your monk level. As an action, you can end them: CON save or reduced to 0 HP; on success, 10d10 necrotic damage.' }
                ]
            },
            shadow: {
                3: [
                    { name: 'Shadow Arts', desc: 'You can spend 2 ki points to cast Darkness, Darkvision, Pass without Trace, or Silence. You learn the Minor Illusion cantrip.' }
                ],
                6: [
                    { name: 'Shadow Step', desc: 'When in dim light or darkness, as a bonus action you can teleport up to 60 feet to an unoccupied space you can see that is also in dim light or darkness. You have advantage on the first melee attack you make before the end of the turn.' }
                ],
                11: [
                    { name: 'Cloak of Shadows', desc: 'When in dim light or darkness, you can use your action to become invisible. You remain invisible until you attack, cast a spell, or are in bright light.' }
                ],
                17: [
                    { name: 'Opportunist', desc: 'When a creature within 5 feet is hit by an attack made by someone other than you, you can use your reaction to make a melee attack against that creature.' }
                ]
            },
            mercy: {
                3: [
                    { name: 'Implements of Mercy', desc: 'You gain proficiency with the herbalism kit and the Insight and Medicine skills.' },
                    { name: 'Hand of Healing', desc: 'As an action (or part of Flurry of Blows), spend 1 ki point to touch a creature and restore HP equal to martial arts die + WIS modifier.' },
                    { name: 'Hand of Harm', desc: 'When you hit with an unarmed strike, spend 1 ki point to deal extra necrotic damage equal to martial arts die + WIS modifier. You can use this only once per turn.' }
                ],
                6: [
                    { name: 'Physician\'s Touch', desc: 'When you use Hand of Healing, you can also end one disease or condition (blinded, deafened, paralyzed, poisoned, or stunned). When you use Hand of Harm, you can inflict poisoned until end of your next turn.' }
                ],
                11: [
                    { name: 'Flurry of Healing and Harm', desc: 'You can use Hand of Healing instead of each Flurry of Blows attack. When you use Flurry of Blows, you can use Hand of Harm on each hit (no extra ki cost).' }
                ],
                17: [
                    { name: 'Hand of Ultimate Mercy', desc: 'As an action, touch a creature that died within 24 hours and spend 5 ki points. It returns to life with 4d10 + WIS modifier HP. Once per long rest.', uses: 1, recharge: 'long' }
                ]
            },
            kensei: {
                3: [
                    { name: 'Path of the Kensei', desc: 'Choose 2 weapons (1 melee, 1 ranged, can\'t have heavy or special). They become kensei weapons and are monk weapons for you. While holding one, you can use a bonus action to gain +2 AC until start of next turn.' },
                    { name: 'Agile Parry', desc: 'If you make an unarmed strike as part of the Attack action while holding a kensei weapon, gain +2 AC until start of next turn.' },
                    { name: 'Kensei\'s Shot', desc: 'As a bonus action, your ranged kensei weapon attacks deal extra 1d4 damage until end of turn.' }
                ],
                6: [
                    { name: 'One with the Blade', desc: 'Your kensei weapon attacks count as magical. When you hit with a kensei weapon, spend up to 3 ki points to deal extra damage (1d6 per ki point).' }
                ],
                11: [
                    { name: 'Sharpen the Blade', desc: 'As a bonus action, spend up to 3 ki points to grant your kensei weapon a bonus to attack and damage rolls equal to ki points spent, for 1 minute.' }
                ],
                17: [
                    { name: 'Unerring Accuracy', desc: 'If you miss with a monk weapon attack on your turn, you can reroll the attack roll. Once per turn.' }
                ]
            },
            // ===== PALADIN OATHS =====
            devotion: {
                3: [
                    { name: 'Oath Spells', desc: 'You gain oath spells at 3rd, 5th, 9th, 13th, and 17th level. They are always prepared and don\'t count against your prepared spells.' },
                    { name: 'Channel Divinity: Sacred Weapon', desc: 'As an action for 1 minute, add your CHA modifier to attack rolls with one weapon (minimum +1). The weapon emits bright light 20 ft.' },
                    { name: 'Channel Divinity: Turn the Unholy', desc: 'As an action, each fiend and undead within 30 feet must make a WIS save or be turned for 1 minute.' }
                ],
                7: [
                    { name: 'Aura of Devotion', desc: 'You and friendly creatures within 10 feet can\'t be charmed while you\'re conscious. At 18th level, range increases to 30 feet.' }
                ],
                15: [
                    { name: 'Purity of Spirit', desc: 'You are always under the effects of Protection from Evil and Good.' }
                ],
                20: [
                    { name: 'Holy Nimbus', desc: 'As an action for 1 minute, emit bright light 30 ft. Enemies starting turn in it take 10 radiant damage. You have advantage on saves vs spells from fiends/undead. Once per long rest.', uses: 1, recharge: 'long' }
                ]
            },
            vengeance: {
                3: [
                    { name: 'Oath Spells', desc: 'You gain oath spells at 3rd, 5th, 9th, 13th, and 17th level. They are always prepared and don\'t count against your prepared spells.' },
                    { name: 'Channel Divinity: Abjure Enemy', desc: 'As an action, one creature within 60 feet must make a WIS save or be frightened and speed 0 for 1 minute. Fiends/undead have disadvantage.' },
                    { name: 'Channel Divinity: Vow of Enmity', desc: 'As a bonus action, gain advantage on attack rolls against one creature within 10 feet for 1 minute.' }
                ],
                7: [
                    { name: 'Relentless Avenger', desc: 'When you hit with an opportunity attack, you can move up to half your speed immediately after as part of the reaction. This movement doesn\'t provoke opportunity attacks.' }
                ],
                15: [
                    { name: 'Soul of Vengeance', desc: 'When a creature under your Vow of Enmity attacks, you can use your reaction to make a melee weapon attack against it.' }
                ],
                20: [
                    { name: 'Avenging Angel', desc: 'As an action for 1 hour, sprout wings (60 ft flying speed), emanate a 30-ft aura of menace (WIS save or frightened for 1 minute). Once per long rest.', uses: 1, recharge: 'long' }
                ]
            },
            ancients: {
                3: [
                    { name: 'Oath Spells', desc: 'You gain oath spells at 3rd, 5th, 9th, 13th, and 17th level. They are always prepared and don\'t count against your prepared spells.' },
                    { name: 'Channel Divinity: Nature\'s Wrath', desc: 'As an action, spectral vines restrain a creature within 10 feet (STR or DEX save each turn).' },
                    { name: 'Channel Divinity: Turn the Faithless', desc: 'As an action, each fey and fiend within 30 feet must make a WIS save or be turned for 1 minute.' }
                ],
                7: [
                    { name: 'Aura of Warding', desc: 'You and friendly creatures within 10 feet have resistance to damage from spells. At 18th level, range increases to 30 feet.' }
                ],
                15: [
                    { name: 'Undying Sentinel', desc: 'When you drop to 0 HP and aren\'t killed outright, you can choose to drop to 1 HP instead. Once per long rest. Also, you don\'t suffer the drawbacks of old age.' }
                ],
                20: [
                    { name: 'Elder Champion', desc: 'As an action for 1 minute, transform: regain 10 HP at start of each turn, cast paladin spells as bonus action, enemies within 10 ft have disadvantage on saves vs your spells/channel divinity. Once per long rest.', uses: 1, recharge: 'long' }
                ]
            },
            conquest: {
                3: [
                    { name: 'Oath Spells', desc: 'You gain oath spells at 3rd, 5th, 9th, 13th, and 17th level. They are always prepared and don\'t count against your prepared spells.' },
                    { name: 'Channel Divinity: Conquering Presence', desc: 'As an action, each creature of your choice within 30 feet must make a WIS save or become frightened for 1 minute (save ends each turn).' },
                    { name: 'Channel Divinity: Guided Strike', desc: 'When you make an attack roll, you can add +10 to the roll after seeing it but before knowing if it hits.' }
                ],
                7: [
                    { name: 'Aura of Conquest', desc: 'If a creature is frightened of you and within 10 feet, its speed is reduced to 0 and it takes psychic damage equal to half your paladin level if it starts its turn there. 30 ft at 18th level.' }
                ],
                15: [
                    { name: 'Scornful Rebuke', desc: 'When a creature hits you with an attack, it takes psychic damage equal to your CHA modifier (minimum 1).' }
                ],
                20: [
                    { name: 'Invincible Conqueror', desc: 'As an action for 1 minute: resistance to all damage, extra attack (3 total), crit on 19-20. Once per long rest.', uses: 1, recharge: 'long' }
                ]
            },
            // ===== RANGER CONCLAVES =====
            hunter: {
                3: [
                    { name: 'Hunter\'s Prey', desc: 'Choose one: Colossus Slayer (+1d8 to creature below max HP once/turn), Giant Killer (reaction attack vs Large+ within 5 ft when it attacks you), or Horde Breaker (extra attack vs different creature within 5 ft of original target).' }
                ],
                7: [
                    { name: 'Defensive Tactics', desc: 'Choose one: Escape the Horde (opportunity attacks against you have disadvantage), Multiattack Defense (+4 AC vs same creature\'s subsequent attacks), or Steel Will (advantage on saves vs being frightened).' }
                ],
                11: [
                    { name: 'Multiattack', desc: 'Choose one: Volley (ranged attack every creature within 10 ft of a point within weapon range), or Whirlwind Attack (melee attack against each creature within 5 feet).' }
                ],
                15: [
                    { name: 'Superior Hunter\'s Defense', desc: 'Choose one: Evasion (DEX saves for half damage become no damage on success), Stand Against the Tide (reaction to have missed attack hit another creature), or Uncanny Dodge (halve attack damage as reaction).' }
                ]
            },
            gloomstalker: {
                3: [
                    { name: 'Dread Ambusher', desc: 'You add your WIS modifier to initiative. On your first turn of combat, your speed increases by 10 feet. If you take the Attack action, you can make one additional attack that deals an extra 1d8 damage.' },
                    { name: 'Umbral Sight', desc: 'You gain darkvision 60 ft (or +30 ft if you already have it). While in darkness, you are invisible to creatures relying on darkvision to see you.' }
                ],
                7: [
                    { name: 'Iron Mind', desc: 'You gain proficiency in WIS saving throws. If you already have it, you gain INT or CHA saves instead.' }
                ],
                11: [
                    { name: 'Stalker\'s Flurry', desc: 'Once on each of your turns when you miss with a weapon attack, you can make another weapon attack as part of the same action.' }
                ],
                15: [
                    { name: 'Shadowy Dodge', desc: 'When a creature makes an attack roll against you and you can see it, you can use your reaction to impose disadvantage on the roll.' }
                ]
            },
            beastmaster: {
                3: [
                    { name: 'Ranger\'s Companion', desc: 'You gain a beast companion. It obeys your commands, acts on your turn, and you can command it to take the Dash, Disengage, or Dodge action. It can attack when you use your action to command it.' },
                    { name: 'Primal Bond', desc: 'Your companion is a Beast of the Land, Sea, or Sky. Its attacks count as magical, it gains proficiency bonus to AC, damage, and skills, and extra HP equal to 5  ranger level.' }
                ],
                7: [
                    { name: 'Exceptional Training', desc: 'Your companion\'s attacks count as magical. When you command it to take an action, you can also command it to Dash, Disengage, Dodge, or Help as bonus action.' }
                ],
                11: [
                    { name: 'Bestial Fury', desc: 'When you command your companion to attack, it can make two attacks or use its special action.' }
                ],
                15: [
                    { name: 'Share Spells', desc: 'When you cast a spell targeting yourself, you can also affect your companion if it\'s within 30 feet of you.' }
                ]
            },
            // ===== ROGUE ARCHETYPES =====
            thief: {
                3: [
                    { name: 'Fast Hands', desc: 'You can use the bonus action from Cunning Action to make a Sleight of Hand check, use thieves\' tools to disarm a trap or open a lock, or take the Use an Object action.' },
                    { name: 'Second-Story Work', desc: 'Climbing doesn\'t cost extra movement. Running jumps increase by feet equal to your DEX modifier.' }
                ],
                9: [
                    { name: 'Supreme Sneak', desc: 'You have advantage on Stealth checks if you move no more than half your speed on the same turn.' }
                ],
                13: [
                    { name: 'Use Magic Device', desc: 'You can ignore all class, race, and level requirements on the use of magic items.' }
                ],
                17: [
                    { name: 'Thief\'s Reflexes', desc: 'You can take two turns during the first round of any combat. You take your first turn at your normal initiative and your second turn at your initiative minus 10.' }
                ]
            },
            assassin: {
                3: [
                    { name: 'Bonus Proficiencies', desc: 'You gain proficiency with the disguise kit and the poisoner\'s kit.' },
                    { name: 'Assassinate', desc: 'You have advantage on attack rolls against creatures that haven\'t taken a turn yet. Any hit against a surprised creature is a critical hit.' }
                ],
                9: [
                    { name: 'Infiltration Expertise', desc: 'You can unfailingly create false identities. You must spend seven days and 25 gp to establish history, profession, and affiliations.' }
                ],
                13: [
                    { name: 'Impostor', desc: 'You can unerringly mimic another person\'s speech, writing, and behavior after observing them for at least 3 hours.' }
                ],
                17: [
                    { name: 'Death Strike', desc: 'When you hit a surprised creature, it must make a CON save (DC 8 + DEX mod + prof). On a failure, double the damage.' }
                ]
            },
            arcanetrickster: {
                3: [
                    { name: 'Spellcasting', desc: 'You can cast wizard spells (enchantment and illusion, plus any school for some slots). Intelligence is your spellcasting ability.' },
                    { name: 'Mage Hand Legerdemain', desc: 'When you cast Mage Hand, you can make it invisible and perform additional tasks: stow/retrieve objects from containers worn by another creature, use thieves\' tools to pick locks/disarm traps at range.' }
                ],
                9: [
                    { name: 'Magical Ambush', desc: 'If you are hidden from a creature when you cast a spell on it, the creature has disadvantage on any saving throw it makes against the spell.' }
                ],
                13: [
                    { name: 'Versatile Trickster', desc: 'As a bonus action, you can designate a creature within 5 feet of your Mage Hand. You have advantage on attack rolls against that creature until the end of the turn.' }
                ],
                17: [
                    { name: 'Spell Thief', desc: 'When a creature casts a spell targeting you or including you in its area, you can use your reaction to force a save. On failure, you negate the spell\'s effect against you and steal knowledge of the spell for 8 hours. Once per long rest.', uses: 1, recharge: 'long' }
                ]
            },
            swashbuckler: {
                3: [
                    { name: 'Fancy Footwork', desc: 'During your turn, if you make a melee attack against a creature, that creature can\'t make opportunity attacks against you for the rest of your turn.' },
                    { name: 'Rakish Audacity', desc: 'Add your CHA modifier to initiative. You can use Sneak Attack against a creature if you are within 5 feet, no other creatures are within 5 feet of you, and you don\'t have disadvantage.' }
                ],
                9: [
                    { name: 'Panache', desc: 'As an action, make a Persuasion check contested by creature\'s Insight. On success, it has disadvantage on attacks against targets other than you and can\'t make opportunity attacks against others. Or charm a non-hostile creature for 1 minute.' }
                ],
                13: [
                    { name: 'Elegant Maneuver', desc: 'You can use a bonus action to gain advantage on the next Acrobatics or Athletics check you make during the same turn.' }
                ],
                17: [
                    { name: 'Master Duelist', desc: 'If you miss with an attack roll, you can roll again with advantage. Once per short or long rest.', uses: 1, recharge: 'short' }
                ]
            },
            // ===== SORCERER ORIGINS =====
            draconic: {
                1: [
                    { name: 'Draconic Resilience', desc: 'Your HP maximum increases by 1 per sorcerer level. When not wearing armor, your AC equals 13 + DEX modifier.' },
                    { name: 'Dragon Ancestor', desc: 'You can speak, read, and write Draconic. You have advantage on Charisma checks when interacting with dragons.' }
                ],
                6: [
                    { name: 'Elemental Affinity', desc: 'When you cast a spell that deals your dragon type\'s damage, add CHA modifier to one damage roll. You can also spend 1 sorcery point to gain resistance to that damage type for 1 hour.' }
                ],
                14: [
                    { name: 'Dragon Wings', desc: 'As a bonus action, you can sprout dragon wings, gaining a flying speed equal to your current speed. The wings last until you dismiss them.' }
                ],
                18: [
                    { name: 'Draconic Presence', desc: 'As an action, spend 5 sorcery points to create a 60-foot aura of awe or fear. Each hostile creature must WIS save or be charmed (awe) or frightened (fear) for 1 minute. Save ends on damage.' }
                ]
            },
            wild: {
                1: [
                    { name: 'Wild Magic Surge', desc: 'Once per turn, the DM can have you roll d20 after casting a 1st+ level sorcerer spell. On a 1, roll on the Wild Magic Surge table.' },
                    { name: 'Tides of Chaos', desc: 'Gain advantage on one attack roll, ability check, or saving throw. Regain use when you roll on Wild Magic Surge table, or after a long rest.', uses: 1, recharge: 'special' }
                ],
                6: [
                    { name: 'Bend Luck', desc: 'When another creature you can see makes an attack roll, ability check, or saving throw, you can use your reaction and 2 sorcery points to roll 1d4 and add or subtract from their roll.' }
                ],
                14: [
                    { name: 'Controlled Chaos', desc: 'When you roll on the Wild Magic Surge table, you can roll twice and use either result.' }
                ],
                18: [
                    { name: 'Spell Bombardment', desc: 'When you roll damage for a spell and roll the highest number on any die, you can roll that die again and add it to the damage. Once per turn.' }
                ]
            },
            clockwork: {
                1: [
                    { name: 'Clockwork Magic', desc: 'You learn additional spells that don\'t count against your spells known. You can swap one clockwork spell for an abjuration or transmutation spell of the same level when you gain a level.' },
                    { name: 'Restore Balance', desc: 'When a creature within 60 feet is about to roll with advantage or disadvantage, you can use your reaction to cancel that advantage or disadvantage. Uses: proficiency bonus per long rest.', uses: 'prof', recharge: 'long' }
                ],
                6: [
                    { name: 'Bastion of Law', desc: 'As an action, spend 1-5 sorcery points to create a ward on yourself or an ally within 30 feet. The ward has dice equal to points spent (d8s). When the warded creature takes damage, it can spend any number of dice to reduce damage by the total rolled.' }
                ],
                14: [
                    { name: 'Trance of Order', desc: 'As a bonus action, enter a state for 1 minute: attack rolls against you can\'t benefit from advantage, and you can treat a d20 roll of 9 or lower as a 10 for attacks, checks, and saves.', uses: 1, recharge: 'long' }
                ],
                18: [
                    { name: 'Clockwork Cavalcade', desc: 'As an action, summon spirits in a 30-foot cube within 120 feet. Creatures of your choice regain 100 HP and are cured of conditions. Damaged objects in the area are repaired. Once per long rest (or 7 sorcery points).', uses: 1, recharge: 'long' }
                ]
            },
            aberrant: {
                1: [
                    { name: 'Psionic Spells', desc: 'You learn additional spells that don\'t count against your spells known. You can swap one psionic spell for a divination or enchantment spell of the same level.' },
                    { name: 'Telepathic Speech', desc: 'As a bonus action, form a telepathic connection with one creature within 30 feet. You can speak telepathically and it can respond if it knows a language. Lasts for sorcerer level minutes. Uses: proficiency bonus per long rest.', uses: 'prof', recharge: 'long' }
                ],
                6: [
                    { name: 'Psionic Sorcery', desc: 'When you cast a psionic spell, you can cast it by spending sorcery points equal to spell level instead of a slot. No verbal or somatic components when cast this way.' },
                    { name: 'Psychic Defenses', desc: 'You have resistance to psychic damage and advantage on saving throws against being charmed or frightened.' }
                ],
                14: [
                    { name: 'Revelation in Flesh', desc: 'As a bonus action, spend 1+ sorcery points to gain benefits for 10 minutes: see invisible (1), fly (2), swim + breathe water (1), or squeeze through 1-inch spaces (2).', uses: 1, recharge: 'long' }
                ],
                18: [
                    { name: 'Warping Implosion', desc: 'As an action, teleport up to 120 feet. Each creature within 30 feet of the space you left must STR save or take 3d10 force damage and be pulled to your old space. On success, half damage and no pull. Once per long rest (or 5 sorcery points).', uses: 1, recharge: 'long' }
                ]
            },
            // ===== WARLOCK PATRONS =====
            fiend: {
                1: [
                    { name: 'Dark One\'s Blessing', desc: 'When you reduce a hostile creature to 0 HP, you gain temporary HP equal to your CHA modifier + warlock level.' }
                ],
                6: [
                    { name: 'Dark One\'s Own Luck', desc: 'When you make an ability check or saving throw, you can add a d10 to the roll. You can do so after seeing the initial roll. Once per short or long rest.', uses: 1, recharge: 'short' }
                ],
                10: [
                    { name: 'Fiendish Resilience', desc: 'At the end of a short or long rest, choose a damage type other than force. You have resistance to that type until you choose another.' }
                ],
                14: [
                    { name: 'Hurl Through Hell', desc: 'When you hit with an attack, you can instantly transport the target through the lower planes. It disappears and takes 10d10 psychic damage at end of your next turn when it returns. Once per long rest.', uses: 1, recharge: 'long' }
                ]
            },
            archfey: {
                1: [
                    { name: 'Fey Presence', desc: 'As an action, cause each creature in a 10-foot cube from you to make a WIS save or be charmed or frightened (your choice) until end of your next turn. Once per short or long rest.', uses: 1, recharge: 'short' }
                ],
                6: [
                    { name: 'Misty Escape', desc: 'When you take damage, you can use your reaction to turn invisible and teleport up to 60 feet. You remain invisible until the start of your next turn or until you attack or cast a spell. Once per short or long rest.', uses: 1, recharge: 'short' }
                ],
                10: [
                    { name: 'Beguiling Defenses', desc: 'You are immune to being charmed. When another creature tries to charm you, you can use your reaction to turn the charm back on them (WIS save).' }
                ],
                14: [
                    { name: 'Dark Delirium', desc: 'As an action, choose a creature within 60 feet. It must WIS save or be charmed or frightened for 1 minute or until you or your allies damage it. You can choose what it perceives while charmed. Once per short or long rest.', uses: 1, recharge: 'short' }
                ]
            },
            greatold: {
                1: [
                    { name: 'Awakened Mind', desc: 'You can telepathically speak to any creature within 30 feet. It doesn\'t need to share a language, but must understand at least one language.' }
                ],
                6: [
                    { name: 'Entropic Ward', desc: 'When a creature makes an attack roll against you, you can use your reaction to impose disadvantage. If the attack misses, your next attack against it has advantage if made before end of your next turn. Once per short or long rest.', uses: 1, recharge: 'short' }
                ],
                10: [
                    { name: 'Thought Shield', desc: 'Your thoughts can\'t be read by telepathy unless you allow it. You have resistance to psychic damage, and when a creature deals psychic damage to you, it takes the same amount.' }
                ],
                14: [
                    { name: 'Create Thrall', desc: 'As an action, touch an incapacitated humanoid to charm it permanently until Remove Curse is cast on it or you use this feature again. You can communicate telepathically with it across any distance.' }
                ]
            },
            hexblade: {
                1: [
                    { name: 'Hexblade\'s Curse', desc: 'As a bonus action, curse a creature within 30 feet for 1 minute: bonus damage equal to proficiency bonus, crit on 19-20, regain HP equal to warlock level + CHA modifier if it dies. Once per short or long rest.', uses: 1, recharge: 'short' },
                    { name: 'Hex Warrior', desc: 'You gain proficiency with medium armor, shields, and martial weapons. You can use CHA instead of STR or DEX for attack and damage with one weapon you touch after a long rest (or your Pact weapon).' }
                ],
                6: [
                    { name: 'Accursed Specter', desc: 'When you slay a humanoid, you can cause its spirit to rise as a specter that obeys you. It gains temp HP equal to half your warlock level and adds your CHA modifier to its attack rolls. Lasts until your next long rest.' }
                ],
                10: [
                    { name: 'Armor of Hexes', desc: 'If the target of your Hexblade\'s Curse hits you with an attack, roll a d6. On a 4+, the attack misses regardless of its roll.' }
                ],
                14: [
                    { name: 'Master of Hexes', desc: 'When the creature cursed by your Hexblade\'s Curse dies, you can apply the curse to a different creature within 30 feet. You don\'t regain HP from the original dying.' }
                ]
            },
            celestial: {
                1: [
                    { name: 'Healing Light', desc: 'You have a pool of d6s equal to 1 + warlock level. As a bonus action, you can heal a creature within 60 feet by spending dice from the pool.', uses: 'level+1', recharge: 'long' },
                    { name: 'Bonus Cantrips', desc: 'You learn the Light and Sacred Flame cantrips. They count as warlock cantrips for you.' }
                ],
                6: [
                    { name: 'Radiant Soul', desc: 'You have resistance to radiant damage. When you cast a spell that deals radiant or fire damage, add your CHA modifier to one radiant or fire damage roll.' }
                ],
                10: [
                    { name: 'Celestial Resilience', desc: 'You and up to 5 creatures gain temporary HP equal to your warlock level + CHA modifier when you finish a short or long rest.' }
                ],
                14: [
                    { name: 'Searing Vengeance', desc: 'When you make a death saving throw, you can spring to your feet with half HP, then each creature within 30 feet takes radiant damage equal to 2d8 + CHA modifier and is blinded until end of your next turn. Once per long rest.', uses: 1, recharge: 'long' }
                ]
            },
            genie: {
                1: [
                    { name: 'Genie\'s Vessel', desc: 'You have a tiny object as a vessel. Once per long rest, you can enter for proficiency bonus  2 hours. As a bonus action, you can Bottled Respite inside. You can hear outside. You can also grant one attack per turn +proficiency bonus damage (type based on genie kind).' },
                    { name: 'Genie\'s Wrath', desc: 'Once per turn, deal extra damage on a hit equal to your proficiency bonus (damage type depends on your genie patron: bludgeoning for dao, thunder for djinni, fire for efreeti, cold for marid).' }
                ],
                6: [
                    { name: 'Elemental Gift', desc: 'You have resistance to a damage type based on your patron (dao: bludgeoning, djinni: thunder, efreeti: fire, marid: cold). Also, as a bonus action, gain a flying speed of 30 feet for 10 minutes. Uses: proficiency bonus per long rest.', uses: 'prof', recharge: 'long' }
                ],
                10: [
                    { name: 'Sanctuary Vessel', desc: 'When you enter your vessel, you can bring up to 5 willing creatures. Everyone inside gains the benefits of a short rest in 10 minutes. Also, you can add your proficiency bonus to HP regained when someone uses Hit Dice inside.' }
                ],
                14: [
                    { name: 'Limited Wish', desc: 'As an action, speak to your genie and request a spell of 6th level or lower with a casting time of 1 action. The spell takes effect as part of this action with your spell save DC and spell attack bonus. Once per 1d4 long rests.', uses: 1, recharge: 'special' }
                ]
            }
        };

        function renderFeatures() {
            // Ensure usedFeatures is initialized
            if (!gameState.usedFeatures) gameState.usedFeatures = {};

            const features = [];
            const level = character.level;
            const cls = character.class?.toLowerCase();
            const subclass = character.subclass?.toLowerCase();

            // Get class features up to current level
            if (cls && CLASS_FEATURES[cls]) {
                for (let lvl = 1; lvl <= level; lvl++) {
                    const levelFeatures = CLASS_FEATURES[cls][lvl];
                    if (levelFeatures) {
                        features.push(...levelFeatures.map(f => ({ ...f, source: 'class', level: lvl })));
                    }
                }
            }

            // Get subclass features up to current level
            if (subclass && SUBCLASS_FEATURES[subclass]) {
                for (let lvl = 1; lvl <= level; lvl++) {
                    const levelFeatures = SUBCLASS_FEATURES[subclass][lvl];
                    if (levelFeatures) {
                        features.push(...levelFeatures.map(f => ({ ...f, source: 'subclass', level: lvl })));
                    }
                }
            }

            if (features.length === 0) {
                return `
                    <div class="features-list">
                        <div class="feature-item">
                            <div class="feature-desc" style="color: #8b7355;">No features data available for ${getDisplayClass()}</div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="features-list">
                    ${features.map(feature => {
                        const hasUses = feature.uses !== undefined;
                        let usesDisplay = '';
                        let maxUses = 0;

                        if (hasUses) {
                            if (feature.uses === 'prof') {
                                maxUses = getProficiencyBonus();
                            } else if (feature.uses === 'cha+1') {
                                maxUses = Math.max(1, getModifier(getAbilityScore('CHA')) + 1);
                            } else if (feature.uses === 'pool') {
                                maxUses = character.level * 5;
                            } else {
                                maxUses = feature.uses;
                            }
                            const usedCount = gameState.usedFeatures[feature.name] || 0;

                            if (feature.uses === 'pool') {
                                // Special handling for Lay on Hands pool
                                const remaining = maxUses - usedCount;
                                usesDisplay = `<span class="feature-pool">${remaining}/${maxUses} HP</span>`;
                            } else {
                                usesDisplay = `
                                    <div class="feature-uses" onclick="toggleFeatureUse('${feature.name}', ${maxUses}, event)">
                                        ${Array(maxUses).fill(0).map((_, i) => `<span class="feature-use-pip ${i < usedCount ? 'used' : ''}"></span>`).join('')}
                                    </div>
                                `;
                            }
                        }

                        return `
                            <div class="feature-item">
                                <div class="feature-header">
                                    <span class="feature-name">${feature.name}</span>
                                    ${usesDisplay}
                                    ${feature.recharge ? `<span class="feature-recharge">${feature.recharge === 'short' ? 'SR' : 'LR'}</span>` : ''}
                                </div>
                                <div class="feature-desc">${feature.desc}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function toggleFeatureUse(featureName, maxUses, event) {
            if (event) event.stopPropagation();
            if (!gameState.usedFeatures) gameState.usedFeatures = {};

            const current = gameState.usedFeatures[featureName] || 0;
            if (current >= maxUses) {
                gameState.usedFeatures[featureName] = 0;
            } else {
                gameState.usedFeatures[featureName] = current + 1;
            }

            saveGameState();
            renderCharacterSheet();
        }

        function renderInventory() {
            // Initialize inventory from starting equipment if empty
            if (!gameState.inventory || gameState.inventory.length === 0) {
                gameState.inventory = [];
                // Add granted equipment
                if (character.equipment?.granted) {
                    character.equipment.granted.forEach(item => {
                        addItemToInventory(item, false);
                    });
                }
                // Add chosen equipment
                if (character.equipment?.choices) {
                    Object.values(character.equipment.choices).forEach(choice => {
                        if (Array.isArray(choice)) {
                            choice.forEach(item => addItemToInventory(item, false));
                        } else if (choice) {
                            addItemToInventory(choice, false);
                        }
                    });
                }
                // Add starting gold
                if (character.startingGold && gameState.currency.gp === 0) {
                    gameState.currency.gp = character.startingGold;
                }
                saveGameState();
            }

            const getItemIcon = (type) => {
                const icons = {
                    weapon: '', armor: '', shield: '', potion: '',
                    scroll: '', wondrous: '', gear: '', ammo: '', custom: ''
                };
                return icons[type] || '';
            };

            const getRarityClass = (rarity) => {
                if (!rarity) return '';
                return 'rarity-' + rarity.replace(' ', '-');
            };

            return `
                <div class="inventory-section">
                    <div class="panel-title" style="font-size: 0.5rem; margin-bottom: 10px;">CURRENCY</div>
                    <div class="currency-row">
                        <div class="currency-item">
                            <div class="currency-icon cp">CP</div>
                            <input type="number" class="currency-input" value="${gameState.currency.cp}"
                                   onchange="updateCurrency('cp', this.value)">
                        </div>
                        <div class="currency-item">
                            <div class="currency-icon sp">SP</div>
                            <input type="number" class="currency-input" value="${gameState.currency.sp}"
                                   onchange="updateCurrency('sp', this.value)">
                        </div>
                        <div class="currency-item">
                            <div class="currency-icon gp">GP</div>
                            <input type="number" class="currency-input" value="${gameState.currency.gp}"
                                   onchange="updateCurrency('gp', this.value)">
                        </div>
                        <div class="currency-item">
                            <div class="currency-icon pp">PP</div>
                            <input type="number" class="currency-input" value="${gameState.currency.pp}"
                                   onchange="updateCurrency('pp', this.value)">
                        </div>
                    </div>
                    <div class="panel-title" style="font-size: 0.5rem; margin: 15px 0 10px 0;">INVENTORY (${gameState.inventory.length} items)</div>
                    <div class="equipment-list">
                        ${gameState.inventory.length > 0 ? gameState.inventory.map((item, index) => `
                            <div class="inventory-item ${item.equipped ? 'equipped' : ''} ${item.rarity ? 'magic' : ''}"
                                 onclick="showItemDetails(${index})">
                                <div class="inventory-item-icon ${item.type}">${getItemIcon(item.type)}</div>
                                <div class="inventory-item-info">
                                    <div class="inventory-item-name ${getRarityClass(item.rarity)}">
                                        ${item.name}${item.equipped ? ' (E)' : ''}${item.attunement ? ' (A)' : ''}
                                    </div>
                                    <div class="inventory-item-type">${item.type}${item.subtype ? ' - ' + item.subtype : ''}</div>
                                </div>
                                ${item.quantity > 1 ? `<div class="inventory-item-qty">x${item.quantity}</div>` : ''}
                                <div class="inventory-item-actions" onclick="event.stopPropagation()">
                                    ${(item.type === 'weapon' || item.type === 'armor' || item.type === 'shield' || item.type === 'wondrous') ? `
                                        <button class="inv-btn equip ${item.equipped ? 'equipped' : ''}"
                                                onclick="toggleEquipItem(${index})" title="${item.equipped ? 'Unequip' : 'Equip'}">
                                            ${item.equipped ? '' : 'E'}
                                        </button>
                                    ` : ''}
                                    ${item.consumable ? `
                                        <button class="inv-btn" onclick="useConsumable(${index})" title="Use">U</button>
                                    ` : ''}
                                    <button class="inv-btn delete" onclick="removeItem(${index})" title="Remove"></button>
                                </div>
                            </div>
                        `).join('') : '<div style="color: #6b4423; font-size: 0.4rem;">No items in inventory</div>'}
                    </div>
                    <button class="add-item-btn" onclick="showAddItemModal()">+ ADD ITEM</button>
                </div>
            `;
        }

        // ===== HP FUNCTIONS =====
        function updateHPBar() {
            const bar = document.getElementById('hpBar');
            const text = document.getElementById('hpText');
            const percent = getHPPercent();
            const max = calculateMaxHP();

            if (bar) {
                bar.style.width = percent + '%';
                bar.classList.remove('damaged', 'critical');
                if (percent <= 25) {
                    bar.classList.add('critical');
                } else if (percent <= 50) {
                    bar.classList.add('damaged');
                }
            }

            if (text) {
                text.textContent = `${gameState.currentHP} / ${max}`;
            }

            // Show death saves if at 0
            const deathSaves = document.getElementById('deathSaves');
            if (deathSaves) {
                if (gameState.currentHP <= 0) {
                    deathSaves.classList.add('active');
                } else {
                    deathSaves.classList.remove('active');
                }
            }

            saveGameState();
        }

        function takeDamage() {
            const amount = parseInt(document.getElementById('hpAmount').value) || 0;

            // Apply to temp HP first
            if (gameState.tempHP > 0) {
                const absorbed = Math.min(gameState.tempHP, amount);
                gameState.tempHP -= absorbed;
                const remaining = amount - absorbed;
                gameState.currentHP = Math.max(0, gameState.currentHP - remaining);
                document.getElementById('tempHP').value = gameState.tempHP;
            } else {
                gameState.currentHP = Math.max(0, gameState.currentHP - amount);
            }

            updateHPBar();
        }

        function heal() {
            const amount = parseInt(document.getElementById('hpAmount').value) || 0;
            const max = calculateMaxHP();
            gameState.currentHP = Math.min(max, gameState.currentHP + amount);

            // Clear death saves on heal from 0
            if (gameState.currentHP > 0) {
                gameState.deathSaves = { successes: 0, failures: 0 };
            }

            updateHPBar();
        }

        function updateTempHP() {
            gameState.tempHP = parseInt(document.getElementById('tempHP').value) || 0;
            saveGameState();
        }

        function toggleDeathSave(type, index) {
            if (gameState.deathSaves[type] > index) {
                gameState.deathSaves[type] = index;
            } else {
                gameState.deathSaves[type] = index + 1;
            }
            saveGameState();
            renderCharacterSheet();
        }

        function toggleHitDie(index) {
            if (index < gameState.usedHitDice) {
                gameState.usedHitDice = index;
            } else {
                gameState.usedHitDice = index + 1;
            }
            saveGameState();
            renderCharacterSheet();
        }

        // ===== SPELL SLOT FUNCTIONS =====
        function toggleSpellSlot(level, index, event) {
            if (event) event.stopPropagation();

            if (!gameState.usedSpellSlots[level]) {
                gameState.usedSpellSlots[level] = 0;
            }

            // Toggle: if clicking on a used slot, restore it; if clicking on unused, use it
            if (index < gameState.usedSpellSlots[level]) {
                // Clicking on a used slot - restore from this point
                gameState.usedSpellSlots[level] = index;
            } else {
                // Clicking on an unused slot - use up to and including this slot
                gameState.usedSpellSlots[level] = index + 1;
            }

            // Update just the spell slot pips visually without full re-render
            updateSpellSlotDisplay(level);
            saveGameState();
        }

        function updateSpellSlotDisplay(level) {
            const used = gameState.usedSpellSlots[level] || 0;
            const container = document.querySelector(`[data-spell-slot-level="${level}"]`);
            if (container) {
                const pips = container.querySelectorAll('.spell-slot-pip');
                pips.forEach((pip, i) => {
                    if (i < used) {
                        pip.classList.add('used');
                    } else {
                        pip.classList.remove('used');
                    }
                });
            }
        }

        // Toggle feat-granted spells (1/long rest)
        // Handler for limited spell pip clicks (with proper event handling)
        function handleLimitedSpellClick(e, spell) {
            if (e) {
                e.stopPropagation();
                e.preventDefault();
            }
            console.log('handleLimitedSpellClick called for:', spell);
            toggleLimitedSpell(spell);
        }

        // Handler for subclass spell pip clicks (with proper event handling)
        function handleSubclassSpellClick(e, spell, maxUses) {
            if (e) {
                e.stopPropagation();
                e.preventDefault();
            }
            console.log('handleSubclassSpellClick called for:', spell, 'max:', maxUses);
            toggleSubclassSpell(spell, maxUses);
        }

        function toggleLimitedSpell(spell) {
            try {
                if (!gameState.usedLimitedSpells) gameState.usedLimitedSpells = {};
                gameState.usedLimitedSpells[spell] = !gameState.usedLimitedSpells[spell];
                console.log('toggleLimitedSpell:', spell, 'now:', gameState.usedLimitedSpells[spell]);
                saveGameState();
                renderCharacterSheet();
            } catch (err) {
                console.error('Error in toggleLimitedSpell:', err);
            }
        }

        // Toggle subclass-granted spells (prof bonus/long rest)
        function toggleSubclassSpell(spell, maxUses) {
            try {
                if (!gameState.usedLimitedSpells) gameState.usedLimitedSpells = {};
                const current = gameState.usedLimitedSpells[spell] || 0;

                if (current >= maxUses) {
                    // All uses spent, reset to 0
                    gameState.usedLimitedSpells[spell] = 0;
                } else {
                    // Use one more
                    gameState.usedLimitedSpells[spell] = current + 1;
                }

                console.log('toggleSubclassSpell:', spell, 'now:', gameState.usedLimitedSpells[spell]);
                saveGameState();
                renderCharacterSheet();
            } catch (err) {
                console.error('Error in toggleSubclassSpell:', err);
            }
        }

        // ===== REST FUNCTIONS =====
        function shortRest() {
            if (!gameState.usedFeatures) gameState.usedFeatures = {};
            if (!gameState.usedHitDice) gameState.usedHitDice = 0;

            const maxHP = calculateMaxHP();
            const availableHitDice = character.level - gameState.usedHitDice;
            let healingDone = 0;

            // Always offer hit dice if any are available
            if (availableHitDice > 0) {
                const hpStatus = gameState.currentHP >= maxHP ? ' (You are at full HP)' : ` (Current: ${gameState.currentHP}/${maxHP})`;
                const useCount = prompt(`SHORT REST\n\nYou have ${availableHitDice} hit dice (${getHitDie()}) available.${hpStatus}\n\nHow many do you want to use for healing? (0-${availableHitDice})`);

                if (useCount === null) {
                    // User cancelled
                    return;
                }

                const count = Math.min(availableHitDice, Math.max(0, parseInt(useCount) || 0));

                if (count > 0) {
                    const hitDie = parseInt(getHitDie().replace('d', ''));
                    const conMod = getModifier(getAbilityScore('CON'));
                    let rolls = [];

                    for (let i = 0; i < count; i++) {
                        const roll = Math.floor(Math.random() * hitDie) + 1;
                        const healing = Math.max(1, roll + conMod);
                        rolls.push(`${roll}+${conMod}=${healing}`);
                        healingDone += healing;
                    }

                    gameState.usedHitDice += count;
                    const oldHP = gameState.currentHP;
                    gameState.currentHP = Math.min(maxHP, gameState.currentHP + healingDone);
                    const actualHealing = gameState.currentHP - oldHP;

                    alert(`Hit Dice Rolls: ${rolls.join(', ')}\nTotal: ${healingDone} HP${actualHealing < healingDone ? ` (${actualHealing} after cap)` : ''}`);
                }
            } else {
                alert('SHORT REST\n\nNo hit dice available. You can still recover short rest abilities.');
            }

            // Warlock pact magic recovery
            if (character.class === 'warlock') {
                gameState.usedSpellSlots = {};
            }

            // Reset short rest features (Wild Shape, Second Wind, Action Surge, Channel Divinity, etc.)
            if (!gameState.usedFeatures) gameState.usedFeatures = {};
            const shortRestFeatures = ['Wild Shape', 'Second Wind', 'Action Surge', 'Channel Divinity', 'Starry Form', 'Combat Superiority'];
            shortRestFeatures.forEach(feature => {
                gameState.usedFeatures[feature] = 0;
            });

            alert('Short rest complete! Short rest abilities have been restored.');
            saveGameState();
            renderCharacterSheet();
        }

        function longRest() {
            // Full HP recovery
            gameState.currentHP = calculateMaxHP();
            gameState.tempHP = 0;

            // Recover half hit dice (minimum 1)
            const recovered = Math.max(1, Math.floor(character.level / 2));
            gameState.usedHitDice = Math.max(0, gameState.usedHitDice - recovered);

            // Restore all spell slots
            gameState.usedSpellSlots = {};

            // Clear death saves
            gameState.deathSaves = { successes: 0, failures: 0 };

            // Reset used features and limited-use spells
            gameState.usedFeatures = {};
            gameState.usedLimitedSpells = {};

            // Save state immediately so HP is persisted
            saveGameState();

            // Update the display to show restored HP
            renderCharacterSheet();

            // Prompt for spell preparation if prepared caster
            if (isPreparedCaster()) {
                showSpellPreparation();
            } else {
                alert('Long rest complete! HP restored, spell slots recovered.');
            }
        }

        function showSpellPreparation() {
            const modal = document.getElementById('prepModal');
            const grid = document.getElementById('prepSpellGrid');
            const maxPrep = getMaxPreparedSpells();
            // Recalculate max spell level based on current character level
            const maxLevel = getMaxSpellLevelForClass(character.class, character.level);
            // Update character's maxSpellLevel for consistency
            character.maxSpellLevel = maxLevel;

            // Get granted spells (always prepared, cannot be changed)
            const grantedSpells = [
                ...(character.grantedSpells?.subclass?.spells || []),
                ...(character.grantedSpells?.feats || [])
            ];

            // Build spell list by level
            let spellsByLevel = {};
            const classKey = character.class?.toLowerCase();

            // WIZARD: Prepare from spellbook only (spells they've learned)
            if (isWizard()) {
                const spellbook = getWizardSpellbook();
                const wizardSpellList = CLASS_SPELL_LISTS.wizard || {};

                // Map spellbook spells to their levels
                spellbook.forEach(spell => {
                    for (let lvl = 1; lvl <= maxLevel; lvl++) {
                        const spellsAtLevel = wizardSpellList[lvl] || [];
                        if (spellsAtLevel.includes(spell)) {
                            if (!spellsByLevel[lvl]) spellsByLevel[lvl] = [];
                            spellsByLevel[lvl].push(spell);
                            break;
                        }
                    }
                });

                // Sort each level
                for (let lvl in spellsByLevel) {
                    spellsByLevel[lvl].sort();
                }
            }
            // Other prepared casters (cleric, druid, paladin): use full class spell list
            else if (CLASS_SPELL_LISTS[classKey]) {
                for (let i = 1; i <= maxLevel; i++) {
                    const classSpells = CLASS_SPELL_LISTS[classKey][i] || [];
                    if (classSpells.length > 0) {
                        spellsByLevel[i] = [...classSpells].sort();
                    }
                }
            } else if (character.availableSpells) {
                // Fallback to availableSpells from export
                for (let i = 1; i <= maxLevel; i++) {
                    const levelSpells = character.availableSpells[`level${i}`] || [];
                    if (levelSpells.length > 0) {
                        spellsByLevel[i] = levelSpells.map(s => s.name).sort();
                    }
                }
            } else {
                // Final fallback to known spells
                for (let i = 1; i <= maxLevel; i++) {
                    const levelSpells = character.spells?.[`level${i}`] || [];
                    if (levelSpells.length > 0) {
                        spellsByLevel[i] = [...levelSpells].sort();
                    }
                }
            }

            const prepLabel = isWizard() ? 'from spellbook' : '';
            document.getElementById('prepSubtitle').textContent =
                `Select spells to prepare ${prepLabel} (${gameState.preparedSpells.length}/${maxPrep})`;

            // Build HTML with spells grouped by level
            let html = '';

            // Show granted spells first (always prepared)
            if (grantedSpells.length > 0) {
                html += `<div class="prep-level-group">
                    <div class="prep-level-title">ALWAYS PREPARED (Granted)</div>
                    ${grantedSpells.map(spell => `
                        <div class="prep-spell-item granted">${spell}</div>
                    `).join('')}
                </div>`;
            }

            // Show spells by level
            for (let level = 1; level <= maxLevel; level++) {
                const spells = spellsByLevel[level];
                if (spells && spells.length > 0) {
                    html += `<div class="prep-level-group">
                        <div class="prep-level-title">LEVEL ${level} SPELLS</div>
                        ${spells.map(spell => `
                            <div class="prep-spell-item ${gameState.preparedSpells.includes(spell) ? 'selected' : ''}"
                                 onclick="togglePrepSpell('${spell.replace(/'/g, "\\'")}')">${spell}</div>
                        `).join('')}
                    </div>`;
                }
            }

            if (!html) {
                html = '<div style="color: #8b7355; font-size: 0.45rem; text-align: center;">No spells available to prepare</div>';
            }

            grid.innerHTML = html;
            modal.classList.add('active');
        }

        function togglePrepSpell(spell) {
            const maxPrep = getMaxPreparedSpells();
            const idx = gameState.preparedSpells.indexOf(spell);

            // Check if this is a cantrip - cantrips cannot be prepared
            const spellData = SPELL_DESCRIPTIONS[spell];
            if (spellData && spellData.level && spellData.level.toLowerCase().includes('cantrip')) {
                return; // Don't allow preparing cantrips
            }

            if (idx >= 0) {
                gameState.preparedSpells.splice(idx, 1);
            } else if (gameState.preparedSpells.length < maxPrep) {
                gameState.preparedSpells.push(spell);
            }

            document.getElementById('prepSubtitle').textContent =
                `Select spells to prepare (${gameState.preparedSpells.length}/${maxPrep})`;

            // Update visual
            document.querySelectorAll('.prep-spell-item').forEach(el => {
                if (el.textContent === spell) {
                    el.classList.toggle('selected', gameState.preparedSpells.includes(spell));
                }
            });
        }

        function skipPreparation() {
            document.getElementById('prepModal').classList.remove('active');
            alert('Long rest complete! HP restored, spell slots recovered.');
            saveGameState();
            renderCharacterSheet();
        }

        function confirmPreparation() {
            document.getElementById('prepModal').classList.remove('active');
            alert(`Long rest complete! Prepared ${gameState.preparedSpells.length} spells.`);
            saveGameState();
            renderCharacterSheet();
        }

        // ===== DICE ROLLING =====
        function rollAbilityCheck(ability) {
            currentRollData = {
                type: 'ability',
                name: ability + ' Check',
                modifier: getModifier(getAbilityScore(ability))
            };
            openDiceModal();
        }

        function rollSave(ability) {
            const isProficient = getSavingThrowProficiencies().includes(ability);
            const mod = getModifier(getAbilityScore(ability)) + (isProficient ? getProficiencyBonus() : 0);

            currentRollData = {
                type: 'save',
                name: ability + ' Save',
                modifier: mod
            };
            openDiceModal();
        }

        function rollSkill(skillName, ability) {
            const isProficient = character.skills?.includes(skillName);
            const isExpertise = character.expertise?.includes(skillName);
            const mod = getModifier(getAbilityScore(ability)) +
                       (isProficient ? getProficiencyBonus() : 0) +
                       (isExpertise ? getProficiencyBonus() : 0);

            currentRollData = {
                type: 'skill',
                name: skillName,
                modifier: mod
            };
            openDiceModal();
        }

        function rollInitiative() {
            currentRollData = {
                type: 'initiative',
                name: 'Initiative',
                modifier: getModifier(getAbilityScore('DEX'))
            };
            openDiceModal();
        }

        function openDiceModal() {
            const modal = document.getElementById('diceModal');
            const title = document.getElementById('diceModalTitle');
            const result = document.getElementById('diceResult');
            const die2 = document.getElementById('die2');

            title.textContent = currentRollData.name;
            result.style.display = 'none';
            die2.style.display = rollMode !== 'normal' ? 'block' : 'none';

            document.getElementById('die1').textContent = '?';
            document.getElementById('die2').textContent = '?';

            modal.classList.add('active');
        }

        function closeDiceModal() {
            document.getElementById('diceModal').classList.remove('active');
        }

        function setRollMode(mode) {
            rollMode = mode;
            document.querySelectorAll('.roll-mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            const die2 = document.getElementById('die2');
            die2.style.display = mode !== 'normal' ? 'block' : 'none';
        }

        function executeRoll() {
            const die1El = document.getElementById('die1');
            const die2El = document.getElementById('die2');
            const resultEl = document.getElementById('diceResult');
            const totalEl = document.getElementById('diceTotal');
            const breakdownEl = document.getElementById('diceBreakdown');
            const typeEl = document.getElementById('diceResultType');

            // Animate
            die1El.classList.add('rolling');
            if (rollMode !== 'normal') {
                die2El.classList.add('rolling');
            }

            // Roll after animation
            setTimeout(() => {
                const roll1 = Math.floor(Math.random() * 20) + 1;
                const roll2 = Math.floor(Math.random() * 20) + 1;

                die1El.classList.remove('rolling');
                die2El.classList.remove('rolling');

                die1El.textContent = roll1;
                die2El.textContent = roll2;

                let finalRoll = roll1;
                let dropped = null;

                if (rollMode === 'advantage') {
                    finalRoll = Math.max(roll1, roll2);
                    dropped = Math.min(roll1, roll2);
                    if (roll1 < roll2) die1El.classList.add('dropped');
                    else die2El.classList.add('dropped');
                    die1El.classList.add('advantage');
                    die2El.classList.add('advantage');
                } else if (rollMode === 'disadvantage') {
                    finalRoll = Math.min(roll1, roll2);
                    dropped = Math.max(roll1, roll2);
                    if (roll1 > roll2) die1El.classList.add('dropped');
                    else die2El.classList.add('dropped');
                    die1El.classList.add('disadvantage');
                    die2El.classList.add('disadvantage');
                }

                const total = finalRoll + currentRollData.modifier;

                totalEl.textContent = total;
                breakdownEl.textContent = `${finalRoll} ${formatModifier(currentRollData.modifier)} = ${total}`;

                // Check for crit/fumble
                typeEl.classList.remove('crit', 'fumble');
                if (finalRoll === 20) {
                    typeEl.textContent = 'NATURAL 20!';
                    typeEl.classList.add('crit');
                } else if (finalRoll === 1) {
                    typeEl.textContent = 'NATURAL 1...';
                    typeEl.classList.add('fumble');
                } else {
                    typeEl.textContent = '';
                }

                resultEl.style.display = 'block';

                // Clean up classes for next roll
                setTimeout(() => {
                    die1El.classList.remove('dropped', 'advantage', 'disadvantage');
                    die2El.classList.remove('dropped', 'advantage', 'disadvantage');
                }, 100);
            }, 500);
        }

        // ===== CONDITIONS =====
        function toggleCondition(condition) {
            const idx = gameState.conditions.indexOf(condition);
            if (idx >= 0) {
                gameState.conditions.splice(idx, 1);
            } else {
                gameState.conditions.push(condition);
            }
            saveGameState();
            renderCharacterSheet();
        }

        // ===== LEVEL UP =====
        // Subclass selection levels by class
        const SUBCLASS_LEVELS = {
            barbarian: 3, bard: 3, cleric: 1, druid: 2, fighter: 3,
            monk: 3, paladin: 3, ranger: 3, rogue: 3, sorcerer: 1,
            warlock: 1, wizard: 2
        };

        // Available subclasses by class
        const CLASS_SUBCLASSES = {
            barbarian: [
                { id: 'berserker', name: 'Path of the Berserker', desc: 'Channel rage into violent fury' },
                { id: 'totem', name: 'Path of the Totem Warrior', desc: 'Spiritual journey with animal spirits' },
                { id: 'ancestral', name: 'Path of the Ancestral Guardian', desc: 'Call upon ancestral spirits' },
                { id: 'storm', name: 'Path of the Storm Herald', desc: 'Channel primal storms' },
                { id: 'zealot', name: 'Path of the Zealot', desc: 'Divine fury in battle' }
            ],
            bard: [
                { id: 'lore', name: 'College of Lore', desc: 'Knowledge and magical secrets' },
                { id: 'valor', name: 'College of Valor', desc: 'Battle and heroic deeds' },
                { id: 'glamour', name: 'College of Glamour', desc: 'Fey magic and charm' },
                { id: 'swords', name: 'College of Swords', desc: 'Blade flourishes and combat' },
                { id: 'whispers', name: 'College of Whispers', desc: 'Shadows and secrets' }
            ],
            cleric: [
                { id: 'knowledge', name: 'Knowledge Domain', desc: 'Learning and understanding' },
                { id: 'life', name: 'Life Domain', desc: 'Healing and vitality' },
                { id: 'light', name: 'Light Domain', desc: 'Fire and radiance' },
                { id: 'nature', name: 'Nature Domain', desc: 'Natural world and beasts' },
                { id: 'tempest', name: 'Tempest Domain', desc: 'Storm and destruction' },
                { id: 'trickery', name: 'Trickery Domain', desc: 'Deception and mischief' },
                { id: 'war', name: 'War Domain', desc: 'Combat and victory' },
                { id: 'forge', name: 'Forge Domain', desc: 'Creation and crafting' },
                { id: 'grave', name: 'Grave Domain', desc: 'Death and the undead' },
                { id: 'order', name: 'Order Domain', desc: 'Law and civilization' },
                { id: 'peace', name: 'Peace Domain', desc: 'Harmony and protection' },
                { id: 'twilight', name: 'Twilight Domain', desc: 'Comfort in darkness' }
            ],
            druid: [
                { id: 'land', name: 'Circle of the Land', desc: 'Connection to specific terrain' },
                { id: 'moon', name: 'Circle of the Moon', desc: 'Powerful Wild Shape forms' },
                { id: 'dreams', name: 'Circle of Dreams', desc: 'Feywild connections' },
                { id: 'shepherd', name: 'Circle of the Shepherd', desc: 'Communion with beasts' },
                { id: 'spores', name: 'Circle of Spores', desc: 'Decay and undeath' },
                { id: 'stars', name: 'Circle of Stars', desc: 'Starry forms and guidance' },
                { id: 'wildfire', name: 'Circle of Wildfire', desc: 'Destructive and creative fire' }
            ],
            fighter: [
                { id: 'champion', name: 'Champion', desc: 'Physical excellence and crits' },
                { id: 'battlemaster', name: 'Battle Master', desc: 'Tactical combat maneuvers' },
                { id: 'eldritchknight', name: 'Eldritch Knight', desc: 'Martial magic combination' },
                { id: 'arcane', name: 'Arcane Archer', desc: 'Magic-infused archery' },
                { id: 'cavalier', name: 'Cavalier', desc: 'Mounted combat mastery' },
                { id: 'samurai', name: 'Samurai', desc: 'Fighting spirit and resolve' },
                { id: 'psi', name: 'Psi Warrior', desc: 'Psionic powers in combat' },
                { id: 'rune', name: 'Rune Knight', desc: 'Giant rune magic' }
            ],
            monk: [
                { id: 'openhand', name: 'Way of the Open Hand', desc: 'Ultimate martial arts mastery' },
                { id: 'shadow', name: 'Way of Shadow', desc: 'Stealth and darkness' },
                { id: 'fourelements', name: 'Way of the Four Elements', desc: 'Elemental disciplines' },
                { id: 'drunken', name: 'Way of the Drunken Master', desc: 'Unpredictable movement' },
                { id: 'kensei', name: 'Way of the Kensei', desc: 'Weapon mastery' },
                { id: 'mercy', name: 'Way of Mercy', desc: 'Healing and harm' },
                { id: 'astral', name: 'Way of the Astral Self', desc: 'Astral projection in combat' }
            ],
            paladin: [
                { id: 'devotion', name: 'Oath of Devotion', desc: 'Classic holy knight' },
                { id: 'ancients', name: 'Oath of the Ancients', desc: 'Protection of light and life' },
                { id: 'vengeance', name: 'Oath of Vengeance', desc: 'Punishing the wicked' },
                { id: 'conquest', name: 'Oath of Conquest', desc: 'Rule through strength' },
                { id: 'redemption', name: 'Oath of Redemption', desc: 'Peace and second chances' },
                { id: 'crown', name: 'Oath of the Crown', desc: 'Service to civilization' },
                { id: 'glory', name: 'Oath of Glory', desc: 'Heroic deeds and athletics' },
                { id: 'watchers', name: 'Oath of the Watchers', desc: 'Guard against extraplanar threats' }
            ],
            ranger: [
                { id: 'hunter', name: 'Hunter', desc: 'Specialized prey slaying' },
                { id: 'beastmaster', name: 'Beast Master', desc: 'Animal companion bond' },
                { id: 'gloom', name: 'Gloom Stalker', desc: 'Ambush from darkness' },
                { id: 'horizon', name: 'Horizon Walker', desc: 'Planar travel and combat' },
                { id: 'monster', name: 'Monster Slayer', desc: 'Hunt supernatural threats' },
                { id: 'fey', name: 'Fey Wanderer', desc: 'Feywild magic and charm' },
                { id: 'swarm', name: 'Swarmkeeper', desc: 'Nature spirits swarm' }
            ],
            rogue: [
                { id: 'thief', name: 'Thief', desc: 'Supreme skill and agility' },
                { id: 'assassin', name: 'Assassin', desc: 'Deadly surprise attacks' },
                { id: 'arcanetrickster', name: 'Arcane Trickster', desc: 'Magic and misdirection' },
                { id: 'inquisitive', name: 'Inquisitive', desc: 'Uncover secrets and lies' },
                { id: 'mastermind', name: 'Mastermind', desc: 'Tactical manipulation' },
                { id: 'scout', name: 'Scout', desc: 'Wilderness expert' },
                { id: 'swashbuckler', name: 'Swashbuckler', desc: 'Dashing duelist' },
                { id: 'phantom', name: 'Phantom', desc: 'Connection to death' },
                { id: 'soul', name: 'Soulknife', desc: 'Psionic blades' }
            ],
            sorcerer: [
                { id: 'draconic', name: 'Draconic Bloodline', desc: 'Dragon ancestry power' },
                { id: 'wildmagic', name: 'Wild Magic', desc: 'Chaotic magical surges' },
                { id: 'divine', name: 'Divine Soul', desc: 'Divine magic access' },
                { id: 'shadow', name: 'Shadow Magic', desc: 'Shadowfell connection' },
                { id: 'storm', name: 'Storm Sorcery', desc: 'Tempest powers' },
                { id: 'aberrant', name: 'Aberrant Mind', desc: 'Psionic abilities' },
                { id: 'clockwork', name: 'Clockwork Soul', desc: 'Order and balance' }
            ],
            warlock: [
                { id: 'archfey', name: 'The Archfey', desc: 'Feywild patron' },
                { id: 'fiend', name: 'The Fiend', desc: 'Fiendish patron' },
                { id: 'greatoldone', name: 'The Great Old One', desc: 'Alien entity patron' },
                { id: 'celestial', name: 'The Celestial', desc: 'Celestial patron' },
                { id: 'hexblade', name: 'The Hexblade', desc: 'Shadowfell weapon patron' },
                { id: 'fathomless', name: 'The Fathomless', desc: 'Oceanic depths patron' },
                { id: 'genie', name: 'The Genie', desc: 'Genie patron' },
                { id: 'undead', name: 'The Undead', desc: 'Undead entity patron' }
            ],
            wizard: [
                { id: 'abjuration', name: 'School of Abjuration', desc: 'Protective wards and banishment' },
                { id: 'conjuration', name: 'School of Conjuration', desc: 'Summoning and teleportation' },
                { id: 'divination', name: 'School of Divination', desc: 'Foresight and knowledge' },
                { id: 'enchantment', name: 'School of Enchantment', desc: 'Mind control and charm' },
                { id: 'evocation', name: 'School of Evocation', desc: 'Destructive elemental magic' },
                { id: 'illusion', name: 'School of Illusion', desc: 'Deception and trickery' },
                { id: 'necromancy', name: 'School of Necromancy', desc: 'Death and undeath' },
                { id: 'transmutation', name: 'School of Transmutation', desc: 'Transformation magic' },
                { id: 'bladesinging', name: 'Bladesinging', desc: 'Elven sword magic' },
                { id: 'war', name: 'War Magic', desc: 'Combat-focused arcana' },
                { id: 'chronurgy', name: 'Chronurgy Magic', desc: 'Time manipulation' },
                { id: 'graviturgy', name: 'Graviturgy Magic', desc: 'Gravity manipulation' }
            ]
        };

        function levelUp() {
            if (character.level >= 20) {
                alert('You are already at maximum level (20)!');
                return;
            }

            const oldLevel = character.level;
            const newLevel = character.level + 1;
            const asiLevels = [4, 8, 12, 16, 19];
            const isASILevel = asiLevels.includes(newLevel);
            const subclassLevel = SUBCLASS_LEVELS[character.class?.toLowerCase()];
            const needsSubclass = newLevel === subclassLevel && !character.subclass;

            // Calculate new spells for known casters
            const newSpellsCount = isKnownCaster() ? getNewSpellsOnLevelUp(oldLevel, newLevel) : 0;

            let confirmMsg = `Level up to ${newLevel}?\n\nYou will gain:\n Increased HP\n New features at certain levels`;
            if (needsSubclass) {
                confirmMsg += `\n SUBCLASS SELECTION`;
            }
            if (isASILevel) {
                confirmMsg += `\n ABILITY SCORE IMPROVEMENT or FEAT`;
            }
            if (isWizard()) {
                confirmMsg += `\n 2 new spells for your spellbook`;
            } else if (isKnownCaster() && newSpellsCount > 0) {
                confirmMsg += `\n ${newSpellsCount} new spell${newSpellsCount > 1 ? 's' : ''} to learn`;
                confirmMsg += `\n Option to swap 1 known spell`;
            } else if (isPreparedCaster()) {
                confirmMsg += `\n Ability to prepare more spells`;
            }

            if (confirm(confirmMsg)) {
                // Store old level for spell calculations
                window.levelUpOldLevel = oldLevel;
                window.levelUpNewSpellsCount = newSpellsCount;

                character.level = newLevel;
                console.log('Level increased to:', character.level);

                // Update max spell level for the new level
                character.maxSpellLevel = getMaxSpellLevelForClass(character.class, character.level);

                // Recalculate max HP and set current to max
                const newMaxHP = calculateMaxHP();
                console.log('New max HP:', newMaxHP);
                gameState.currentHP = newMaxHP;

                // Save character FIRST
                localStorage.setItem('dnd-active-character', JSON.stringify(character));
                saveGameState();

                // Render BEFORE showing any modals
                try {
                    renderCharacterSheet();
                    console.log('Render completed successfully');
                } catch (e) {
                    console.error('Render error:', e);
                }

                // Check for subclass selection first
                if (needsSubclass) {
                    showSubclassModal(isASILevel);
                } else if (isASILevel) {
                    showASIModal();
                } else if (isWizard()) {
                    // Wizards learn 2 new spells on level up
                    alert(`Congratulations! You are now level ${character.level}!\n\nAs a wizard, you can add 2 new spells to your spellbook.`);
                    showWizardSpellLearning(2, true); // 2 spells, then show prep
                } else if (isKnownCaster() && newSpellsCount > 0) {
                    // Known casters learn specific spells
                    alert(`Congratulations! You are now level ${character.level}!\n\nYou can learn ${newSpellsCount} new spell${newSpellsCount > 1 ? 's' : ''} and optionally swap 1 known spell.`);
                    showKnownCasterSpellLearning(newSpellsCount);
                } else if (isPreparedCaster()) {
                    alert(`Congratulations! You are now level ${character.level}!\n\nAs a prepared caster, you can now prepare more spells.`);
                    showSpellPreparation();
                } else {
                    alert(`Congratulations! You are now level ${character.level}!`);
                }
            }
        }

        // Wizard spell learning modal (for level up or scroll learning)
        function showWizardSpellLearning(numSpells, showPrepAfter = false) {
            const maxLevel = character.maxSpellLevel || getMaxSpellLevelForClass('wizard', character.level);
            const learnableSpells = getLearnableWizardSpells(maxLevel);
            const currentSpellbook = getWizardSpellbook();

            // Track selected spells for this modal
            window.wizardSpellsToLearn = [];
            window.wizardNumToLearn = numSpells;
            window.wizardShowPrepAfter = showPrepAfter;

            const modal = document.createElement('div');
            modal.id = 'wizardLearnModal';
            modal.className = 'spell-modal active';
            modal.innerHTML = `
                <div class="spell-modal-content" style="max-width: 700px;">
                    <div class="spell-modal-header">
                        <div class="spell-modal-title">LEARN NEW SPELLS</div>
                    </div>
                    <div style="margin-bottom: 15px; color: #c4a574; font-size: 0.45rem;">
                        Select ${numSpells} spell${numSpells > 1 ? 's' : ''} to add to your spellbook:
                        <span id="wizardLearnCount" style="color: #daa520;">(0/${numSpells} selected)</span>
                    </div>
                    <div style="margin-bottom: 10px; color: #8b7355; font-size: 0.4rem;">
                        Current spellbook contains ${currentSpellbook.length} spells
                    </div>
                    <div class="item-list-scroll" style="max-height: 400px;" id="wizardLearnGrid">
                        ${buildWizardLearnableSpellsHTML(learnableSpells)}
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button onclick="confirmWizardSpellLearning()" style="flex: 1; padding: 12px; background: #6a1b9a; border: 2px solid #9c27b0; color: #fff; font-family: inherit; font-size: 0.45rem; cursor: pointer;">
                            ADD TO SPELLBOOK
                        </button>
                        <button onclick="skipWizardSpellLearning()" style="padding: 12px 20px; background: #5c3317; border: 2px solid #8b4513; color: #f4e4bc; font-family: inherit; font-size: 0.45rem; cursor: pointer;">
                            SKIP
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function buildWizardLearnableSpellsHTML(spells) {
            // Group by level
            const byLevel = {};
            spells.forEach(spell => {
                if (!byLevel[spell.level]) byLevel[spell.level] = [];
                byLevel[spell.level].push(spell.name);
            });

            let html = '';
            for (let lvl = 1; lvl <= 9; lvl++) {
                const levelSpells = byLevel[lvl];
                if (levelSpells && levelSpells.length > 0) {
                    html += `
                        <div class="prep-level-group">
                            <div class="prep-level-title">LEVEL ${lvl} SPELLS</div>
                            ${levelSpells.sort().map(spell => `
                                <div class="prep-spell-item" data-spell="${spell.replace(/'/g, '&#39;')}"
                                     onclick="toggleWizardLearnSpell(this, '${spell.replace(/'/g, "\\'")}')">
                                    ${spell}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }

            if (!html) {
                html = '<div style="color: #8b7355; font-size: 0.45rem; text-align: center;">No new spells available to learn at your current level.</div>';
            }
            return html;
        }

        function toggleWizardLearnSpell(element, spellName) {
            const idx = window.wizardSpellsToLearn.indexOf(spellName);

            if (idx >= 0) {
                // Remove from selection
                window.wizardSpellsToLearn.splice(idx, 1);
                element.classList.remove('selected');
            } else if (window.wizardSpellsToLearn.length < window.wizardNumToLearn) {
                // Add to selection
                window.wizardSpellsToLearn.push(spellName);
                element.classList.add('selected');
            }

            // Update count display
            document.getElementById('wizardLearnCount').textContent =
                `(${window.wizardSpellsToLearn.length}/${window.wizardNumToLearn} selected)`;
        }

        function confirmWizardSpellLearning() {
            if (window.wizardSpellsToLearn.length === 0) {
                alert('Please select at least one spell to learn.');
                return;
            }

            // Add all selected spells to spellbook
            window.wizardSpellsToLearn.forEach(spell => {
                addSpellToSpellbook(spell);
            });

            const learnedCount = window.wizardSpellsToLearn.length;
            const modal = document.getElementById('wizardLearnModal');
            if (modal) modal.remove();

            alert(`Added ${learnedCount} spell${learnedCount > 1 ? 's' : ''} to your spellbook!`);

            // Show preparation modal if requested
            if (window.wizardShowPrepAfter) {
                showSpellPreparation();
            } else {
                renderCharacterSheet();
            }
        }

        function skipWizardSpellLearning() {
            const modal = document.getElementById('wizardLearnModal');
            if (modal) modal.remove();

            if (window.wizardShowPrepAfter) {
                showSpellPreparation();
            } else {
                renderCharacterSheet();
            }
        }

        // Learn spell from scroll - allows wizard to add any wizard spell to their spellbook
        function showLearnFromScroll() {
            if (!isWizard()) return;

            const maxLevel = character.maxSpellLevel || getMaxSpellLevelForClass('wizard', character.level);
            const learnableSpells = getLearnableWizardSpells(maxLevel);
            const currentSpellbook = getWizardSpellbook();

            const modal = document.createElement('div');
            modal.id = 'scrollLearnModal';
            modal.className = 'spell-modal active';
            modal.innerHTML = `
                <div class="spell-modal-content" style="max-width: 700px;">
                    <div class="spell-modal-header">
                        <div class="spell-modal-title"> LEARN FROM SCROLL</div>
                        <button class="spell-modal-close" onclick="closeScrollLearnModal()">&times;</button>
                    </div>
                    <div style="margin-bottom: 10px; color: #c4a574; font-size: 0.45rem;">
                        Select a spell to copy from a scroll into your spellbook:
                    </div>
                    <div style="margin-bottom: 15px; color: #8b7355; font-size: 0.35rem;">
                        <em>Copying a spell requires 2 hours and 50 GP per spell level (half for your school specialty). The scroll is consumed.</em>
                    </div>
                    <div class="item-list-scroll" style="max-height: 350px;" id="scrollLearnGrid">
                        ${buildScrollLearnableSpellsHTML(learnableSpells)}
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button onclick="closeScrollLearnModal()" style="flex: 1; padding: 12px; background: #5c3317; border: 2px solid #8b4513; color: #f4e4bc; font-family: inherit; font-size: 0.45rem; cursor: pointer;">
                            CLOSE
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Get the wizard's school specialty (subclass)
        function getWizardSchool() {
            if (!isWizard()) return null;
            const subclass = character.subclass?.toLowerCase();
            // Map subclass to school name
            const schoolMap = {
                'abjuration': 'Abjuration',
                'conjuration': 'Conjuration',
                'divination': 'Divination',
                'enchantment': 'Enchantment',
                'evocation': 'Evocation',
                'illusion': 'Illusion',
                'necromancy': 'Necromancy',
                'transmutation': 'Transmutation'
            };
            return schoolMap[subclass] || null;
        }

        // Get spell school from SPELL_DATA or SPELL_DESCRIPTIONS
        function getSpellSchool(spellName) {
            const spellData = SPELL_DATA[spellName] || SPELL_DESCRIPTIONS[spellName];
            return spellData?.school || null;
        }

        function buildScrollLearnableSpellsHTML(spells) {
            // Group by level
            const byLevel = {};
            spells.forEach(spell => {
                if (!byLevel[spell.level]) byLevel[spell.level] = [];
                byLevel[spell.level].push(spell.name);
            });

            const wizardSchool = getWizardSchool();
            const hasSchoolBonus = wizardSchool !== null;

            let html = '';
            if (hasSchoolBonus) {
                html += `<div style="color: #81c784; font-size: 0.4rem; margin-bottom: 10px; text-align: center; padding: 8px; background: rgba(46, 125, 50, 0.2); border: 1px solid #2e7d32;">
                     <strong>${wizardSchool} Savant:</strong> ${wizardSchool} spells cost half gold and time to copy!
                </div>`;
            }

            for (let lvl = 1; lvl <= 9; lvl++) {
                const levelSpells = byLevel[lvl];
                if (levelSpells && levelSpells.length > 0) {
                    const baseGoldCost = lvl * 50;
                    const baseTimeCost = lvl * 2;
                    html += `
                        <div class="prep-level-group">
                            <div class="prep-level-title">LEVEL ${lvl} (${baseGoldCost} GP, ${baseTimeCost} hours - half for ${wizardSchool || 'school specialty'})</div>
                            ${levelSpells.sort().map(spell => {
                                const spellSchool = getSpellSchool(spell);
                                const isSchoolMatch = hasSchoolBonus && spellSchool === wizardSchool;
                                const goldCost = isSchoolMatch ? Math.floor(baseGoldCost / 2) : baseGoldCost;
                                const timeCost = isSchoolMatch ? Math.floor(baseTimeCost / 2) : baseTimeCost;
                                const schoolIndicator = isSchoolMatch ? ' ' : '';
                                const schoolStyle = isSchoolMatch ? 'background: rgba(46, 125, 50, 0.15); border-color: #2e7d32;' : '';
                                return `
                                <div class="prep-spell-item scroll-spell" data-spell="${spell.replace(/'/g, '&#39;')}"
                                     style="${schoolStyle}"
                                     onclick="learnSpellFromScroll('${spell.replace(/'/g, "\\'")}', ${goldCost}, ${timeCost}, ${isSchoolMatch})">
                                    ${spell}${schoolIndicator}
                                    <span style="color: #c4a574; font-size: 0.35rem; margin-left: 5px;">${goldCost}gp/${timeCost}h</span>
                                </div>
                            `}).join('')}
                        </div>
                    `;
                }
            }

            if (!html || html.indexOf('prep-level-group') === -1) {
                html = '<div style="color: #8b7355; font-size: 0.45rem; text-align: center;">No new spells available to learn. Your spellbook contains all wizard spells up to your current spell level!</div>';
            }
            return html;
        }

        function learnSpellFromScroll(spellName, goldCost, timeCost, isSchoolBonus = false) {
            const bonusText = isSchoolBonus ? `\n\n School Savant bonus applied! (Half cost)` : '';
            if (confirm(`Learn "${spellName}" from a spell scroll?\n\nCost: ${goldCost} GP and ${timeCost} hours\nThe spell scroll will be consumed.${bonusText}\n\nProceed?`)) {
                if (addSpellToSpellbook(spellName)) {
                    const successBonus = isSchoolBonus ? ' (School Savant discount applied!)' : '';
                    alert(`Success! "${spellName}" has been copied into your spellbook.\n\nDeduct ${goldCost} GP from your currency for materials.${successBonus}`);
                    closeScrollLearnModal();
                    renderCharacterSheet();
                } else {
                    alert('This spell is already in your spellbook!');
                }
            }
        }

        function closeScrollLearnModal() {
            const modal = document.getElementById('scrollLearnModal');
            if (modal) modal.remove();
        }

        // Show spellbook contents
        function showSpellbookInfo() {
            if (!isWizard()) return;

            const spellbook = getWizardSpellbook();
            const wizardSpellList = CLASS_SPELL_LISTS.wizard || {};
            const expectedSize = getWizardSpellbookSize();

            // Group spellbook spells by level
            const byLevel = {};
            spellbook.forEach(spell => {
                for (let lvl = 1; lvl <= 9; lvl++) {
                    const spellsAtLevel = wizardSpellList[lvl] || [];
                    if (spellsAtLevel.includes(spell)) {
                        if (!byLevel[lvl]) byLevel[lvl] = [];
                        byLevel[lvl].push(spell);
                        break;
                    }
                }
            });

            let spellbookHTML = '';
            for (let lvl = 1; lvl <= 9; lvl++) {
                const levelSpells = byLevel[lvl];
                if (levelSpells && levelSpells.length > 0) {
                    spellbookHTML += `
                        <div class="prep-level-group">
                            <div class="prep-level-title">LEVEL ${lvl} (${levelSpells.length} spells)</div>
                            ${levelSpells.sort().map(spell => `
                                <div class="prep-spell-item" style="cursor: default; background: #2d1b0e;">${spell}</div>
                            `).join('')}
                        </div>
                    `;
                }
            }

            if (!spellbookHTML) {
                spellbookHTML = '<div style="color: #8b7355; font-size: 0.45rem; text-align: center;">Your spellbook is empty!</div>';
            }

            const modal = document.createElement('div');
            modal.id = 'spellbookModal';
            modal.className = 'spell-modal active';
            modal.innerHTML = `
                <div class="spell-modal-content" style="max-width: 600px;">
                    <div class="spell-modal-header">
                        <div class="spell-modal-title"> YOUR SPELLBOOK</div>
                        <button class="spell-modal-close" onclick="closeSpellbookModal()">&times;</button>
                    </div>
                    <div style="margin-bottom: 15px; color: #c4a574; font-size: 0.45rem;">
                        Contains ${spellbook.length} spells (expected at level ${character.level}: ${expectedSize})
                    </div>
                    <div class="item-list-scroll" style="max-height: 400px;">
                        ${spellbookHTML}
                    </div>
                    <div style="margin-top: 15px;">
                        <button onclick="closeSpellbookModal()" style="width: 100%; padding: 12px; background: #5c3317; border: 2px solid #8b4513; color: #f4e4bc; font-family: inherit; font-size: 0.45rem; cursor: pointer;">
                            CLOSE
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeSpellbookModal() {
            const modal = document.getElementById('spellbookModal');
            if (modal) modal.remove();
        }

        // Known caster spell learning modal (for sorcerer, warlock, bard, ranger)
        function showKnownCasterSpellLearning(numSpells) {
            const cls = character.class?.toLowerCase();
            const maxLevel = character.maxSpellLevel || getMaxSpellLevelForClass(cls, character.level);
            const learnableSpells = getLearnableSpellsForKnownCaster(maxLevel);
            const spellList = CLASS_SPELL_LISTS[cls] || {};

            // Get current known spells for swap feature
            const currentKnownSpells = [];
            for (let i = 1; i <= 9; i++) {
                const levelSpells = character.spells?.[`level${i}`] || [];
                levelSpells.forEach(spell => {
                    // Find what level this spell is
                    for (let lvl = 1; lvl <= 9; lvl++) {
                        if (spellList[lvl]?.includes(spell)) {
                            currentKnownSpells.push({ name: spell, level: lvl });
                            break;
                        }
                    }
                });
            }

            // Track selected spells
            window.knownCasterSpellsToLearn = [];
            window.knownCasterNumToLearn = numSpells;
            window.knownCasterSpellToSwapOut = null;
            window.knownCasterSpellToSwapIn = null;

            const className = character.class.charAt(0).toUpperCase() + character.class.slice(1);

            const modal = document.createElement('div');
            modal.id = 'knownCasterLearnModal';
            modal.className = 'spell-modal active';
            modal.innerHTML = `
                <div class="spell-modal-content" style="max-width: 800px;">
                    <div class="spell-modal-header">
                        <div class="spell-modal-title">LEARN NEW SPELLS</div>
                    </div>
                    <div style="margin-bottom: 10px; color: #c4a574; font-size: 0.45rem;">
                        As a ${className}, select ${numSpells} new spell${numSpells > 1 ? 's' : ''} to learn:
                        <span id="knownCasterLearnCount" style="color: #daa520;">(0/${numSpells} selected)</span>
                    </div>

                    <!-- Spell Swap Section -->
                    <div style="background: #2d1b0e; border: 2px solid #6a1b9a; padding: 10px; margin-bottom: 15px;">
                        <div style="color: #9c27b0; font-size: 0.4rem; margin-bottom: 8px;">
                            OPTIONAL: Swap one known spell for another (same level or lower)
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <select id="swapOutSpell" onchange="updateSwapOptions()" style="flex: 1; min-width: 150px; padding: 8px; font-family: inherit; font-size: 0.35rem; background: #3d2817; color: #f4e4bc; border: 2px solid #5c3317;">
                                <option value="">-- Don't swap --</option>
                                ${currentKnownSpells.map(s => `<option value="${s.name}" data-level="${s.level}">${s.name} (Lvl ${s.level})</option>`).join('')}
                            </select>
                            <span style="color: #8b7355; font-size: 0.4rem;"></span>
                            <select id="swapInSpell" disabled style="flex: 1; min-width: 150px; padding: 8px; font-family: inherit; font-size: 0.35rem; background: #3d2817; color: #f4e4bc; border: 2px solid #5c3317;">
                                <option value="">-- Select spell to swap out first --</option>
                            </select>
                        </div>
                    </div>

                    <div style="color: #8b7355; font-size: 0.35rem; margin-bottom: 10px;">
                        Currently know ${currentKnownSpells.length} spells | Should know ${getSpellsKnownCount()} at level ${character.level}
                    </div>

                    <div class="item-list-scroll" style="max-height: 300px;" id="knownCasterLearnGrid">
                        ${buildKnownCasterLearnableSpellsHTML(learnableSpells)}
                    </div>

                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button onclick="confirmKnownCasterSpellLearning()" style="flex: 1; padding: 12px; background: #6a1b9a; border: 2px solid #9c27b0; color: #fff; font-family: inherit; font-size: 0.45rem; cursor: pointer;">
                            LEARN SPELLS
                        </button>
                        <button onclick="skipKnownCasterSpellLearning()" style="padding: 12px 20px; background: #5c3317; border: 2px solid #8b4513; color: #f4e4bc; font-family: inherit; font-size: 0.45rem; cursor: pointer;">
                            SKIP
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function buildKnownCasterLearnableSpellsHTML(spells) {
            // Group by level
            const byLevel = {};
            spells.forEach(spell => {
                if (!byLevel[spell.level]) byLevel[spell.level] = [];
                byLevel[spell.level].push(spell.name);
            });

            let html = '';
            for (let lvl = 1; lvl <= 9; lvl++) {
                const levelSpells = byLevel[lvl];
                if (levelSpells && levelSpells.length > 0) {
                    html += `
                        <div class="prep-level-group">
                            <div class="prep-level-title">LEVEL ${lvl} SPELLS</div>
                            ${levelSpells.sort().map(spell => `
                                <div class="prep-spell-item" data-spell="${spell.replace(/'/g, '&#39;')}" data-level="${lvl}"
                                     onclick="toggleKnownCasterLearnSpell(this, '${spell.replace(/'/g, "\\'")}')">
                                    ${spell}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }

            if (!html) {
                html = '<div style="color: #8b7355; font-size: 0.45rem; text-align: center;">No new spells available at your current level.</div>';
            }
            return html;
        }

        function toggleKnownCasterLearnSpell(element, spellName) {
            const idx = window.knownCasterSpellsToLearn.indexOf(spellName);

            if (idx >= 0) {
                window.knownCasterSpellsToLearn.splice(idx, 1);
                element.classList.remove('selected');
            } else if (window.knownCasterSpellsToLearn.length < window.knownCasterNumToLearn) {
                window.knownCasterSpellsToLearn.push(spellName);
                element.classList.add('selected');
            }

            document.getElementById('knownCasterLearnCount').textContent =
                `(${window.knownCasterSpellsToLearn.length}/${window.knownCasterNumToLearn} selected)`;
        }

        function updateSwapOptions() {
            const swapOutSelect = document.getElementById('swapOutSpell');
            const swapInSelect = document.getElementById('swapInSpell');
            const selectedOption = swapOutSelect.options[swapOutSelect.selectedIndex];

            if (!swapOutSelect.value) {
                swapInSelect.disabled = true;
                swapInSelect.innerHTML = '<option value="">-- Select spell to swap out first --</option>';
                window.knownCasterSpellToSwapOut = null;
                return;
            }

            window.knownCasterSpellToSwapOut = swapOutSelect.value;
            const swapLevel = parseInt(selectedOption.dataset.level);

            // Get learnable spells at this level or lower
            const cls = character.class?.toLowerCase();
            const spellList = CLASS_SPELL_LISTS[cls] || {};
            const currentKnown = [];
            for (let i = 1; i <= 9; i++) {
                currentKnown.push(...(character.spells?.[`level${i}`] || []));
            }

            let options = '<option value="">-- Select replacement --</option>';
            for (let lvl = 1; lvl <= swapLevel; lvl++) {
                const spellsAtLevel = spellList[lvl] || [];
                spellsAtLevel.forEach(spell => {
                    if (!currentKnown.includes(spell) && spell !== window.knownCasterSpellToSwapOut) {
                        options += `<option value="${spell}" data-level="${lvl}">${spell} (Lvl ${lvl})</option>`;
                    }
                });
            }

            swapInSelect.innerHTML = options;
            swapInSelect.disabled = false;
        }

        function confirmKnownCasterSpellLearning() {
            const swapInSelect = document.getElementById('swapInSpell');

            // Handle swap first
            if (window.knownCasterSpellToSwapOut && swapInSelect.value) {
                const swapOut = window.knownCasterSpellToSwapOut;
                const swapIn = swapInSelect.value;
                const swapInLevel = parseInt(swapInSelect.options[swapInSelect.selectedIndex].dataset.level);

                // Remove old spell
                for (let i = 1; i <= 9; i++) {
                    const levelSpells = character.spells?.[`level${i}`] || [];
                    const idx = levelSpells.indexOf(swapOut);
                    if (idx >= 0) {
                        levelSpells.splice(idx, 1);
                        break;
                    }
                }

                // Add new spell at correct level
                if (!character.spells[`level${swapInLevel}`]) {
                    character.spells[`level${swapInLevel}`] = [];
                }
                character.spells[`level${swapInLevel}`].push(swapIn);

                alert(`Swapped "${swapOut}" for "${swapIn}"!`);
            }

            // Add newly learned spells
            if (window.knownCasterSpellsToLearn.length > 0) {
                const cls = character.class?.toLowerCase();
                const spellList = CLASS_SPELL_LISTS[cls] || {};

                window.knownCasterSpellsToLearn.forEach(spell => {
                    // Find spell level
                    for (let lvl = 1; lvl <= 9; lvl++) {
                        if (spellList[lvl]?.includes(spell)) {
                            if (!character.spells[`level${lvl}`]) {
                                character.spells[`level${lvl}`] = [];
                            }
                            if (!character.spells[`level${lvl}`].includes(spell)) {
                                character.spells[`level${lvl}`].push(spell);
                            }
                            break;
                        }
                    }
                });
            }

            // Save
            localStorage.setItem('dnd-active-character', JSON.stringify(character));

            const learnedCount = window.knownCasterSpellsToLearn.length;
            const modal = document.getElementById('knownCasterLearnModal');
            if (modal) modal.remove();

            if (learnedCount > 0) {
                alert(`Learned ${learnedCount} new spell${learnedCount > 1 ? 's' : ''}!`);
            }

            renderCharacterSheet();
        }

        function skipKnownCasterSpellLearning() {
            const modal = document.getElementById('knownCasterLearnModal');
            if (modal) modal.remove();
            renderCharacterSheet();
        }

        function showSubclassModal(alsoShowASI = false) {
            const classKey = character.class?.toLowerCase();
            const subclasses = CLASS_SUBCLASSES[classKey] || [];

            const modal = document.createElement('div');
            modal.id = 'subclassModal';
            modal.className = 'spell-modal active';
            modal.innerHTML = `
                <div class="spell-modal-content" style="max-width: 650px;">
                    <div class="spell-modal-header">
                        <div class="spell-modal-title">CHOOSE YOUR SUBCLASS</div>
                    </div>
                    <div style="margin-bottom: 15px; color: #c4a574; font-size: 0.45rem;">
                        Select your ${character.class} specialization:
                    </div>
                    <div class="item-list-scroll" style="max-height: 400px;">
                        ${subclasses.map(sub => `
                            <div class="item-option" onclick="selectSubclass('${sub.id}', ${alsoShowASI})" style="padding: 15px;">
                                <div style="color: #daa520; font-size: 0.5rem; margin-bottom: 5px;">${sub.name}</div>
                                <div style="color: #8b7355; font-size: 0.4rem;">${sub.desc}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function selectSubclass(subclassId, alsoShowASI) {
            character.subclass = subclassId;
            localStorage.setItem('dnd-active-character', JSON.stringify(character));

            // Close modal
            const modal = document.getElementById('subclassModal');
            if (modal) modal.remove();

            // Re-render to show new subclass
            renderCharacterSheet();

            // Get the subclass name for the message
            const classKey = character.class?.toLowerCase();
            const subclasses = CLASS_SUBCLASSES[classKey] || [];
            const selected = subclasses.find(s => s.id === subclassId);
            const subclassName = selected ? selected.name : subclassId;

            if (alsoShowASI) {
                alert(`You have chosen: ${subclassName}!\n\nNow choose your Ability Score Improvement or Feat.`);
                showASIModal();
            } else if (isWizard()) {
                alert(`You have chosen: ${subclassName}!\n\nNow choose 2 new spells for your spellbook.`);
                showWizardSpellLearning(2, true);
            } else if (isKnownCaster()) {
                // Check if this level grants new spells
                const newSpellsCount = window.levelUpNewSpellsCount || 0;
                if (newSpellsCount > 0) {
                    alert(`You have chosen: ${subclassName}!\n\nYou can learn ${newSpellsCount} new spell${newSpellsCount > 1 ? 's' : ''}.`);
                    showKnownCasterSpellLearning(newSpellsCount);
                } else {
                    alert(`You have chosen: ${subclassName}!`);
                }
            } else if (isPreparedCaster()) {
                alert(`You have chosen: ${subclassName}!\n\nAs a prepared caster, you can now prepare more spells.`);
                showSpellPreparation();
            } else {
                alert(`You have chosen: ${subclassName}!`);
            }
        }

        // ASI/Feat selection modal
        function showASIModal() {
            const modal = document.createElement('div');
            modal.id = 'asiModal';
            modal.className = 'spell-modal active';
            modal.innerHTML = `
                <div class="spell-modal-content" style="max-width: 600px;">
                    <div class="spell-modal-header">
                        <div class="spell-modal-title">ABILITY SCORE IMPROVEMENT</div>
                        <button class="spell-modal-close" onclick="closeASIModal()">&times;</button>
                    </div>
                    <div style="margin-bottom: 20px; color: #c4a574; font-size: 0.45rem;">
                        Choose to increase your ability scores OR take a feat:
                    </div>
                    <div id="asiOptions">
                        <div style="margin-bottom: 20px;">
                            <div style="color: #daa520; font-size: 0.5rem; margin-bottom: 10px;">OPTION 1: Ability Score Improvement</div>
                            <div style="color: #c4a574; font-size: 0.4rem; margin-bottom: 15px;">
                                Increase one ability by 2, or two abilities by 1 each (max 20)
                            </div>
                            <div id="asiAbilitySelects" style="display: flex; flex-wrap: wrap; gap: 10px;">
                                ${['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'].map(ability => `
                                    <div style="background: #2d1b0e; border: 2px solid #5c3317; padding: 10px; text-align: center;">
                                        <div style="color: #8b7355; font-size: 0.4rem;">${ability}</div>
                                        <div style="color: #f4e4bc; font-size: 0.5rem; margin: 5px 0;">${character.abilities?.[ability] || 10}</div>
                                        <div style="display: flex; gap: 5px; justify-content: center;">
                                            <button class="asi-btn" onclick="adjustASI('${ability}', 1)" style="background: #2e7d32; border: 2px solid #4caf50; color: #fff; padding: 5px 10px; cursor: pointer; font-family: inherit; font-size: 0.4rem;">+1</button>
                                            <button class="asi-btn" onclick="adjustASI('${ability}', 2)" style="background: #1565c0; border: 2px solid #42a5f5; color: #fff; padding: 5px 10px; cursor: pointer; font-family: inherit; font-size: 0.4rem;">+2</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div id="asiPointsRemaining" style="color: #daa520; font-size: 0.45rem; margin-top: 10px;">
                                Points remaining: <span id="asiPoints">2</span>
                            </div>
                        </div>
                        <div style="border-top: 2px solid #5c3317; padding-top: 15px; margin-top: 15px;">
                            <div style="color: #9370db; font-size: 0.5rem; margin-bottom: 10px;">OPTION 2: Take a Feat</div>
                            <div style="color: #c4a574; font-size: 0.4rem; margin-bottom: 10px;">
                                Select a feat (feats must be tracked manually - note your choice):
                            </div>
                            <select id="featSelect" style="width: 100%; padding: 10px; font-family: inherit; font-size: 0.4rem; background: #2d1b0e; color: #f4e4bc; border: 2px solid #5c3317;">
                                <option value="">-- Select a Feat --</option>
                                <option value="Alert">Alert</option>
                                <option value="Athlete">Athlete</option>
                                <option value="Actor">Actor</option>
                                <option value="Charger">Charger</option>
                                <option value="Crossbow Expert">Crossbow Expert</option>
                                <option value="Defensive Duelist">Defensive Duelist</option>
                                <option value="Dual Wielder">Dual Wielder</option>
                                <option value="Dungeon Delver">Dungeon Delver</option>
                                <option value="Durable">Durable</option>
                                <option value="Elemental Adept">Elemental Adept</option>
                                <option value="Fey Touched">Fey Touched</option>
                                <option value="Grappler">Grappler</option>
                                <option value="Great Weapon Master">Great Weapon Master</option>
                                <option value="Healer">Healer</option>
                                <option value="Heavily Armored">Heavily Armored</option>
                                <option value="Heavy Armor Master">Heavy Armor Master</option>
                                <option value="Inspiring Leader">Inspiring Leader</option>
                                <option value="Keen Mind">Keen Mind</option>
                                <option value="Lightly Armored">Lightly Armored</option>
                                <option value="Linguist">Linguist</option>
                                <option value="Lucky">Lucky</option>
                                <option value="Mage Slayer">Mage Slayer</option>
                                <option value="Magic Initiate">Magic Initiate</option>
                                <option value="Martial Adept">Martial Adept</option>
                                <option value="Medium Armor Master">Medium Armor Master</option>
                                <option value="Mobile">Mobile</option>
                                <option value="Moderately Armored">Moderately Armored</option>
                                <option value="Mounted Combatant">Mounted Combatant</option>
                                <option value="Observant">Observant</option>
                                <option value="Polearm Master">Polearm Master</option>
                                <option value="Resilient">Resilient</option>
                                <option value="Ritual Caster">Ritual Caster</option>
                                <option value="Savage Attacker">Savage Attacker</option>
                                <option value="Sentinel">Sentinel</option>
                                <option value="Shadow Touched">Shadow Touched</option>
                                <option value="Sharpshooter">Sharpshooter</option>
                                <option value="Shield Master">Shield Master</option>
                                <option value="Skilled">Skilled</option>
                                <option value="Skulker">Skulker</option>
                                <option value="Spell Sniper">Spell Sniper</option>
                                <option value="Tavern Brawler">Tavern Brawler</option>
                                <option value="Tough">Tough</option>
                                <option value="War Caster">War Caster</option>
                                <option value="Weapon Master">Weapon Master</option>
                            </select>
                            <button onclick="confirmFeat()" style="margin-top: 10px; width: 100%; padding: 10px; background: #6a1b9a; border: 2px solid #9c27b0; color: #fff; font-family: inherit; font-size: 0.45rem; cursor: pointer;">
                                TAKE FEAT
                            </button>
                        </div>
                    </div>
                    <div style="margin-top: 20px; border-top: 2px solid #5c3317; padding-top: 15px;">
                        <button onclick="confirmASI()" style="width: 100%; padding: 12px; background: #2e7d32; border: 2px solid #4caf50; color: #fff; font-family: inherit; font-size: 0.5rem; cursor: pointer;">
                            CONFIRM ABILITY SCORE IMPROVEMENT
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Initialize ASI tracking
            window.asiChanges = {};
            window.asiPointsRemaining = 2;
        }

        function adjustASI(ability, amount) {
            const currentScore = character.abilities?.[ability] || 10;
            const currentChange = window.asiChanges[ability] || 0;
            const newScore = currentScore + currentChange + amount;

            // Check if we have enough points
            if (amount > window.asiPointsRemaining) {
                alert('Not enough points remaining!');
                return;
            }

            // Check max 20
            if (newScore > 20) {
                alert(`${ability} cannot exceed 20!`);
                return;
            }

            // Apply the change
            window.asiChanges[ability] = (window.asiChanges[ability] || 0) + amount;
            window.asiPointsRemaining -= amount;

            // Update display
            document.getElementById('asiPoints').textContent = window.asiPointsRemaining;

            // Update the ability display
            const abilityDivs = document.querySelectorAll('#asiAbilitySelects > div');
            abilityDivs.forEach(div => {
                const label = div.querySelector('div').textContent;
                if (label === ability) {
                    const valueDiv = div.querySelectorAll('div')[1];
                    const baseScore = character.abilities?.[ability] || 10;
                    const change = window.asiChanges[ability] || 0;
                    valueDiv.textContent = baseScore + change;
                    if (change > 0) {
                        valueDiv.style.color = '#4caf50';
                    }
                }
            });
        }

        function confirmASI() {
            if (window.asiPointsRemaining > 0) {
                if (!confirm(`You still have ${window.asiPointsRemaining} point(s) remaining. Are you sure you want to continue?`)) {
                    return;
                }
            }

            // Apply ASI changes
            for (const [ability, change] of Object.entries(window.asiChanges)) {
                if (!character.abilities) character.abilities = {};
                character.abilities[ability] = (character.abilities[ability] || 10) + change;
            }

            // Recalculate HP if CON changed
            if (window.asiChanges['CON']) {
                const newMaxHP = calculateMaxHP();
                gameState.currentHP = newMaxHP;
            }

            // Save and close
            localStorage.setItem('dnd-active-character', JSON.stringify(character));
            saveGameState();
            closeASIModal();
            renderCharacterSheet();

            if (isWizard()) {
                alert(`Ability scores updated!\n\nNow choose 2 new spells for your spellbook.`);
                showWizardSpellLearning(2, true);
            } else if (isKnownCaster()) {
                const newSpellsCount = window.levelUpNewSpellsCount || 0;
                if (newSpellsCount > 0) {
                    alert(`Ability scores updated!\n\nYou can learn ${newSpellsCount} new spell${newSpellsCount > 1 ? 's' : ''}.`);
                    showKnownCasterSpellLearning(newSpellsCount);
                } else {
                    alert('Ability scores updated!');
                }
            } else if (isPreparedCaster()) {
                alert(`Ability scores updated!\n\nAs a prepared caster, you can now prepare more spells.`);
                showSpellPreparation();
            } else {
                alert('Ability scores updated!');
            }
        }

        function confirmFeat() {
            const featSelect = document.getElementById('featSelect');
            const selectedFeat = featSelect.value;

            if (!selectedFeat) {
                alert('Please select a feat!');
                return;
            }

            // Add feat to character
            if (!character.feats) character.feats = [];
            character.feats.push(selectedFeat);

            // Save and close
            localStorage.setItem('dnd-active-character', JSON.stringify(character));
            saveGameState();
            closeASIModal();
            renderCharacterSheet();

            if (isWizard()) {
                alert(`You gained the ${selectedFeat} feat!\n\nNow choose 2 new spells for your spellbook.`);
                showWizardSpellLearning(2, true);
            } else if (isKnownCaster()) {
                const newSpellsCount = window.levelUpNewSpellsCount || 0;
                if (newSpellsCount > 0) {
                    alert(`You gained the ${selectedFeat} feat!\n\nYou can learn ${newSpellsCount} new spell${newSpellsCount > 1 ? 's' : ''}.`);
                    showKnownCasterSpellLearning(newSpellsCount);
                } else {
                    alert(`You gained the ${selectedFeat} feat!`);
                }
            } else if (isPreparedCaster()) {
                alert(`You gained the ${selectedFeat} feat!\n\nAs a prepared caster, you can now prepare more spells.`);
                showSpellPreparation();
            } else {
                alert(`You gained the ${selectedFeat} feat!`);
            }
        }

        function closeASIModal() {
            const modal = document.getElementById('asiModal');
            if (modal) modal.remove();
        }

        // Calculate max spell level based on class and level
        function getMaxSpellLevelForClass(cls, level) {
            const fullCasters = ['bard', 'cleric', 'druid', 'sorcerer', 'wizard'];
            const halfCasters = ['paladin', 'ranger'];

            // Check for subclass casters (1/3 casters)
            if (isSubclassCaster()) {
                // Eldritch Knight and Arcane Trickster progression
                if (level < 3) return 0;
                if (level >= 19) return 4;
                if (level >= 13) return 3;
                if (level >= 7) return 2;
                return 1;
            } else if (cls === 'warlock') {
                return Math.min(5, Math.ceil(level / 2));
            } else if (fullCasters.includes(cls)) {
                if (level >= 17) return 9;
                if (level >= 15) return 8;
                if (level >= 13) return 7;
                if (level >= 11) return 6;
                if (level >= 9) return 5;
                if (level >= 7) return 4;
                if (level >= 5) return 3;
                if (level >= 3) return 2;
                return 1;
            } else if (halfCasters.includes(cls)) {
                if (level < 2) return 0;
                if (level >= 17) return 5;
                if (level >= 13) return 4;
                if (level >= 9) return 3;
                if (level >= 5) return 2;
                return 1;
            }
            return 0;
        }

        function updateCurrency(type, value) {
            gameState.currency[type] = parseInt(value) || 0;
            saveGameState();
        }

        // ===== INVENTORY FUNCTIONS =====
        function addItemToInventory(itemName, save = true) {
            const dbItem = ITEM_DATABASE[itemName];
            const newItem = {
                id: Date.now() + Math.random(),
                name: itemName,
                type: dbItem?.type || 'gear',
                subtype: dbItem?.subtype || null,
                quantity: 1,
                equipped: false,
                description: dbItem?.description || '',
                damage: dbItem?.damage || null,
                properties: dbItem?.properties || null,
                ac: dbItem?.ac || null,
                effects: dbItem?.effects || null,
                rarity: dbItem?.rarity || null,
                attunement: dbItem?.attunement || false,
                consumable: dbItem?.consumable || false,
                custom: !dbItem
            };

            // Check if stackable item already exists
            if (newItem.consumable || newItem.type === 'ammo' || newItem.type === 'gear') {
                const existing = gameState.inventory.find(i => i.name === itemName && !i.equipped);
                if (existing) {
                    existing.quantity++;
                    if (save) saveGameState();
                    return;
                }
            }

            gameState.inventory.push(newItem);
            if (save) saveGameState();
        }

        function removeItem(index) {
            const item = gameState.inventory[index];
            if (item.quantity > 1) {
                item.quantity--;
            } else {
                gameState.inventory.splice(index, 1);
            }
            saveGameState();
            renderCharacterSheet();
        }

        function toggleEquipItem(index) {
            const item = gameState.inventory[index];
            item.equipped = !item.equipped;
            saveGameState();
            renderCharacterSheet();
        }

        function useConsumable(index) {
            const item = gameState.inventory[index];
            if (confirm(`Use ${item.name}?\n\n${item.description || 'No description'}`)) {
                if (item.name.includes('Healing')) {
                    // Auto-roll healing potions
                    let dice, bonus;
                    if (item.name.includes('Greater')) { dice = 4; bonus = 4; }
                    else if (item.name.includes('Superior')) { dice = 8; bonus = 8; }
                    else { dice = 2; bonus = 2; }

                    let total = bonus;
                    for (let i = 0; i < dice; i++) {
                        total += Math.floor(Math.random() * 4) + 1;
                    }
                    gameState.currentHP = Math.min(calculateMaxHP(), gameState.currentHP + total);
                    alert(`Healed for ${total} HP!`);
                }
                removeItem(index);
            }
        }

        function showItemDetails(index) {
            const item = gameState.inventory[index];
            let details = `${item.name}\n`;
            details += `Type: ${item.type}${item.subtype ? ' (' + item.subtype + ')' : ''}\n`;
            if (item.rarity) details += `Rarity: ${item.rarity}\n`;
            if (item.damage) details += `Damage: ${item.damage}\n`;
            if (item.properties) details += `Properties: ${item.properties}\n`;
            if (item.ac) details += `AC: ${item.ac}\n`;
            if (item.description) details += `\n${item.description}`;
            if (item.effects) {
                details += `\n\nEffects:`;
                for (const [key, val] of Object.entries(item.effects)) {
                    details += `\n  ${key}: ${val > 0 ? '+' : ''}${val}`;
                }
            }
            if (item.attunement) details += `\n\n(Requires attunement)`;
            alert(details);
        }

        function showAddItemModal() {
            const modal = document.createElement('div');
            modal.id = 'addItemModal';
            modal.className = 'item-modal active';

            const itemsByType = {};
            for (const [name, data] of Object.entries(ITEM_DATABASE)) {
                const type = data.type;
                if (!itemsByType[type]) itemsByType[type] = [];
                itemsByType[type].push({ name, ...data });
            }

            modal.innerHTML = `
                <div class="item-modal-content">
                    <div class="spell-modal-header">
                        <div class="spell-modal-title">ADD ITEM</div>
                        <button class="spell-modal-close" onclick="closeAddItemModal()">&times;</button>
                    </div>
                    <div class="item-tabs">
                        <button class="item-tab active" onclick="switchItemTab('standard')">STANDARD</button>
                        <button class="item-tab" onclick="switchItemTab('custom')">CUSTOM</button>
                    </div>
                    <div id="standardItemTab">
                        <div style="margin-bottom: 10px;">
                            <select id="itemTypeFilter" onchange="filterItems()" style="width: 100%; padding: 8px; font-family: inherit; font-size: 0.4rem; background: #2d1b0e; color: #f4e4bc; border: 2px solid #5c3317;">
                                <option value="all">All Types</option>
                                <option value="weapon">Weapons</option>
                                <option value="armor">Armor</option>
                                <option value="shield">Shields</option>
                                <option value="potion">Potions</option>
                                <option value="scroll">Scrolls</option>
                                <option value="wondrous">Wondrous Items</option>
                                <option value="gear">Adventuring Gear</option>
                                <option value="ammo">Ammunition</option>
                            </select>
                        </div>
                        <div class="item-list-scroll" id="itemList">
                            ${Object.entries(ITEM_DATABASE).map(([name, data]) => `
                                <div class="item-option" data-type="${data.type}" onclick="selectStandardItem('${name.replace(/'/g, "\\'")}')">
                                    <div class="${data.rarity ? 'rarity-' + data.rarity.replace(' ', '-') : ''}">${name}</div>
                                    <div style="font-size: 0.3rem; color: #8b7355;">${data.type}${data.damage ? ' - ' + data.damage : ''}${data.description ? ' - ' + data.description.substring(0, 50) + '...' : ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div id="customItemTab" style="display: none;">
                        <div class="custom-item-form">
                            <label>Item Name *</label>
                            <input type="text" id="customItemName" placeholder="Enter item name">

                            <label>Type</label>
                            <select id="customItemType">
                                <option value="weapon">Weapon</option>
                                <option value="armor">Armor</option>
                                <option value="shield">Shield</option>
                                <option value="wondrous">Wondrous Item</option>
                                <option value="potion">Potion</option>
                                <option value="scroll">Scroll</option>
                                <option value="gear">Gear</option>
                                <option value="custom">Other</option>
                            </select>

                            <label>Rarity</label>
                            <select id="customItemRarity">
                                <option value="">Common</option>
                                <option value="uncommon">Uncommon</option>
                                <option value="rare">Rare</option>
                                <option value="very rare">Very Rare</option>
                                <option value="legendary">Legendary</option>
                            </select>

                            <label>Description</label>
                            <textarea id="customItemDesc" placeholder="Describe the item and its properties..."></textarea>

                            <label>Stat Modifiers (optional)</label>
                            <div class="effect-row">
                                <select id="effectType1">
                                    <option value="">None</option>
                                    <option value="acBonus">AC Bonus</option>
                                    <option value="attackBonus">Attack Bonus</option>
                                    <option value="damageBonus">Damage Bonus</option>
                                    <option value="saveBonus">Save Bonus</option>
                                    <option value="setSTR">Set STR</option>
                                    <option value="setDEX">Set DEX</option>
                                    <option value="setCON">Set CON</option>
                                    <option value="setINT">Set INT</option>
                                    <option value="setWIS">Set WIS</option>
                                    <option value="setCHA">Set CHA</option>
                                    <option value="bonusSTR">Bonus STR</option>
                                    <option value="bonusDEX">Bonus DEX</option>
                                    <option value="bonusCON">Bonus CON</option>
                                    <option value="bonusINT">Bonus INT</option>
                                    <option value="bonusWIS">Bonus WIS</option>
                                    <option value="bonusCHA">Bonus CHA</option>
                                </select>
                                <input type="number" id="effectValue1" placeholder="Value" style="width: 60px;">
                            </div>
                            <div class="effect-row">
                                <select id="effectType2">
                                    <option value="">None</option>
                                    <option value="acBonus">AC Bonus</option>
                                    <option value="attackBonus">Attack Bonus</option>
                                    <option value="damageBonus">Damage Bonus</option>
                                    <option value="saveBonus">Save Bonus</option>
                                    <option value="setSTR">Set STR</option>
                                    <option value="setDEX">Set DEX</option>
                                    <option value="setCON">Set CON</option>
                                    <option value="setINT">Set INT</option>
                                    <option value="setWIS">Set WIS</option>
                                    <option value="setCHA">Set CHA</option>
                                    <option value="bonusSTR">Bonus STR</option>
                                    <option value="bonusDEX">Bonus DEX</option>
                                    <option value="bonusCON">Bonus CON</option>
                                    <option value="bonusINT">Bonus INT</option>
                                    <option value="bonusWIS">Bonus WIS</option>
                                    <option value="bonusCHA">Bonus CHA</option>
                                </select>
                                <input type="number" id="effectValue2" placeholder="Value" style="width: 60px;">
                            </div>

                            <div style="display: flex; gap: 10px; margin-top: 5px;">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="customRequiresAttunement"> Requires Attunement
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="customConsumable"> Consumable
                                </label>
                            </div>

                            <button onclick="addCustomItem()" style="margin-top: 15px; padding: 12px; background: #2e7d32; border: 2px solid #4caf50; color: #fff; font-family: inherit; font-size: 0.45rem; cursor: pointer;">
                                ADD CUSTOM ITEM
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeAddItemModal() {
            const modal = document.getElementById('addItemModal');
            if (modal) modal.remove();
        }

        function switchItemTab(tab) {
            document.querySelectorAll('.item-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('standardItemTab').style.display = tab === 'standard' ? 'block' : 'none';
            document.getElementById('customItemTab').style.display = tab === 'custom' ? 'block' : 'none';
        }

        function filterItems() {
            const filter = document.getElementById('itemTypeFilter').value;
            document.querySelectorAll('.item-option').forEach(opt => {
                if (filter === 'all' || opt.dataset.type === filter) {
                    opt.style.display = 'block';
                } else {
                    opt.style.display = 'none';
                }
            });
        }

        function selectStandardItem(name) {
            addItemToInventory(name);
            closeAddItemModal();
            renderCharacterSheet();
            alert(`Added ${name} to inventory!`);
        }

        function addCustomItem() {
            const name = document.getElementById('customItemName').value.trim();
            if (!name) {
                alert('Please enter an item name!');
                return;
            }

            const effects = {};
            const type1 = document.getElementById('effectType1').value;
            const val1 = parseInt(document.getElementById('effectValue1').value);
            if (type1 && !isNaN(val1)) effects[type1] = val1;

            const type2 = document.getElementById('effectType2').value;
            const val2 = parseInt(document.getElementById('effectValue2').value);
            if (type2 && !isNaN(val2)) effects[type2] = val2;

            const newItem = {
                id: Date.now() + Math.random(),
                name: name,
                type: document.getElementById('customItemType').value,
                quantity: 1,
                equipped: false,
                description: document.getElementById('customItemDesc').value,
                rarity: document.getElementById('customItemRarity').value || null,
                attunement: document.getElementById('customRequiresAttunement').checked,
                consumable: document.getElementById('customConsumable').checked,
                effects: Object.keys(effects).length > 0 ? effects : null,
                custom: true
            };

            gameState.inventory.push(newItem);
            saveGameState();
            closeAddItemModal();
            renderCharacterSheet();
            alert(`Added ${name} to inventory!`);
        }

        // Get total equipment bonuses for a stat
        function getEquipmentBonus(bonusType) {
            let total = 0;
            if (!gameState.inventory) return 0;

            gameState.inventory.forEach(item => {
                if (item.equipped && item.effects && item.effects[bonusType]) {
                    total += item.effects[bonusType];
                }
            });
            return total;
        }

        // Get equipment-modified ability score
        function getEffectiveAbilityScore(ability) {
            let score = character.abilities?.[ability] || 10;

            if (!gameState.inventory) return score;

            gameState.inventory.forEach(item => {
                if (item.equipped && item.effects) {
                    // Check for "set" effects (like Amulet of Health)
                    if (item.effects['set' + ability] && item.effects['set' + ability] > score) {
                        score = item.effects['set' + ability];
                    }
                    // Check for bonus effects
                    if (item.effects['bonus' + ability]) {
                        score += item.effects['bonus' + ability];
                    }
                }
            });

            return Math.min(30, score); // Cap at 30
        }

        // ===== TABS =====
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(tabName));
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === tabName + 'Tab');
            });
        }
    </script>
</body>
</html>
